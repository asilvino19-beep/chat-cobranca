<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>QuatroC • Portal de Negociação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: 0 18px 50px rgba(2,6,23,.10);
      --red:#d0121b;
      --red2:#b70f17;
      --chip:#f1f5f9;
      --focus: rgba(208,18,27,.18);
      --radius:18px;
      --radius2:14px;
      --max: 920px;
      --maxCard: 560px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 14px;
    }

    /* Shell */
    .shell{
      width:100%;
      max-width: var(--max);
    }

    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:22px 18px 10px;
      gap:12px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      width:100%;
    }

    .brand img{
      height:72px;           /* ✅ maior, sem exagero */
      width:auto;
      display:block;
      object-fit:contain;
    }

    .content{
      padding: 10px 18px 0;
      display:flex;
      justify-content:center;
    }

    .card{
      width:100%;
      max-width: var(--maxCard);
      padding: 26px 22px 18px;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: #fff;
    }

    .title{
      text-align:center;
      font-size: 28px;
      line-height:1.15;
      margin: 0 0 8px;
      font-weight:800;
      letter-spacing: -0.02em;
    }

    .subtitle{
      text-align:center;
      margin:0 0 18px;
      color: var(--muted);
      font-size: 15px; /* ✅ menor */
      line-height:1.45;
    }

    .formRow{
      margin-top: 14px;
    }

    label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 13px;
      margin-bottom:8px;
    }

    input{
      width:100%;
      height:56px;
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 0 16px;
      font-size: 16px;
      outline:none;
      background:#fff;
    }
    input:focus{
      border-color: var(--red);
      box-shadow: 0 0 0 4px var(--focus);
    }

    .btn{
      width:100%;
      height:56px;
      border:0;
      border-radius: 16px;
      background: var(--red);
      color:#fff;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease;
      margin-top:16px;
    }
    .btn:hover{ background: var(--red2); transform: translateY(-1px); }
    .btn:disabled{ opacity:.55; cursor:default; transform:none; }

    .btnGhost{
      height:56px;
      padding:0 18px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      color: var(--text);
      font-weight:800;
      cursor:pointer;
    }
    .btnGhost:hover{ border-color:#cbd5e1; transform: translateY(-1px); }

    .btnRow{
      display:flex;
      justify-content:center; /* ✅ centraliza */
      gap:12px;
      flex-wrap:wrap;
      margin-top:16px;
    }
    .btnRow .btn, .btnRow .btnGhost{ width: auto; min-width: 220px; }

    .linkRow{
      margin-top:12px;
      text-align:center;
      color: var(--muted);
      font-size: 13px;
    }
    .linkRow a{
      color: var(--red);
      text-decoration: none;
      font-weight: 700;
      cursor:pointer;
    }
    .linkRow a:hover{ text-decoration: underline; }

    /* Loading */
    .loading{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding: 24px 0 6px;
      gap:12px;
      text-align:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius: 999px;
      background: var(--chip);
      color: var(--text);
      font-weight:800;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--red);
      box-shadow: 0 0 0 4px var(--focus);
      animation: pulse 1.2s infinite ease-in-out;
    }
    @keyframes pulse{
      0%{ transform: scale(1); opacity:1}
      50%{ transform: scale(.75); opacity:.6}
      100%{ transform: scale(1); opacity:1}
    }

    /* Result text blocks */
    .block{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 16px;
      background: #fff;
    }
    .block p{
      margin: 0 0 10px;
      line-height:1.5;
    }
    .block p:last-child{ margin:0; }

    /* Back */
    .back{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-weight:700;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
    }
    .back:hover{ color: #334155; }
    .backWrap{
      max-width: var(--maxCard);
      margin: 0 auto;
      padding: 0 22px 6px;
    }

    /* Debt cards */
    .debtGrid{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:14px;
    }
    .debtCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px 14px 12px;
      background: #fff;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .debtTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .debtTitle{
      font-weight:900;
      letter-spacing:-.01em;
    }
    .miniLink{
      color: var(--red);
      font-weight:800;
      font-size: 13px;
      text-decoration:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .miniLink:hover{ text-decoration:underline; }
    .debtBody{
      color: #0f172a;
      font-size: 14px;
      line-height:1.45;
      white-space:pre-line;
    }

    /* Footer */
    .footer{
      padding: 18px 18px 22px;
      display:flex;
      justify-content:center;
    }
    .footerInner{
      width:100%;
      max-width: var(--maxCard);
      color: var(--muted);
      font-size: 14px;
      text-align:center;
      border-top: 1px solid var(--border);
      padding-top: 14px;
      line-height:1.5;
    }
    .footerInner a{
      color: var(--red);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
    }
    .footerInner a:hover{ text-decoration: underline; }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width: 640px;
      background:#fff;
      border-radius: 18px;
      border:1px solid var(--border);
      box-shadow: 0 25px 70px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom:1px solid var(--border);
      font-weight:900;
    }
    .modalClose{
      border:0;
      background:transparent;
      cursor:pointer;
      font-size: 18px;
      font-weight:900;
      color: #334155;
    }
    .modalBody{
      padding: 14px 16px 16px;
      color:#0f172a;
      line-height:1.55;
      font-size: 14px;
    }
    .modalBody h3{ margin: 10px 0 6px; font-size: 15px; }
    .modalBody ul{ margin: 8px 0 0 18px; }
    .modalBody li{ margin: 6px 0; }
    .muted{ color: var(--muted); }

    @media (max-width: 560px){
      .brand img{ height:64px; }
      .title{ font-size: 24px; }
      .btnRow .btn, .btnRow .btnGhost{ min-width: 160px; width:100%; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="panel">

      <!-- Brand -->
      <div class="topbar">
        <div class="brand">
          <!-- ✅ Troque para a URL raw do GitHub (raw.githubusercontent.com) -->
          <img id="logoImg" src="https://raw.githubusercontent.com/SEU_USUARIO/SEU_REPO/main/Logo.png" alt="QuatroC" />
        </div>
      </div>

      <!-- Back (aparece a partir da tela 2) -->
      <div class="backWrap" id="backWrap" style="display:none;">
        <span class="back" id="btnBack">← Voltar</span>
      </div>

      <!-- Content -->
      <div class="content">
        <div class="card" id="screen"></div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <div class="footerInner">
          Conosco, seus dados são tratados de forma segura e sigilosa.
          Caso tenha dúvidas ou queira saber mais sobre, acesse nossos
          <a id="openTerms">Termos e Política</a>.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div class="modalHead">
        <span id="modalTitle">Termos e Política</span>
        <button class="modalClose" id="modalClose">✕</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script>
    // ================= CONFIGURAÇÃO =================
    const API_URL = "https://billowing-voice-6efd.asilvino19.workers.dev/";

    // ================= STATE =================
    let sessionId = Date.now().toString();
    let step = "inicio";
    let documento = null;

    // Dados de identidade
    let fullNameFromCRM = "";
    let shortNameFromCRM = "";

    // Dívidas (texto bruto do backend, para cards e modal)
    let debtTexts = [];     // array de blocos
    let lastBackendResponse = null;

    // ================= DOM =================
    const screen = document.getElementById("screen");
    const backWrap = document.getElementById("backWrap");
    const btnBack = document.getElementById("btnBack");

    const modalOverlay = document.getElementById("modalOverlay");
    const modalClose = document.getElementById("modalClose");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const openTerms = document.getElementById("openTerms");

    // ================= MODAL =================
    function openModal(title, html){
      modalTitle.textContent = title || "Detalhes";
      modalBody.innerHTML = html || "";
      modalOverlay.style.display = "flex";
    }
    function closeModal(){
      modalOverlay.style.display = "none";
    }
    modalClose.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e)=>{ if(e.target === modalOverlay) closeModal(); });

    openTerms.addEventListener("click", () => {
      openModal("Termos e Política • QuatroC", getTermsHTML());
    });

    // ================= HELPERS =================
    function setBackVisible(visible){
      backWrap.style.display = visible ? "block" : "none";
    }

    function sanitizeDigits(v){ return (v || "").replace(/\D/g, ""); }

    function maskCPF(v){
      v = sanitizeDigits(v).slice(0,11);
      v = v.replace(/^(\d{3})(\d)/, "$1.$2");
      v = v.replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
      v = v.replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3-$4");
      return v;
    }

    function maskCNPJ(v){
      v = sanitizeDigits(v).slice(0,14);
      v = v.replace(/^(\d{2})(\d)/, "$1.$2");
      v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
      v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3/$4");
      v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, "$1.$2.$3/$4-$5");
      return v;
    }

    function pickShortName(full){
      const parts = (full || "").trim().split(/\s+/).filter(Boolean);
      if(parts.length === 0) return "";
      if(parts.length === 1) return parts[0];
      // ✅ “resumir”: primeiro + segundo nome (conforme seu exemplo)
      return `${parts[0]} ${parts[1]}`;
    }

    function buildNameChallengeOptions(full){
      const parts = (full || "").trim().split(/\s+/).filter(Boolean);
      if(parts.length <= 1){
        const correct = parts[0] || "";
        const decoys = ["MARIA", "JOÃO", "ANA"].filter(n => n !== correct).slice(0,2);
        return [correct, ...decoys];
      }

      const correct = full.trim();
      const last = parts[parts.length - 1];
      const base = parts.slice(0, parts.length - 1).join(" ");

      const pool = ["SILVA","SANTOS","OLIVEIRA","SOUZA","COSTA","PEREIRA","ALMEIDA","LIMA"];
      const d1 = pool.find(x => x !== last) || "SILVA";
      const d2 = pool.find(x => x !== last && x !== d1) || "SANTOS";

      return [
        correct,
        `${base} ${d1}`,
        `${base} ${d2}`,
      ];
    }

    function parseDebtBlocksFromMessages(messages){
      // pega textos longos (resumo) e quebra em blocos por linhas em branco
      const joined = (messages || [])
        .map(m => (m && m.texto ? String(m.texto) : ""))
        .join("\n\n")
        .trim();

      if(!joined) return [];

      // “Como deseja prosseguir?” e textos de interface não entram como dívida
      const cleaned = joined
        .replace(/Como deseja prosseguir\?/gi, "")
        .replace(/Abaixo seguem informações sobre seu\(s\) débito\(s\):/gi, "")
        .trim();

      if(!cleaned) return [];

      return cleaned
        .split(/\n\s*\n/g)
        .map(t => t.trim())
        .filter(Boolean);
    }

    // ================= UI RENDERERS =================
    function renderScreen1(){
      setBackVisible(false);

      screen.innerHTML = `
        <h1 class="title">Acesse ao portal de negociação</h1>
        <p class="subtitle">Preencha o campo abaixo</p>

        <div class="formRow">
          <label>
            <span id="docLabel">Digite seu CPF:</span>
          </label>
          <input id="docInput" inputmode="numeric" placeholder="000.000.000-00" autocomplete="off" />
          <button class="btn" id="btnConfirmar">Confirmar</button>

          <div class="linkRow">
            É pessoa jurídica? <a id="toggleDoc">Entrar com CNPJ</a>
          </div>
        </div>
      `;

      const docInput = document.getElementById("docInput");
      const docLabel = document.getElementById("docLabel");
      const toggleDoc = document.getElementById("toggleDoc");
      const btnConfirmar = document.getElementById("btnConfirmar");

      let mode = "cpf"; // cpf | cnpj

      function applyMode(){
        if(mode === "cpf"){
          docLabel.textContent = "Digite seu CPF:";
          docInput.placeholder = "000.000.000-00";
          toggleDoc.textContent = "Entrar com CNPJ";
          docInput.value = maskCPF(docInput.value);
        }else{
          docLabel.textContent = "Digite seu CNPJ:";
          docInput.placeholder = "00.000.000/0000-00";
          toggleDoc.textContent = "Entrar com CPF";
          docInput.value = maskCNPJ(docInput.value);
        }
        docInput.focus();
      }

      docInput.addEventListener("input", () => {
        if(mode === "cpf") docInput.value = maskCPF(docInput.value);
        else docInput.value = maskCNPJ(docInput.value);
      });

      toggleDoc.addEventListener("click", (e) => {
        e.preventDefault();
        mode = (mode === "cpf") ? "cnpj" : "cpf";
        applyMode();
      });

      btnConfirmar.addEventListener("click", async () => {
        const digits = sanitizeDigits(docInput.value);
        if(mode === "cpf" && digits.length !== 11){
          openModal("Atenção", `<p>Informe um CPF válido (11 dígitos).</p>`);
          return;
        }
        if(mode === "cnpj" && digits.length !== 14){
          openModal("Atenção", `<p>Informe um CNPJ válido (14 dígitos).</p>`);
          return;
        }

        documento = digits;
        step = "consulta_divida";

        // Tela 2 (loading) e chama backend
        renderScreen2Loading();
        await sendToBackend({ sessionId, step: "consulta_divida", documento });
      });

      applyMode();
    }

    function renderScreen2Loading(){
      setBackVisible(true);

      screen.innerHTML = `
        <h1 class="title">Resultado da consulta</h1>
        <p class="subtitle">Estamos localizando as informações vinculadas ao documento informado.</p>

        <div class="loading">
          <div class="pill"><span class="dot"></span> Carregando...</div>
          <div class="muted">Aguarde um momento.</div>
        </div>
      `;
    }

    function renderScreen3ConfirmIdentity(){
      setBackVisible(true);

      screen.innerHTML = `
        <h1 class="title">Resultado da consulta</h1>

        <div class="block">
          <p>Localizamos o cadastro em nome de <strong>${escapeHtml(shortNameFromCRM)}</strong>.</p>
          <p>Estamos falando com essa pessoa?</p>
        </div>

        <div class="btnRow">
          <button class="btn" id="btnSim">Sim</button>
          <button class="btnGhost" id="btnNao">Não</button>
        </div>
      `;

      document.getElementById("btnSim").addEventListener("click", () => {
        // ✅ vai para a tela de double-check (não fica “na mesma tela”)
        renderScreen3bDoubleCheck();
      });

      document.getElementById("btnNao").addEventListener("click", () => {
        renderNotClient();
      });
    }

    function renderScreen3bDoubleCheck(){
      setBackVisible(true);

      const options = buildNameChallengeOptions(fullNameFromCRM);

      const title = (fullNameFromCRM.trim().split(/\s+/).filter(Boolean).length <= 1)
        ? "Para dar sequência, confirme o primeiro nome"
        : "Para dar sequência, confirme o nome completo";

      screen.innerHTML = `
        <h1 class="title">Validação de segurança</h1>
        <p class="subtitle">${title}</p>

        <div class="btnRow" id="nameOptions" style="margin-top:6px;"></div>
      `;

      const wrap = document.getElementById("nameOptions");

      options.forEach((opt) => {
        const b = document.createElement("button");
        b.className = "btnGhost";
        b.style.minWidth = "260px";
        b.textContent = opt;
        b.addEventListener("click", async () => {
          const isCorrect = (opt || "").trim().toUpperCase() === (fullNameFromCRM || "").trim().toUpperCase();
          if(!isCorrect){
            openModal("Não corresponde", `<p>Não foi possível validar as informações. Você pode realizar uma nova consulta.</p>`);
            renderNotClient();
            return;
          }
          // ✅ Validado -> tela de escolha de caminho
          renderScreen4ChoosePath();
        });
        wrap.appendChild(b);
      });
    }

    function renderScreen4ChoosePath(){
      setBackVisible(true);

      screen.innerHTML = `
        <h1 class="title">Como deseja prosseguir?</h1>
        <p class="subtitle">Selecione uma opção para continuar o atendimento.</p>

        <div class="btnRow">
          <button class="btnGhost" id="btnNegociar">Negociar pelo autoatendimento</button>
          <button class="btn" id="btnAtendente">Falar com um atendente</button>
        </div>
      `;

      document.getElementById("btnAtendente").addEventListener("click", async () => {
        // mantém o contrato atual do backend
        await sendToBackend({
          sessionId,
          step: "falar_atendente",
          documento,
          motivo: "negociação"
        });
      });

      document.getElementById("btnNegociar").addEventListener("click", () => {
        // Renderiza cards com base no último retorno do resumo (se já veio),
        // ou chama backend caso ainda não tenha a estrutura.
        // No seu fluxo atual, após identidade confirmada, você busca resumo via TechFy.
        // Então aqui: se ainda não temos dívidas, chamamos o backend para o passo atual.
        if(debtTexts.length){
          renderScreen5DebtCards();
        }else{
          // força backend no step atual para gerar resumo/next
          sendToBackend({ sessionId, step: "confirmar_identidade", documento, optionId: "identidade_sim" });
        }
      });
    }

    function renderScreen5DebtCards(){
      setBackVisible(true);

      // Se não há pendências (ou credor sem parcelas), tratamos como “sem pendência”
      if(!debtTexts.length){
        screen.innerHTML = `
          <h1 class="title">Resultado da consulta</h1>
          <p class="subtitle">Nenhuma pendência foi localizada para o documento informado.</p>

          <div class="btnRow">
            <button class="btnGhost" id="btnNova">Nova consulta</button>
          </div>
        `;
        document.getElementById("btnNova").addEventListener("click", resetAll);
        return;
      }

      const cards = debtTexts.map((t, idx) => {
        return `
          <div class="debtCard">
            <div class="debtTop">
              <div class="debtTitle">Pendência identificada</div>
              <a class="miniLink" data-idx="${idx}">Detalhes da dívida</a>
            </div>
            <div class="debtBody">${escapeHtml(t)}</div>
          </div>
        `;
      }).join("");

      screen.innerHTML = `
        <h1 class="title">Pendências localizadas</h1>
        <p class="subtitle">Selecione uma opção para prosseguir.</p>

        <div class="debtGrid">${cards}</div>

        <div class="btnRow">
          <button class="btnGhost" id="btnGerarBoleto">Negociar agora</button>
          <button class="btn" id="btnAtendente2">Falar com um atendente</button>
        </div>
      `;

      // Modal “Detalhes”
      screen.querySelectorAll(".miniLink").forEach(a => {
        a.addEventListener("click", () => {
          const idx = Number(a.getAttribute("data-idx"));
          const text = debtTexts[idx] || "";
          openModal("Detalhes da dívida", `<pre style="white-space:pre-wrap;margin:0;font-family:inherit;">${escapeHtml(text)}</pre>`);
        });
      });

      // Aqui você liga com sua lógica real de negociação:
      // - se já existe opção gerar boleto do backend, o seu fluxo segue
      // Como o backend já trabalha com optionId, mantemos isso:
      document.getElementById("btnAtendente2").addEventListener("click", async () => {
        await sendToBackend({
          sessionId,
          step: "falar_atendente",
          documento,
          motivo: "negociação"
        });
      });

      document.getElementById("btnGerarBoleto").addEventListener("click", async () => {
        // Se existir “gerar_boleto” no seu backend, ele segue.
        // Caso o seu backend use outro id, troque aqui.
        await sendToBackend({
          sessionId,
          step,
          documento,
          optionId: "gerar_boleto"
        });
      });
    }

    function renderNotClient(){
      setBackVisible(true);

      screen.innerHTML = `
        <h1 class="title">Resultado da consulta</h1>
        <p class="subtitle">Para proteger os dados, realize uma nova consulta com o documento correto.</p>

        <div class="btnRow">
          <button class="btnGhost" id="btnNova">Nova consulta</button>
        </div>
      `;

      document.getElementById("btnNova").addEventListener("click", resetAll);
    }

    function renderAtendenteMessage(link){
      setBackVisible(true);

      screen.innerHTML = `
        <h1 class="title">Atendimento humano</h1>
        <p class="subtitle">Para seguir com um atendente, utilize o canal abaixo.</p>

        <div class="block">
          <p><strong>Link de atendimento:</strong></p>
          <p><a href="${escapeAttr(link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link)}</a></p>
        </div>

        <div class="btnRow">
          <button class="btnGhost" id="btnNova">Nova consulta</button>
        </div>
      `;

      document.getElementById("btnNova").addEventListener("click", resetAll);
    }

    function resetAll(){
      sessionId = Date.now().toString();
      step = "inicio";
      documento = null;
      fullNameFromCRM = "";
      shortNameFromCRM = "";
      debtTexts = [];
      lastBackendResponse = null;
      renderScreen1();
    }

    btnBack.addEventListener("click", () => {
      // Voltar simples: se estiver em qualquer etapa após a consulta, volta para tela inicial
      resetAll();
    });

    // ================= BACKEND =================
    async function sendToBackend(payload) {
      try {
        lastBackendResponse = null;

        const resp = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) {
          openModal("Erro", `<p>Não foi possível processar sua solicitação. Tente novamente.</p>`);
          resetAll();
          return;
        }

        const data = await resp.json().catch(async () => {
          const txt = await resp.text();
          try { return JSON.parse(txt); } catch { return null; }
        });

        if(!data){
          openModal("Erro", `<p>Resposta inválida do servidor.</p>`);
          resetAll();
          return;
        }

        lastBackendResponse = data;

        // Atualiza step
        if (data.proximoStep !== undefined && data.proximoStep !== null) {
          step = data.proximoStep;
        }

        // Interpreta mensagens
        const msgs = (data.mensagens && Array.isArray(data.mensagens)) ? data.mensagens : [];

        // 1) Identidade (pega nome do retorno)
        // Procuramos um texto com "Localizamos o cadastro em nome de"
        const identityMsg = msgs.map(m => m.texto || "").find(t => /Localizamos o cadastro em nome de/i.test(t));
        if(identityMsg){
          const m = identityMsg.match(/Localizamos o cadastro em nome de\s+(.+?)[\.\n]/i);
          fullNameFromCRM = (m && m[1]) ? String(m[1]).trim() : "";
          shortNameFromCRM = pickShortName(fullNameFromCRM);
          // ✅ Agora que localizou, mostra tela 3 (confirmação)
          renderScreen3ConfirmIdentity();
          return;
        }

        // 2) Se backend devolveu texto de “falar atendente” com link, mostramos mensagem simples.
        const maybeLink = msgs.map(m => m.texto || "").find(t => /https?:\/\/\S+/i.test(t));
        if(step === "falar_atendente" && maybeLink){
          const url = (maybeLink.match(/https?:\/\/\S+/i) || [])[0] || "";
          renderAtendenteMessage(url || ""); // se vazio, ainda exibe
          return;
        }

        // 3) Resumo de dívidas: capturamos os blocos
        const parsedDebts = parseDebtBlocksFromMessages(msgs);
        if(parsedDebts.length){
          debtTexts = parsedDebts;

          // Se o backend está te jogando para etapa errada por causa de "digitação",
          // aqui garantimos a UI correta: escolhe caminho -> cards.
          // Se já escolheu "Negociar", renderiza direto:
          renderScreen5DebtCards();
          return;
        }

        // 4) Sem pendência / doc não localizado (mensagem genérica)
        const anyText = msgs.map(m => m.texto || "").join("\n").trim();
        if(anyText){
          // Se não veio dívida e não veio identidade, tratamos como “sem pendência” / “não localizado”
          screen.innerHTML = `
            <h1 class="title">Resultado da consulta</h1>
            <p class="subtitle">${escapeHtml(anyText)}</p>
            <div class="btnRow">
              <button class="btnGhost" id="btnNova">Nova consulta</button>
            </div>
          `;
          setBackVisible(true);
          document.getElementById("btnNova").addEventListener("click", resetAll);
          return;
        }

        // fallback
        renderNotClient();

      } catch (err) {
        openModal("Conexão", `<p>Não foi possível se conectar. Verifique sua internet e tente novamente.</p>`);
        resetAll();
      }
    }

    // ================= TERMS HTML =================
    function getTermsHTML(){
      return `
        <p><strong>Compromisso com segurança e sigilo</strong></p>
        <p>
          A QuatroC adota medidas técnicas e organizacionais para proteger os dados utilizados neste portal,
          com foco em confidencialidade, integridade e disponibilidade das informações.
        </p>

        <h3>1) Finalidade do portal</h3>
        <p>
          Este portal tem como finalidade viabilizar autoatendimento para consulta de pendências e direcionamento
          do atendimento, de forma objetiva e segura.
        </p>

        <h3>2) Dados tratados</h3>
        <ul>
          <li>Documento informado (CPF ou CNPJ);</li>
          <li>Informações de cadastro e dados necessários para atendimento (ex.: contatos e endereços quando aplicável);</li>
          <li>Informações sobre pendências/encaminhamentos vinculados ao documento consultado.</li>
        </ul>

        <h3>3) Sigilo e acesso</h3>
        <p>
          Para reduzir exposição indevida, o portal pode solicitar validações adicionais antes de exibir informações.
          Não compartilhe seu documento com terceiros.
        </p>

        <h3>4) Boas práticas</h3>
        <ul>
          <li>Utilize rede e dispositivo confiáveis;</li>
          <li>Evite acessar o portal em equipamentos públicos;</li>
          <li>Finalize o atendimento ao concluir sua consulta.</li>
        </ul>

        <h3>5) Atendimento humano</h3>
        <p>
          Caso prefira, você pode optar por seguir com atendimento humano pelos canais disponibilizados durante o fluxo.
        </p>

        <p class="muted" style="margin-top:12px;">
          Última atualização: ${new Date().toLocaleDateString("pt-BR")}
        </p>
      `;
    }

    // ================= ESCAPE =================
    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){
      return escapeHtml(str).replaceAll('"',"&quot;");
    }

    // ================= START =================
    function start(){
      renderScreen1();
    }
    start();
  </script>
</body>
</html>
