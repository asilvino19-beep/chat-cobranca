<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Portal de Negociação • QuatroC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --red:#d20f17;
      --red-700:#b90b12;
      --shadow: 0 18px 40px rgba(2,6,23,.08);
      --radius: 22px;
      --radius2: 16px;
      --maxw: 740px;
      --btnh: 56px;
      --font: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 700px at 50% 10%, #ffffff, var(--bg));
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    /* Shell */
    .shell{
      width:100%;
      max-width:var(--maxw);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    /* Top */
    .top{
      padding:26px 26px 12px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:14px;
    }
    .logo{
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .logo img{
      height:72px; /* (ajuste solicitado: um pouco maior, sem exagero) */
      width:auto;
      display:block;
    }

    /* Body */
    .body{
      padding:0 26px 18px;
    }

    .hero{
      padding:14px 0 12px;
      text-align:center;
    }
    .hero h1{
      margin:0;
      font-size:32px;
      letter-spacing:-.4px;
    }
    .hero p{
      margin:8px auto 0;
      max-width:520px;
      color:var(--muted);
      font-size:15px;
      line-height:1.55;
    }

    .divider{
      height:1px;
      background:var(--border);
      margin:16px 0;
    }

    /* Card inside */
    .panel{
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius2);
      padding:18px;
    }

    .fieldLabelRow{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      margin:6px 0 8px;
    }

    label{
      font-size:14px;
      color:#0f172a;
      font-weight:600;
    }

    .inputWrap{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:6px;
    }

    input{
      width:100%;
      height:56px;
      border-radius:14px;
      border:1px solid var(--border);
      outline:none;
      padding:0 16px;
      font-size:18px;
      letter-spacing:.6px;
      background:#fff;
      color:#0f172a;
    }
    input:focus{
      border-color:#cbd5e1;
      box-shadow:0 0 0 4px rgba(148,163,184,.22);
    }

    .primaryBtn{
      width:100%;
      height:var(--btnh);
      border:none;
      border-radius:16px;
      background:linear-gradient(180deg, var(--red), var(--red-700));
      color:#fff;
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      transition:transform .06s ease, filter .12s ease;
      margin-top:16px;
    }
    .primaryBtn:hover{ filter:brightness(1.02); transform:translateY(-1px); }
    .primaryBtn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .linkRow{
      margin-top:10px;
      font-size:14px;
      color:var(--muted);
      text-align:center;
    }
    .linkRow a{
      color:var(--red);
      text-decoration:none;
      font-weight:700;
      cursor:pointer;
    }
    .linkRow a:hover{ text-decoration:underline; }

    /* Result screen */
    .backRow{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:14px;
      padding:6px 0 0;
    }
    .backRow button{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:14px;
      cursor:pointer;
      padding:6px 8px;
      border-radius:10px;
    }
    .backRow button:hover{
      background:#f8fafc;
      color:#0f172a;
    }

    .resultTitle{
      text-align:center;
      margin:16px 0 0;
    }
    .resultTitle h2{
      margin:0;
      font-size:32px;
      letter-spacing:-.4px;
    }

    .resultSub{
      margin:8px auto 0;
      max-width:520px;
      text-align:center;
      color:var(--muted);
      font-size:15px;
      line-height:1.55;
    }

    .messageBox{
      margin-top:16px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      font-size:16px;
      line-height:1.55;
      white-space:pre-line;
    }
    .messageBox strong{ font-weight:800; }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center; /* ✅ centraliza botões */
      margin-top:14px;
    }
    .btn{
      min-width:160px;
      height:52px;
      padding:0 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      color:#0f172a;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      transition:transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ background:#f8fafc; transform:translateY(-1px); }
    .btn.primary{
      border:none;
      background:linear-gradient(180deg, var(--red), var(--red-700));
      color:#fff;
    }
    .btn.primary:hover{ filter:brightness(1.02); }

    /* Loader */
    .loaderWrap{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:18px 12px;
      border:1px dashed #cbd5e1;
      border-radius:18px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      color:#0f172a;
      font-weight:800;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:var(--red);
      animation:pulse 1s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{ transform:scale(.9); opacity:.65; }
      50%{ transform:scale(1.15); opacity:1; }
    }

    /* Footer */
    .footer{
      border-top:1px solid var(--border);
      padding:16px 22px;
      text-align:center;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      background:#fff;
    }
    .footer a{
      color:var(--red);
      text-decoration:none;
      font-weight:800;
    }
    .footer a:hover{ text-decoration:underline; }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    @media (max-width:520px){
      .logo img{ height:64px; }
      .hero h1, .resultTitle h2{ font-size:26px; }
      input{ font-size:17px; }
      .btn{ min-width:140px; }
      .body{ padding:0 16px 16px; }
      .top{ padding:22px 16px 10px; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <!-- TOPO -->
    <div class="top">
      <div class="logo" aria-label="QuatroC">
        <!-- Troque para a URL final do seu logo (GitHub Raw / Pages / CDN) -->
        <img id="brandLogo" src="https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/Logo.png" alt="QuatroC" />
      </div>
    </div>

    <div class="body">

      <!-- ===== VIEW 1: INÍCIO ===== -->
      <section id="viewStart" class="view active">
        <div class="hero">
          <h1 style="font-size:28px;">Acesse ao portal de negociação</h1>
          <p style="font-size:14px;">Preencha o campo abaixo</p>
        </div>

        <div class="panel">
          <div class="fieldLabelRow">
            <label id="docLabel" for="docInput">Digite seu CPF:</label>
          </div>

          <div class="inputWrap">
            <input
              id="docInput"
              type="text"
              inputmode="numeric"
              autocomplete="off"
              placeholder="000.000.000-00"
              aria-label="Documento"
            />
          </div>

          <button id="btnConfirm" class="primaryBtn">Confirmar</button>

          <div class="linkRow">
            É pessoa jurídica? <a id="toggleDocType" href="javascript:void(0)">Entrar com CNPJ</a>
          </div>
        </div>
      </section>

      <!-- ===== VIEW 2: RESULTADO / FLUXO POR BOTÕES ===== -->
      <section id="viewResult" class="view">
        <div class="backRow">
          <button id="btnBack" type="button">← Voltar</button>
        </div>

        <div class="resultTitle">
          <h2 id="resultH2">Resultado da consulta</h2>
        </div>

        <p id="resultSub" class="resultSub">
          <!-- texto dinâmico -->
        </p>

        <!-- Loading -->
        <div id="loadingBox" class="loaderWrap" style="display:none;">
          <div class="pill"><span class="dot"></span> Carregando…</div>
          <div>Aguarde um momento.</div>
        </div>

        <!-- Mensagem principal -->
        <div id="messageBox" class="messageBox" style="display:none;"></div>

        <!-- Ações (botões) -->
        <div id="actions" class="actions" style="display:none;"></div>

        <!-- Nova consulta (somente quando "Não") -->
        <div id="restartWrap" style="display:none; margin-top:14px; text-align:center;">
          <button id="btnRestart" class="btn" type="button">Nova consulta</button>
        </div>
      </section>

      <div class="divider"></div>

      <div class="footer">
        Conosco, seus dados são tratados de forma segura e sigilosa. Caso tenha dúvidas ou queira saber mais sobre, acesse nossos
        <a href="https://asilvino19-beep.github.io/TermoePolitica-Chat/" target="_blank" rel="noopener noreferrer">Termos e Política</a>.
      </div>
    </div>
  </div>

  <script>
    // ================= CONFIGURAÇÃO =================
    const API_URL = "https://billowing-voice-6efd.asilvino19.workers.dev/";

    // Views
    const viewStart  = document.getElementById("viewStart");
    const viewResult = document.getElementById("viewResult");

    // Start elements
    const docInput = document.getElementById("docInput");
    const docLabel = document.getElementById("docLabel");
    const toggleDocType = document.getElementById("toggleDocType");
    const btnConfirm = document.getElementById("btnConfirm");

    // Result elements
    const btnBack = document.getElementById("btnBack");
    const resultSub = document.getElementById("resultSub");
    const loadingBox = document.getElementById("loadingBox");
    const messageBox = document.getElementById("messageBox");
    const actions = document.getElementById("actions");
    const restartWrap = document.getElementById("restartWrap");
    const btnRestart = document.getElementById("btnRestart");

    // Estado
    let sessionId = Date.now().toString();
    let step = "inicio";
    let documento = null;

    // Controle CPF/CNPJ
    let docMode = "CPF"; // ou "CNPJ"
    const onlyDigits = (s) => (s || "").replace(/\D/g, "");

    function setDocMode(mode){
      docMode = mode;
      if (docMode === "CPF"){
        docLabel.textContent = "Digite seu CPF:";
        docInput.placeholder = "000.000.000-00";
        toggleDocType.textContent = "Entrar com CNPJ";
      } else {
        docLabel.textContent = "Digite seu CNPJ:";
        docInput.placeholder = "00.000.000/0000-00";
        toggleDocType.textContent = "Entrar com CPF";
      }
      // reformat
      docInput.value = formatDoc(onlyDigits(docInput.value));
    }

    toggleDocType.addEventListener("click", () => {
      setDocMode(docMode === "CPF" ? "CNPJ" : "CPF");
      docInput.focus();
    });

    function formatDoc(digits){
      if (docMode === "CPF"){
        digits = digits.slice(0, 11);
        // 000.000.000-00
        return digits
          .replace(/^(\d{3})(\d)/, "$1.$2")
          .replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3")
          .replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3-$4");
      } else {
        digits = digits.slice(0, 14);
        // 00.000.000/0000-00
        return digits
          .replace(/^(\d{2})(\d)/, "$1.$2")
          .replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3")
          .replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3/$4")
          .replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, "$1.$2.$3/$4-$5");
      }
    }

    docInput.addEventListener("input", () => {
      const digits = onlyDigits(docInput.value);
      docInput.value = formatDoc(digits);
    });

    // ✅ evita cursor “vazando”: só existe input na tela 1
    function switchView(to){
      if (to === "start"){
        viewStart.classList.add("active");
        viewResult.classList.remove("active");
        setTimeout(() => docInput.focus(), 50);
      } else {
        viewStart.classList.remove("active");
        viewResult.classList.add("active");
      }
    }

    function setLoading(isLoading){
      loadingBox.style.display = isLoading ? "flex" : "none";
      messageBox.style.display = isLoading ? "none" : (messageBox.textContent ? "block" : "none");
      actions.style.display = isLoading ? "none" : (actions.children.length ? "flex" : "none");
    }

    function clearResultUI(){
      messageBox.textContent = "";
      actions.innerHTML = "";
      restartWrap.style.display = "none";
      resultSub.textContent = "";
      messageBox.style.display = "none";
      actions.style.display = "none";
    }

    function showMessage(text){
      messageBox.textContent = text || "";
      messageBox.style.display = "block";
    }

    function showButtons(opcoes){
      actions.innerHTML = "";
      (opcoes || []).forEach(op => {
        const b = document.createElement("button");
        b.className = "btn" + (op.id === "identidade_sim" ? " primary" : "");
        b.type = "button";
        b.textContent = op.label || "Selecionar";
        b.onclick = () => handleOptionClick(op);
        actions.appendChild(b);
      });
      actions.style.display = opcoes?.length ? "flex" : "none";
    }

    function normalizeBackendMessages(response){
      // O backend pode devolver várias mensagens; aqui vamos consolidar
      // Em UX “portal”, vamos priorizar a última mensagem que tenha opcoes.
      const msgs = Array.isArray(response?.mensagens) ? response.mensagens : [];
      if (!msgs.length) return { texto:"", opcoes:[] };

      // Preferir a última mensagem com opcoes, senão a última mensagem
      let chosen = null;
      for (let i = msgs.length - 1; i >= 0; i--){
        if (Array.isArray(msgs[i].opcoes) && msgs[i].opcoes.length){
          chosen = msgs[i];
          break;
        }
      }
      if (!chosen) chosen = msgs[msgs.length - 1];

      // Se houver mensagens anteriores relevantes, podemos anexar como texto (sem poluir)
      // Aqui, concatenamos as mensagens que não são só "Como deseja prosseguir?"
      const textParts = [];
      msgs.forEach(m => {
        const t = (m?.texto || "").trim();
        if (!t) return;
        // evita repetir cabeçalhos muito genéricos
        if (t.toLowerCase() === "como deseja prosseguir?") return;
        if (t.toLowerCase() === "abaixo seguem informações sobre seu(s) débito(s):") return;
        textParts.push(t);
      });

      // Se ficou grande, mantém só as últimas 2
      const finalText = (textParts.length > 2)
        ? textParts.slice(-2).join("\n\n")
        : textParts.join("\n\n");

      return {
        texto: finalText || (chosen.texto || ""),
        opcoes: Array.isArray(chosen.opcoes) ? chosen.opcoes : []
      };
    }

    async function sendToBackend(payload) {
      try {
        btnConfirm.disabled = true;
        setLoading(true);

        const resp = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) {
          const t = await resp.text().catch(() => "");
          console.error("Erro HTTP", resp.status, t);
          setLoading(false);
          showMessage("Desculpe, ocorreu um erro ao processar sua solicitação.");
          return null;
        }

        const data = await resp.json().catch(async () => {
          const txt = await resp.text();
          try { return JSON.parse(txt); } catch { return null; }
        });

        return data;
      } catch (err) {
        console.error("Erro ao chamar backend", err);
        setLoading(false);
        showMessage("Não foi possível se conectar. Verifique sua conexão e tente novamente.");
        return null;
      } finally {
        btnConfirm.disabled = false;
      }
    }

    // ✅ REGRAS DE “Nova consulta”
    // Só pode aparecer quando o usuário clicar em "Não" na confirmação de identidade.
    let lastIdentityWasNo = false;

    function setRestartVisible(visible){
      restartWrap.style.display = visible ? "block" : "none";
    }

    btnRestart.addEventListener("click", () => {
      // reinicia sessão/estado
      sessionId = Date.now().toString();
      step = "inicio";
      documento = null;
      lastIdentityWasNo = false;
      clearResultUI();
      switchView("start");
      docInput.value = "";
      setDocMode("CPF");
    });

    btnBack.addEventListener("click", () => {
      // voltar para início sem “reset” total (mantém doc digitado, se quiser)
      switchView("start");
    });

    // ====== SUBMIT DOCUMENTO ======
    btnConfirm.addEventListener("click", async () => {
      const digits = onlyDigits(docInput.value);
      const required = (docMode === "CPF") ? 11 : 14;

      if (digits.length !== required){
        alert(docMode === "CPF"
          ? "Informe um CPF válido (11 dígitos)."
          : "Informe um CNPJ válido (14 dígitos)."
        );
        docInput.focus();
        return;
      }

      documento = digits;
      step = "consulta_divida";
      lastIdentityWasNo = false;

      clearResultUI();
      switchView("result");

      // ✅ durante consulta no CRM
      resultSub.textContent = "Estamos localizando as informações vinculadas ao documento informado.";
      setLoading(true);

      const response = await sendToBackend({ sessionId, step: "consulta_divida", documento });
      if (!response) return;

      handleBackendResponse(response);
    });

    function handleBackendResponse(response){
      clearResultUI();

      // Atualiza step (se vier)
      if (response.proximoStep !== undefined && response.proximoStep !== null){
        step = response.proximoStep;
      }

      // Texto do topo
      // - Enquanto pesquisando: já setamos antes de chamar
      // - Ao localizar: mostra “Resultado da consulta” (título fixo), e o texto vem do backend
      resultSub.textContent = "Resultado da consulta";

      // Monta texto e opções
      const { texto, opcoes } = normalizeBackendMessages(response);

      setLoading(false);

      if (texto){
        showMessage(texto);
      }

      // Se houver opções, mostrar botões centralizados
      if (opcoes && opcoes.length){
        showButtons(opcoes);
      }

      // ✅ “Nova consulta” só quando o usuário clicou “Não” na identidade
      setRestartVisible(lastIdentityWasNo === true);

      // Se o backend mandou “volta para consulta_divida” por “cliente não localizado”
      // não mostramos “Nova consulta” aqui, porque a regra é: só aparece quando respondeu “Não”
      // (mantemos conforme sua instrução).
    }

    // ====== CLIQUES (fluxo sem digitação) ======
    async function handleOptionClick(op){
      if (!op || !op.id) return;

      // Regra: se clicou "Não" na identidade -> habilita “Nova consulta”
      // (ajuste ao seu pedido)
      if (op.id === "identidade_nao"){
        lastIdentityWasNo = true;
      } else {
        // Se clicou em qualquer outra coisa depois, não exibe
        // (inclusive nome correto, prosseguir, etc.)
        lastIdentityWasNo = false;
      }

      // Mostra loading e chama backend sempre via optionId
      setLoading(true);

      // ✅ IMPORTANTÍSSIMO:
      // Para evitar cair em “Não consegui entender…”
      // nós NUNCA enviamos "message" digitado nesta UI.
      // Sempre enviamos: step + optionId + documento
      const payload = {
        sessionId,
        step,
        optionId: op.id,
        documento
      };

      const response = await sendToBackend(payload);
      if (!response) return;

      handleBackendResponse(response);
    }

    // init: foco no campo documento
    setDocMode("CPF");
    setTimeout(() => docInput.focus(), 80);
  </script>
</body>
</html>
