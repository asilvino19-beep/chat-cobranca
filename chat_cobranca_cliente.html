<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuatroC • Portal de Negociação</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#d71920;       /* Vermelho QuatroC */
      --brandDark:#b31218;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }

    .app{
      width: 100%;
      max-width: 520px;
    }

    .shell{
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(17,24,39,.04);
    }

    /* Header (minimalista) */
    .topbar{
      padding: 22px 22px 8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .logo{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      flex-direction: column;
    }
    .logo img{
      width: 88px;   /* ajuste pedido: um pouco maior, sem exageros */
      height: auto;
      display:block;
    }

    /* Tela */
    .screen{
      padding: 10px 26px 24px;
    }

    .title{
      margin: 6px 0 4px;
      font-size: 22px;
      line-height: 1.2;
      font-weight: 750;
      text-align:center;
      letter-spacing: -0.02em;
    }
    .subtitle{
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 13.5px;  /* ajuste pedido: um pouco menor */
      text-align:center;  /* centralizado */
    }

    .divider{ height:1px; background: var(--line); margin: 14px 0 18px; }

    /* Form */
    .fieldrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 6px;
    }
    .label{
      font-size: 13px;
      font-weight: 650;
      color: #111827;
    }

    .input{
      width:100%;
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px 14px;
      font-size: 18px;
      outline: none;
      background: #fff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .input:focus{
      border-color: rgba(215,25,32,.45);
      box-shadow: 0 0 0 4px rgba(215,25,32,.10);
    }

    .btn{
      width:100%;
      border: none;
      border-radius: 16px;
      padding: 16px 16px;
      font-size: 15px;
      font-weight: 750;
      cursor:pointer;
      margin-top: 14px;
      background: var(--brand);
      color:#fff;
      transition: transform .05s ease, background .15s ease, opacity .15s ease;
    }
    .btn:hover{ background: var(--brandDark); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .toggle{
      margin-top: 12px;
      text-align:center;
      font-size: 13px;
      color: var(--muted);
      user-select:none;
    }
    .toggle a{
      color: var(--brand);
      font-weight: 750;
      text-decoration:none;
      cursor:pointer;
    }
    .toggle a:hover{ text-decoration: underline; }

    .footer{
      padding: 16px 22px 20px;
      color: var(--muted);
      font-size: 12.5px;
      text-align:center;
      background: linear-gradient(to bottom, rgba(243,244,246,.0), rgba(243,244,246,.65));
      border-top: 1px solid rgba(229,231,235,.6);
    }
    .footer a{
      color: var(--brand);
      font-weight: 700;
      text-decoration:none;
    }
    .footer a:hover{ text-decoration: underline; }

    /* Tela 2: cards */
    .cards{
      display:flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }
    .card{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px 14px;
      background:#fff;
      text-align:left;
    }
    .card-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .pill{
      font-size: 11px;
      font-weight: 750;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(215,25,32,.10);
      color: var(--brand);
      white-space: nowrap;
    }
    .pill.gray{
      background: rgba(17,24,39,.06);
      color: #111827;
      font-weight: 700;
    }

    .card-title{
      font-size: 14px;
      font-weight: 780;
      margin: 0;
      line-height: 1.25;
    }
    .card-meta{
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.4;
    }

    .row-actions{
      display:flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .btn2{
      border-radius: 14px;
      padding: 11px 12px;
      font-size: 13px;
      font-weight: 750;
      border: 1px solid var(--line);
      cursor:pointer;
      background:#fff;
    }
    .btn2.primary{
      background: var(--brand);
      color:#fff;
      border-color: transparent;
    }
    .btn2.primary:hover{ background: var(--brandDark); }
    .btn2:hover{ border-color: rgba(17,24,39,.18); }

    .backlink{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 13px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      margin-bottom: 10px;
    }
    .backlink:hover{ color:#374151; }

    /* Modal Termos */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(17,24,39,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:100%;
      max-width: 720px;
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      overflow:hidden;
      border: 1px solid rgba(17,24,39,.08);
    }
    .modal-top{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }
    .modal-top strong{ font-size: 14px; }
    .modal-close{
      border:none;
      background: transparent;
      font-size: 18px;
      cursor:pointer;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .modal-close:hover{ background: rgba(17,24,39,.06); }
    .modal-body{
      padding: 16px;
      color:#111827;
      font-size: 13.5px;
      line-height: 1.65;
      max-height: 70vh;
      overflow:auto;
    }

    /* Responsivo */
    @media (max-width: 420px){
      .screen{ padding: 10px 18px 22px; }
      .title{ font-size: 20px; }
      .logo img{ width: 82px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="shell">
      <!-- Top -->
      <div class="topbar">
        <div class="logo">
          <img id="logoImg" alt="QuatroC" />
        </div>
      </div>

      <!-- SCREEN 1 -->
      <div id="screen1" class="screen">
        <div class="title">Acesse ao portal de negociação</div>
        <div class="subtitle">Preencha o campo abaixo</div>

        <div class="divider"></div>

        <div class="fieldrow">
          <div class="label" id="docLabel">Digite seu CPF:</div>
        </div>

        <input
          id="docInput"
          class="input"
          inputmode="numeric"
          autocomplete="off"
          placeholder="000.000.000-00"
        />

        <button id="btnConfirm" class="btn">Confirmar</button>

        <div class="toggle">
          <span id="toggleText">É pessoa jurídica?</span>
          <a id="toggleLink">Entrar com CNPJ</a>
        </div>
      </div>

      <!-- SCREEN 2 -->
      <div id="screen2" class="screen" style="display:none;">
        <div class="backlink" id="btnBack">← Voltar</div>

        <div class="title" id="resultTitle">Resultado da consulta</div>
        <div class="subtitle" id="resultSubtitle">
          Confira abaixo as informações localizadas para o documento informado.
        </div>

        <div id="resultArea"></div>
      </div>

      <!-- Footer -->
      <div class="footer">
        Conosco, seus dados são tratados de forma segura e sigilosa.
        Caso tenha dúvidas ou queira saber mais, acesse nossos
        <a id="openTerms">Termos e Política</a>.
      </div>
    </div>
  </div>

  <!-- Modal Termos -->
  <div id="termsOverlay" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-top">
        <strong>Termos e Política • QuatroC</strong>
        <button class="modal-close" id="closeTerms" aria-label="Fechar">✕</button>
      </div>
      <div class="modal-body" id="termsBody"></div>
    </div>
  </div>

  <script>
    // =================== CONFIG ===================
    const API_URL = "https://billowing-voice-6efd.asilvino19.workers.dev/"; // o seu
    const LOGO_URL = "https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/Logo.png"; // vou te explicar já já

    // Termos (HTML pronto — você pode ajustar o texto depois)
    const TERMOS_HTML = `
      <p><strong>1) Confidencialidade e uso de dados</strong><br/>
      A QuatroC trata as informações fornecidas neste portal de forma segura e sigilosa, com o objetivo de viabilizar o atendimento de negociação, regularização ou orientação relacionada a pendências vinculadas ao documento informado.</p>

      <p><strong>2) Finalidade do portal</strong><br/>
      Este portal disponibiliza informações e direcionamentos de autoatendimento quando aplicável. Em alguns cenários, o atendimento poderá ser concluído com suporte humano.</p>

      <p><strong>3) Segurança</strong><br/>
      Recomendamos que você não compartilhe suas credenciais, códigos de verificação ou informações sensíveis com terceiros. Caso identifique qualquer comportamento incomum, interrompa o atendimento e solicite suporte.</p>

      <p><strong>4) Atualização de informações</strong><br/>
      As informações exibidas podem sofrer atualização conforme registros e validações internas. Se houver divergência, você poderá solicitar revisão com um atendente.</p>

      <p><strong>5) Canais oficiais</strong><br/>
      Para continuidade do atendimento, utilize sempre os canais oficiais informados neste portal.</p>

      <p style="color:#6b7280;font-size:12.5px;margin-top:18px;">
      Última atualização: ${new Date().toLocaleDateString('pt-BR')}
      </p>
    `;

    // =================== STATE ===================
    let sessionId = Date.now().toString();
    let isCnpjMode = false; // false=CPF, true=CNPJ
    let documentoDigits = "";
    let lastBackendResponse = null;

    // =================== DOM ===================
    const screen1 = document.getElementById("screen1");
    const screen2 = document.getElementById("screen2");

    const logoImg = document.getElementById("logoImg");
    const docInput = document.getElementById("docInput");
    const docLabel = document.getElementById("docLabel");
    const btnConfirm = document.getElementById("btnConfirm");
    const toggleLink = document.getElementById("toggleLink");

    const btnBack = document.getElementById("btnBack");
    const resultArea = document.getElementById("resultArea");
    const resultTitle = document.getElementById("resultTitle");
    const resultSubtitle = document.getElementById("resultSubtitle");

    const termsOverlay = document.getElementById("termsOverlay");
    const openTerms = document.getElementById("openTerms");
    const closeTerms = document.getElementById("closeTerms");
    const termsBody = document.getElementById("termsBody");

    // =================== INIT ===================
    logoImg.src = LOGO_URL;
    termsBody.innerHTML = TERMOS_HTML;

    function showScreen(n){
      if(n === 1){
        screen1.style.display = "";
        screen2.style.display = "none";
        // foco travado no input (evita "tracinho" em áreas indevidas)
        setTimeout(()=> docInput.focus(), 50);
      }else{
        screen1.style.display = "none";
        screen2.style.display = "";
      }
    }

    // =================== MASKS ===================
    function onlyDigits(s){ return (s || "").replace(/\D/g, ""); }

    function maskCpf(d){
      // 000.000.000-00
      const p1 = d.slice(0,3);
      const p2 = d.slice(3,6);
      const p3 = d.slice(6,9);
      const p4 = d.slice(9,11);
      let out = p1;
      if(p2) out += "." + p2;
      if(p3) out += "." + p3;
      if(p4) out += "-" + p4;
      return out;
    }

    function maskCnpj(d){
      // 00.000.000/0000-00
      const p1 = d.slice(0,2);
      const p2 = d.slice(2,5);
      const p3 = d.slice(5,8);
      const p4 = d.slice(8,12);
      const p5 = d.slice(12,14);
      let out = p1;
      if(p2) out += "." + p2;
      if(p3) out += "." + p3;
      if(p4) out += "/" + p4;
      if(p5) out += "-" + p5;
      return out;
    }

    function applyMask(){
      const max = isCnpjMode ? 14 : 11;
      documentoDigits = documentoDigits.slice(0, max);

      docInput.value = isCnpjMode ? maskCnpj(documentoDigits) : maskCpf(documentoDigits);

      if(isCnpjMode){
        docLabel.textContent = "Digite seu CNPJ:";
        docInput.placeholder = "00.000.000/0000-00";
        toggleLink.textContent = "Entrar com CPF";
      }else{
        docLabel.textContent = "Digite seu CPF:";
        docInput.placeholder = "000.000.000-00";
        toggleLink.textContent = "Entrar com CNPJ";
      }

      btnConfirm.disabled = documentoDigits.length !== max;
    }

    // Captura digitação/colar e mantém só números
    docInput.addEventListener("input", (e)=>{
      documentoDigits = onlyDigits(e.target.value);
      applyMask();
    });

    // Toggle CPF/CNPJ
    toggleLink.addEventListener("click", ()=>{
      isCnpjMode = !isCnpjMode;
      // ao trocar, mantém o que der (corta/padroniza)
      documentoDigits = onlyDigits(docInput.value);
      applyMask();
      docInput.focus();
    });

    // =================== MODAL TERMOS ===================
    function openTermsModal(){
      termsOverlay.style.display = "flex";
    }
    function closeTermsModal(){
      termsOverlay.style.display = "none";
    }
    openTerms.addEventListener("click", openTermsModal);
    closeTerms.addEventListener("click", closeTermsModal);
    termsOverlay.addEventListener("click", (e)=>{
      if(e.target === termsOverlay) closeTermsModal();
    });

    // =================== BACKEND ===================
    async function sendToBackend(payload){
      btnConfirm.disabled = true;
      try{
        const resp = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        const txt = await resp.text();
        let data = null;
        try { data = JSON.parse(txt); } catch { data = null; }

        if(!resp.ok || !data){
          return { error: true, raw: txt };
        }
        return data;
      }catch(err){
        return { error: true, raw: String(err) };
      } finally {
        applyMask(); // re-habilita se estiver completo
      }
    }

    // =================== RENDER HELPERS ===================

    function renderEmptyState(title, desc){
      resultArea.innerHTML = `
        <div class="card" style="text-align:center;">
          <div class="card-head" style="justify-content:center;">
            <span class="pill gray">Consulta finalizada</span>
          </div>
          <p class="card-title" style="margin:0;">${escapeHtml(title)}</p>
          <p class="card-meta" style="margin-top:8px;">${escapeHtml(desc)}</p>
          <div class="row-actions" style="justify-content:center;margin-top:14px;">
            <button class="btn2 primary" id="btnNew">Nova consulta</button>
          </div>
        </div>
      `;
      document.getElementById("btnNew").onclick = ()=>{
        documentoDigits = "";
        applyMask();
        showScreen(1);
      };
    }

    function renderFallbackMensagens(mensagens){
      // Quando backend ainda manda modelo "chat", mostramos de forma limpa em cards
      const blocks = (mensagens || []).map(m=>{
        const text = (m.texto || "").trim();
        if(!text) return "";
        return `
          <div class="card">
            <p class="card-meta" style="margin:0;color:#111827;white-space:pre-line;">${escapeHtml(text)}</p>
          </div>
        `;
      }).join("");

      resultArea.innerHTML = `
        <div class="cards">
          ${blocks || ""}
          <div class="card">
            <div class="row-actions">
              <button class="btn2 primary" id="btnBackToStart">Nova consulta</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("btnBackToStart").onclick = ()=>{
        documentoDigits = "";
        applyMask();
        showScreen(1);
      };
    }

    function renderDebtsFromStructured(response){
      // Caso você evolua o backend para devolver um array "registros"/"pendencias"
      // Mantém compatibilidade: tenta encontrar estruturas comuns
      const root = response;
      const pendencias =
        root.pendencias ||
        root.registros ||
        root.contratos ||
        root.data ||
        null;

      if(!Array.isArray(pendencias) || !pendencias.length){
        return false;
      }

      const html = pendencias.map((p, idx)=>{
        const credor = p.Credor || p.credor || "Credor";
        const contrato = p.NumeroContrato || p.contrato || "—";
        const isIra = String(credor).toUpperCase().includes("SASCAR_IRA");

        return `
          <div class="card">
            <div class="card-head">
              <div>
                <p class="card-title">${escapeHtml(credor)}</p>
                <p class="card-meta">Contrato: ${escapeHtml(String(contrato))}</p>
              </div>
              <span class="pill">${isIra ? "Retirada (IRA)" : "Pendência"}</span>
            </div>

            <div class="row-actions">
              <button class="btn2 primary" data-action="details" data-index="${idx}">
                Ver detalhes
              </button>
            </div>
          </div>
        `;
      }).join("");

      resultArea.innerHTML = `<div class="cards">${html}</div>`;

      // bind
      [...resultArea.querySelectorAll('button[data-action="details"]')].forEach(btn=>{
        btn.onclick = ()=>{
          const i = Number(btn.getAttribute("data-index"));
          const item = pendencias[i];
          renderDetails(item);
        };
      });

      return true;
    }

    function renderDetails(item){
      const credor = item.Credor || item.credor || "";
      const contrato = item.NumeroContrato || item.contrato || "";
      const isIra = String(credor).toUpperCase().includes("SASCAR_IRA");

      // parcelas
      const parcelas = Array.isArray(item.parcelas) ? item.parcelas : [];
      const total = parcelas.reduce((acc,p)=> acc + (Number(p.Valor ?? p.valor ?? 0) || 0), 0);

      if(isIra){
        // refs IRA:
        // OS: IraOS
        // Placa: Numerododocumento
        // Data Emissão OS: Vencimento
        // (como Vencimento é por parcela, mostramos lista por OS)
        const linhas = parcelas.map(p=>{
          const os = p.IraOS || "—";
          const placa = p.Numerododocumento || item.Numerododocumento || "—";
          const dt = formatDate(p.Vencimento);
          return `<p class="card-meta" style="margin:6px 0 0;">
            <strong>OS:</strong> ${escapeHtml(String(os))}<br/>
            <strong>Placa:</strong> ${escapeHtml(String(placa))}<br/>
            <strong>Data de emissão:</strong> ${escapeHtml(dt)}
          </p>`;
        }).join("");

        resultArea.innerHTML = `
          <div class="cards">
            <div class="card">
              <div class="card-head">
                <div>
                  <p class="card-title">Pendência de retirada de equipamento</p>
                  <p class="card-meta">Credor: ${escapeHtml(String(credor))}<br/>Contrato: ${escapeHtml(String(contrato))}</p>
                </div>
                <span class="pill">SASCAR_IRA</span>
              </div>

              <p class="card-meta" style="margin-top:8px;">
                Para dar andamento à retirada do equipamento, precisamos confirmar algumas informações.
              </p>

              ${linhas || `<p class="card-meta" style="margin-top:8px;">Não foi possível detalhar as referências no momento.</p>`}

              <div class="row-actions" style="margin-top:14px;">
                <button class="btn2 primary" id="btnEndereco">Informar endereço e horários</button>
                <button class="btn2" id="btnAtendente">Falar com um atendente</button>
                <button class="btn2" id="btnVoltarLista">Voltar</button>
              </div>
            </div>
          </div>
        `;

        document.getElementById("btnVoltarLista").onclick = ()=> {
          // volta para lista (re-render usando a última resposta completa)
          handleResultRender(lastBackendResponse);
        };

        document.getElementById("btnAtendente").onclick = async ()=> {
          await sendToBackend({
            sessionId,
            step: "falar_atendente",
            documento: documentoDigits,
            motivo: "retirada_equipamento_ira"
          });
          renderEmptyState("Solicitação registrada", "Um atendente dará continuidade ao seu atendimento.");
        };

        document.getElementById("btnEndereco").onclick = ()=>{
          // sem backend novo: abrimos um mini-form local
          resultArea.innerHTML = `
            <div class="cards">
              <div class="card">
                <p class="card-title">Informe endereço e horários</p>
                <p class="card-meta">Preencha os dados abaixo para seguirmos com a tratativa.</p>

                <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px;">
                  <input id="addr" class="input" style="font-size:14px;padding:12px 12px;" placeholder="Endereço completo (rua, número, bairro, cidade/UF)" />
                  <input id="win" class="input" style="font-size:14px;padding:12px 12px;" placeholder="Melhores dias/horários para atendimento (ex: seg a sex, 9h-12h)" />
                </div>

                <div class="row-actions" style="margin-top:14px;">
                  <button class="btn2 primary" id="btnSendAddr">Enviar</button>
                  <button class="btn2" id="btnBackDet">Voltar</button>
                </div>
              </div>
            </div>
          `;

          document.getElementById("btnBackDet").onclick = ()=> renderDetails(item);

          document.getElementById("btnSendAddr").onclick = async ()=> {
            const endereco = (document.getElementById("addr").value || "").trim();
            const janela = (document.getElementById("win").value || "").trim();

            await sendToBackend({
              sessionId,
              step: "falar_atendente",
              documento: documentoDigits,
              motivo: "retirada_equipamento_ira",
              endereco,
              janela
            });

            renderEmptyState("Dados enviados", "Recebemos suas informações. Um atendente dará sequência ao agendamento.");
          };
        };

        return;
      }

      // Financeiro (padrão)
      const linhasParcelas = parcelas.map((p,idx)=>{
        const v = formatCurrency(p.Valor ?? p.valor ?? 0);
        const dt = formatDate(p.Vencimento);
        return `<p class="card-meta" style="margin:6px 0 0;">Parcela ${idx+1}: vencimento ${escapeHtml(dt)} • ${escapeHtml(v)}</p>`;
      }).join("");

      resultArea.innerHTML = `
        <div class="cards">
          <div class="card">
            <div class="card-head">
              <div>
                <p class="card-title">Detalhes da pendência</p>
                <p class="card-meta">Credor: ${escapeHtml(String(credor))}<br/>Contrato: ${escapeHtml(String(contrato))}</p>
              </div>
              <span class="pill">Financeiro</span>
            </div>

            <p class="card-meta" style="margin-top:8px;">
              <strong>Valor total em aberto:</strong> ${escapeHtml(formatCurrency(total))}
            </p>

            ${linhasParcelas ? `
              <div style="margin-top:10px;border-top:1px solid var(--line);padding-top:10px;">
                <p class="card-meta" style="margin:0;"><strong>Detalhamento</strong></p>
                ${linhasParcelas}
              </div>
            ` : `
              <p class="card-meta" style="margin-top:10px;">Sem parcelas em aberto.</p>
            `}

            <div class="row-actions" style="margin-top:14px;">
              <button class="btn2 primary" id="btnNegociar">Negociar agora</button>
              <button class="btn2" id="btnAtendente2">Falar com um atendente</button>
              <button class="btn2" id="btnVoltar2">Voltar</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("btnVoltar2").onclick = ()=> handleResultRender(lastBackendResponse);

      document.getElementById("btnAtendente2").onclick = async ()=> {
        await sendToBackend({
          sessionId,
          step: "falar_atendente",
          documento: documentoDigits,
          motivo: "negociacao"
        });
        renderEmptyState("Solicitação registrada", "Um atendente dará continuidade ao seu atendimento.");
      };

      document.getElementById("btnNegociar").onclick = async ()=> {
        // Mantém compatibilidade: se seu backend tem fluxo de negociar_auto, chamamos
        await sendToBackend({
          sessionId,
          step: "escolher_caminho",
          documento: documentoDigits,
          optionId: "negociar_auto"
        });
        renderEmptyState("Direcionamento realizado", "Siga as orientações apresentadas para concluir a negociação.");
      };
    }

    function handleResultRender(response){
      lastBackendResponse = response;

      // 1) Se vier erro
      if(response && response.error){
        renderEmptyState("Falha ao consultar", "Não foi possível concluir a consulta agora. Tente novamente.");
        return;
      }

      // 2) Se vier estrutura com pendências
      if(renderDebtsFromStructured(response)){
        return;
      }

      // 3) Fallback: usa mensagens do backend (modelo atual)
      const msgs = response && Array.isArray(response.mensagens) ? response.mensagens : null;
      if(msgs){
        renderFallbackMensagens(msgs);
        return;
      }

      // 4) Último fallback
      renderEmptyState("Consulta concluída", "Não foi possível interpretar a resposta. Faça uma nova consulta.");
    }

    // =================== ACTIONS ===================

    btnConfirm.addEventListener("click", async ()=>{
      const max = isCnpjMode ? 14 : 11;
      if(documentoDigits.length !== max) return;

      // Vai para tela 2 e mostra carregando
      showScreen(2);
      resultTitle.textContent = "Resultado da consulta";
      resultSubtitle.textContent = "Estamos localizando as informações vinculadas ao documento informado.";
      resultArea.innerHTML = `
        <div class="card" style="text-align:center;">
          <span class="pill gray">Carregando...</span>
          <p class="card-meta" style="margin-top:10px;">Aguarde um momento.</p>
        </div>
      `;

      const data = await sendToBackend({
        sessionId,
        step: "consulta_divida",
        documento: documentoDigits
      });

      // Se o backend retornar "cliente não localizado" / "sem dívida", o fallback de mensagens cobre.
      // Se você evoluir o backend para retornar um array, o portal vira card automaticamente.
      handleResultRender(data);
    });

    btnBack.addEventListener("click", ()=>{
      showScreen(1);
    });

    // Sanitização simples
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatCurrency(v){
      const n = Number(v) || 0;
      return n.toLocaleString("pt-BR",{ style:"currency", currency:"BRL" });
    }

    function formatDate(iso){
      if(!iso) return "sem data";
      const d = new Date(iso);
      if(isNaN(d.getTime())) return String(iso);
      return d.toLocaleDateString("pt-BR");
    }

    // Estado inicial
    documentoDigits = "";
    applyMask();
    showScreen(1);
  </script>
</body>
</html>
