<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal de Negociação - QuatroC</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e6eaf2;
      --shadow:0 18px 45px rgba(15,23,42,.08);
      --radius:22px;

      --brand:#c8102e;
      --brand2:#e11d48;
      --btnText:#ffffff;

      --btnOutlineBg:#ffffff;
      --btnOutlineText:var(--brand);
      --btnOutlineBorder:rgba(200,16,46,.28);

      --maxw:980px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f7f9ff 0%, var(--bg) 100%);
      color:var(--text);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .top{
      width:100%;
      padding:18px 20px 8px;
      display:flex;
      justify-content:center;
    }
    .logo{
      width:78px;
      height:auto;
      filter: drop-shadow(0 14px 28px rgba(15,23,42,.08));
    }

    .wrap{
      width:100%;
      max-width:var(--maxw);
      padding:8px 16px 20px;
    }

    .shell{
      background:var(--card);
      border-radius:24px;
      box-shadow:var(--shadow);
      border:1px solid var(--line);
      overflow:hidden;
    }

    .shellInner{
      padding:18px 18px 14px;
    }

    .backRow{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-weight:500;
      cursor:pointer;
      user-select:none;
      width:max-content;
      margin-bottom:10px;
    }
    .backRow:hover{opacity:.85}

    .panel{
      border:1px solid var(--line);
      border-radius:20px;
      padding:18px;
      background:#fff;
    }

    .title{
      text-align:center;
      font-size:44px;
      line-height:1.08;
      letter-spacing:-.02em;
      margin:14px 0 8px;
      font-weight:800;
      color:#0b1222;
    }
    .subtitle{
      text-align:center;
      margin:0 0 14px;
      color:var(--muted);
      font-size:18px;
      font-weight:500;
    }

    .centerText{ text-align:center; }

    .stack{
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
    }

    .segInline{
      display:inline-flex;
      gap:6px;
      background:#f7f8fc;
      border:1px solid var(--line);
      padding:5px;
      border-radius:999px;
    }
    .segInline button{
      border:0;
      background:transparent;
      padding:7px 11px;
      border-radius:999px;
      font-weight:900;
      color:var(--muted);
      cursor:pointer;
      font-size:12px;
      letter-spacing:.02em;
      line-height:1;
    }
    .segInline button.active{
      background:#fff;
      color:#111827;
      box-shadow:0 10px 18px rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.06);
    }

    .inputWrap{
      width:100%;
      max-width:620px;
      margin:0 auto;
      text-align:left;
    }

    .labelRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:8px 0 8px;
    }
    .labelRow .labelText{
      font-size:16px;
      font-weight:900;
      color:#111827;
    }

    .inputWrap input{
      width:100%;
      padding:14px 16px;
      font-size:18px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(15,23,42,.02);
    }
    .inputWrap input:focus{
      border-color:rgba(200,16,46,.35);
      box-shadow:0 0 0 4px rgba(200,16,46,.08);
    }

    .row{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      width:100%;
    }

    .btn{
      cursor:pointer;
      border-radius:999px;
      padding:14px 20px;
      font-weight:900;
      letter-spacing:.01em;
      font-size:16px;
      border:1px solid transparent;
      transition:.18s ease;
      min-width:200px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      user-select:none;
      line-height:1;
    }
    .btn.wide{min-width:480px; max-width:620px; width:100%;}
    .btn.outline{
      background:var(--btnOutlineBg);
      color:var(--btnOutlineText);
      border-color:var(--btnOutlineBorder);
    }
    .btn.outline:hover{
      background:rgba(200,16,46,.06);
      border-color:rgba(200,16,46,.38);
    }
    .btn.primary{
      background:linear-gradient(180deg, var(--brand2) 0%, var(--brand) 100%);
      color:var(--btnText);
      box-shadow:0 14px 26px rgba(200,16,46,.22);
    }
    .btn.primary:hover{transform:translateY(-1px)}
    .btn.primary:active{transform:translateY(0px); opacity:.98}

    .msgBox{
      width:100%;
      max-width:760px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 18px;
      background:#fff;
      color:#0f172a;
      font-size:19px;
      line-height:1.55;
    }
    .msgBox b{font-weight:900}

    .loadingWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      padding:14px 0 0;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 16px;
      border-radius:999px;
      background:#f2f4f8;
      font-weight:900;
      color:#0f172a;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--brand);
      box-shadow:0 0 0 6px rgba(200,16,46,.10);
    }
    .muted{color:var(--muted)}

    .foot{
      text-align:center;
      padding:14px 18px 10px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:16px;
      line-height:1.5;
    }
    .foot a{
      color:var(--brand);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
    }
    .foot a:hover{text-decoration:underline}

    .view{display:none}
    .view.active{display:block}

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .overlay.active{display:flex}
    .modal{
      width:min(760px, 94vw);
      max-height:min(78vh, 720px);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      box-shadow:0 30px 90px rgba(15,23,42,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
    }
    .modalHead h3{
      margin:0;
      font-size:18px;
      font-weight:900;
      color:#0b1222;
    }
    .x{
      border:0;
      background:transparent;
      font-size:24px;
      cursor:pointer;
      color:#0b1222;
      padding:6px 10px;
      border-radius:10px;
    }
    .x:hover{background:#f3f5f9}
    .modalBody{
      padding:16px;
      overflow:auto;
      color:#0f172a;
      line-height:1.65;
    }
    .modalBody h4{margin:14px 0 8px; font-size:16px}
    .modalBody ul{margin:8px 0 10px 18px}

    .offerWrap{
      width:100%;
      max-width:520px;
      margin:0 auto;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }
    .offerTop{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .offerTop .mini{
      color:var(--muted);
      font-weight:700;
      font-size:13px;
    }
    .offerTop a{
      color:var(--brand);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    .offerTop a:hover{text-decoration:underline}
    .offerBody{
      padding:14px 16px 16px;
    }
    .offerLine{
      margin:6px 0;
      color:#0b1222;
      font-weight:800;
      font-size:15px;
    }
    .offerBig{
      margin:10px 0 14px;
      font-size:26px;
      font-weight:950;
      letter-spacing:-.01em;
      color:#0b1222;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(200,16,46,.08);
      color:var(--brand);
      font-weight:900;
      font-size:12px;
      margin-left:8px;
    }
    .offerBtns{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .btn.small{min-width:0; width:100%; padding:14px 18px; font-size:16px}

    @media (max-width:640px){
      .title{font-size:34px}
      .subtitle{font-size:16px}
      .btn{min-width:160px}
      .btn.wide{min-width:0}
      .shellInner{padding:16px}
      .panel{padding:16px}
      .foot{font-size:15px}
      .labelRow{flex-direction:column; align-items:flex-start; gap:8px;}
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="top">
      <img class="logo" id="logoImg" alt="QuatroC" />
    </div>

    <div class="wrap">
      <div class="shell">
        <div class="shellInner">
          <div class="backRow" id="btnVoltar" style="visibility:hidden;">
            <span>←</span><span>Voltar</span>
          </div>

          <!-- VIEW: START -->
          <div class="view active" id="vStart">
            <div class="panel">
              <h1 class="title">Portal de negociação</h1>
              <p class="subtitle">Informe o documento para localizar o cadastro</p>

              <div class="inputWrap" style="margin-top:6px;">
                <div class="labelRow">
                  <div class="labelText">Digite:</div>
                  <div class="segInline" aria-label="Tipo de documento">
                    <button id="segCPF" class="active" type="button">CPF</button>
                    <button id="segCNPJ" type="button">CNPJ</button>
                  </div>
                </div>

                <input id="docInput" inputmode="numeric" autocomplete="off" placeholder="000.000.000-00" />

                <div class="row" style="margin-top:14px;">
                  <button class="btn primary wide" id="btnConsultar" type="button">Confirmar</button>
                </div>
              </div>
            </div>
          </div>

          <!-- VIEW: LOADING -->
          <div class="view" id="vLoading">
            <div class="panel">
              <p class="subtitle" style="margin-top:10px;">
                Estamos localizando as informações vinculadas ao documento informado.
              </p>

              <div class="loadingWrap">
                <div class="pill"><span class="dot"></span>Carregando...</div>
                <div class="muted" style="font-size:20px;font-weight:600;">Aguarde um momento.</div>
              </div>
            </div>
          </div>

          <!-- VIEW: RESULT -->
          <div class="view" id="vResult">
            <div class="panel">
              <h1 class="title" style="font-size:44px;">Resultado da consulta</h1>

              <div class="stack" style="margin-top:10px;">
                <div class="msgBox centerText" id="resultMsg"></div>

                <div class="row">
                  <button class="btn outline" id="btnSim" type="button">Sim</button>
                  <button class="btn outline" id="btnNao" type="button">Não</button>
                </div>
              </div>
            </div>
          </div>

          <!-- VIEW: VALIDATION -->
          <div class="view" id="vValidate">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">&nbsp;</h1>
              <p class="subtitle" style="margin-top:-18px;">
                Para darmos sequência, confirme o nome completo
              </p>

              <div class="stack" style="margin-top:8px;">
                <div class="msgBox centerText" style="max-width:640px;">
                  Selecione uma das opções abaixo:
                </div>

                <div class="stack" id="nameOptions" style="width:100%;"></div>
              </div>
            </div>
          </div>

          <!-- VIEW: WRONG NAME -->
          <div class="view" id="vWrongName">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">Não foi possível validar</h1>
              <p class="subtitle" id="wrongNameText">
                Para sua segurança, o nome selecionado não corresponde ao cadastro encontrado.
                Reinicie a consulta com o documento correto.
              </p>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnNovaConsulta1" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

          <!-- VIEW: ESCOLHER O QUE TRATAR (quando houver mais de uma ficha/credor) -->
          <div class="view" id="vChooseCase">
            <div class="panel">
              <h1 class="title" style="font-size:46px;">O que deseja tratar?</h1>
              <p class="subtitle">Selecione uma pendência para continuar.</p>

              <div class="stack" style="margin-top:8px; width:100%;">
                <div class="msgBox centerText" style="max-width:720px;">
                  Identificamos mais de uma pendência vinculada ao seu cadastro. Escolha abaixo para prosseguir.
                </div>

                <div class="stack" id="caseOptions" style="width:100%;"></div>
              </div>
            </div>
          </div>

          <!-- VIEW: NEXT (quando houver só uma ficha ou após escolher uma) -->
          <div class="view" id="vNext">
            <div class="panel">
              <h1 class="title" style="font-size:46px;">Como deseja prosseguir?</h1>
              <p class="subtitle">Selecione uma opção para continuar o atendimento.</p>

              <div class="row" style="margin-top:8px;">
                <button class="btn outline" id="btnAuto" type="button">Negociar pelo autoatendimento</button>
                <button class="btn outline" id="btnHumano" type="button">Falar com um atendente</button>
              </div>
            </div>
          </div>

          <!-- VIEW: OFFER -->
          <div class="view" id="vOffer">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">Minhas dívidas</h1>
              <p class="subtitle" style="margin-bottom:10px;">Negociações disponíveis:</p>

              <div class="offerWrap">
                <div class="offerTop">
                  <div>
                    <div class="mini" id="offerCredor">Credor</div>
                    <div class="mini" id="offerVenc">Vencimento</div>
                  </div>
                  <a id="openDebtDetails">Detalhes da dívida ↗</a>
                </div>

                <div class="offerBody">
                  <div class="offerLine">Valor atualizado</div>
                  <div class="offerBig" id="offerValor">R$ 0,00</div>

                  <div class="offerLine" style="margin-top:2px;">
                    Parcelado em <b id="offerParcelas">0x</b>
                    <span class="tag" id="offerTag">Oferta</span>
                  </div>

                  <div class="offerLine" style="font-weight:800; color:var(--muted);">
                    Total: <span id="offerTotal">R$ 0,00</span>
                  </div>

                  <div class="offerBtns">
                    <button class="btn primary small" id="btnQueroOferta" type="button">Quero essa oferta</button>
                    <button class="btn outline small" id="btnOutrasOfertas" type="button">Ver outras ofertas</button>
                  </div>
                </div>
              </div>

              <div class="muted centerText" style="margin-top:12px;font-size:14px;">
                (As condições reais serão carregadas do back. Aqui é o layout final do card.)
              </div>
            </div>
          </div>

          <!-- VIEW: NEW CONSULTA -->
          <div class="view" id="vNewConsulta">
            <div class="panel">
              <h1 class="title" style="font-size:46px;">Nova consulta</h1>
              <p class="subtitle">Para sua segurança, precisamos reiniciar a consulta com o documento correto.</p>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnNovaConsulta2" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

          <!-- VIEW: ERROR -->
          <div class="view" id="vError">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">Não foi possível concluir</h1>
              <p class="subtitle">
                Não foi possível se conectar. Verifique sua conexão e tente novamente.
              </p>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnNovaConsulta3" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

        </div>

        <div class="foot">
          Conosco, seus dados são tratados de forma segura e sigilosa.
          Caso tenha dúvidas ou queira saber mais, acesse nossos
          <a id="openTerms">Termos e Política</a>.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Termos e Política -->
  <div class="overlay" id="termsOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Termos e Política">
      <div class="modalHead">
        <h3>Termos e Política</h3>
        <button class="x" id="closeTerms" aria-label="Fechar">×</button>
      </div>
      <div class="modalBody">
        <h4>Compromisso com segurança e sigilo</h4>
        <p>
          A QuatroC adota medidas técnicas e organizacionais para proteger os dados utilizados neste portal,
          com foco em confidencialidade, integridade e disponibilidade das informações.
        </p>

        <h4>1) Finalidade do portal</h4>
        <p>
          Viabilizar autoatendimento para consulta de pendências e direcionamento do atendimento, de forma objetiva e segura.
        </p>

        <h4>2) Dados tratados</h4>
        <ul>
          <li>Documento informado (CPF ou CNPJ);</li>
          <li>Informações de cadastro necessárias para atendimento (quando aplicável);</li>
          <li>Informações sobre pendências/encaminhamentos vinculados ao documento consultado.</li>
        </ul>

        <h4>3) Sigilo e acesso</h4>
        <p>
          Para reduzir exposição indevida, o portal pode solicitar validações adicionais antes de exibir informações.
          Não compartilhe seu documento com terceiros.
        </p>

        <h4>4) Boas práticas</h4>
        <ul>
          <li>Utilize rede e dispositivo confiáveis;</li>
          <li>Evite acessar o portal em equipamentos públicos;</li>
          <li>Finalize o atendimento ao concluir sua consulta.</li>
        </ul>

        <h4>5) Atendimento humano</h4>
        <p>
          Caso prefira, você pode optar por seguir com atendimento humano pelos canais disponibilizados.
        </p>
      </div>
    </div>
  </div>

  <!-- MODAL: Detalhes da dívida -->
  <div class="overlay" id="debtOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Detalhes da dívida">
      <div class="modalHead">
        <h3>Detalhes da dívida</h3>
        <button class="x" id="closeDebt" aria-label="Fechar">×</button>
      </div>
      <div class="modalBody" id="debtBody"></div>
    </div>
  </div>

  <script>
    const LOGO_URL = "https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/Logo.png";

    // Links por projeto (definidos por credor)
    const CHAT_LINK_SASCAR = "https://lh.grupoasserth.com.br:7180/chat/ass-pu-sascar?theme=blue&pickup=y";
    const CHAT_LINK_IRA    = "https://lh.grupoasserth.com.br:7180/chat/ass-pu-ira?theme=blue&pickup=y";
    const CHAT_LINK_DEFAULT= "https://lh.grupoasserth.com.br:7180/chat/ass-pu-amil?theme=blue&pickup=y";

    const $ = (id) => document.getElementById(id);

    function onlyDigits(str){ return (str||"").replace(/\D/g,""); }
    function isCPF(d){ return d.length === 11; }
    function isCNPJ(d){ return d.length === 14; }

    function formatMoneyBR(value){
      const n = Number(value||0);
      return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
    }

    // Normaliza para comparar credor com segurança
    function norm(str){
      return (str||"")
        .toString()
        .toUpperCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ")
        .trim();
    }

    // Mapeamento credor -> chat
    function getChatLinkByCredor(credor){
      const c = norm(credor);
      // Sascar fixa (pode vir "SASCAR", "SASCAR FIXA", etc.)
      if (c.includes("SASCAR")) return CHAT_LINK_SASCAR;
      // Ira
      if (c.includes("IRA")) return CHAT_LINK_IRA;
      // Demais: Amil
      return CHAT_LINK_DEFAULT;
    }

    // Abre o chat (sem tela)
    function openChatForCredor(credor){
      const url = getChatLinkByCredor(credor);
      // abre em nova aba/janela (melhor UX, não perde o portal)
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function setActiveView(viewId){
      const views = document.querySelectorAll(".view");
      views.forEach(v => v.classList.remove("active"));
      $(viewId).classList.add("active");

      $("btnVoltar").style.visibility = (viewId === "vStart") ? "hidden" : "visible";
      currentView = viewId;
    }

    function openOverlay(overlayId){
      const el = $(overlayId);
      el.classList.add("active");
      el.setAttribute("aria-hidden", "false");
    }
    function closeOverlay(overlayId){
      const el = $(overlayId);
      el.classList.remove("active");
      el.setAttribute("aria-hidden", "true");
    }

    let currentView = "vStart";
    let docType = "CPF";
    let currentDoc = "";
    let foundRecord = null;

    // Caso selecionado quando o cliente tiver mais de uma ficha/credor
    let selectedCase = null;

    /*
      Modelo esperado do back:
      foundRecord.cases = [
        { credor: "SASCAR FIXA", debt:{...} },
        { credor: "IRA", debt:{...} },
        { credor: "AMIL", debt:{...} }
      ]

      Se vier só 1, cases tem 1 item.
    */
    function mockFetchCRM(documentDigits){
      const demoCPF = {
        type:"CPF",
        displayName:"ALEXANDRE VALENTE",
        fullName:"ALEXANDRE VALENTE LEAL",
        options:[
          "ALEXANDRE VALENTE LEAL",
          "ALEXANDRE VALENTE SILVA",
          "ALEXANDRE VALENTE SANTOS"
        ],
        // Exemplo com múltiplas fichas
        cases:[
          {
            credor:"SASCAR FIXA",
            debt:{
              credor:"SASCAR FIXA",
              contrato:"10024099300",
              vencimento:"21/02/2024",
              valorOriginal:1646.42,
              valorAtual:1666.42,
              oferta:{ parcelas:24, parcelaValor:10.06, descontoPct:85, total:241.44 },
              parcelasDetalhe:[ {parcela:1, venc:"21/02/2024", valor:1666.42} ]
            }
          },
          {
            credor:"IRA",
            debt:{
              credor:"IRA",
              contrato:"555001122",
              vencimento:"10/03/2024",
              valorOriginal:820.00,
              valorAtual:820.00,
              oferta:{ parcelas:6, parcelaValor:136.67, descontoPct:0, total:820.00 },
              parcelasDetalhe:[ {parcela:1, venc:"10/03/2024", valor:820.00} ]
            }
          },
          {
            credor:"AMIL",
            debt:{
              credor:"AMIL",
              contrato:"900112233",
              vencimento:"05/04/2024",
              valorOriginal:420.50,
              valorAtual:430.10,
              oferta:{ parcelas:10, parcelaValor:43.01, descontoPct:0, total:430.10 },
              parcelasDetalhe:[ {parcela:1, venc:"05/04/2024", valor:430.10} ]
            }
          }
        ]
      };

      const demoCNPJ = {
        type:"CNPJ",
        displayName:"N OLIVEIRA",
        fullName:"N OLIVEIRA COMÉRCIO LTDA",
        options:[
          "N OLIVEIRA",
          "N OLIVEIRA COMÉRCIO LTDA",
          "N OLIVEIRA SERVIÇOS"
        ],
        // Exemplo com uma ficha só
        cases:[
          {
            credor:"SASCAR FIXA",
            debt:{
              credor:"SASCAR FIXA",
              contrato:"205108950",
              vencimento:"18/09/2025",
              valorOriginal:31836.00,
              valorAtual:31836.00,
              oferta:{ parcelas:12, parcelaValor:2653.00, descontoPct:0, total:31836.00 },
              parcelasDetalhe:[ {parcela:1, venc:"18/09/2025", valor:31836.00} ]
            }
          }
        ]
      };

      if (isCNPJ(documentDigits)) return demoCNPJ;
      if (isCPF(documentDigits)) return demoCPF;
      return null;
    }

    function setDocType(type){
      docType = type;
      $("segCPF").classList.toggle("active", type==="CPF");
      $("segCNPJ").classList.toggle("active", type==="CNPJ");
      $("docInput").placeholder = (type==="CPF") ? "000.000.000-00" : "00.000.000/0000-00";
    }

    $("segCPF").addEventListener("click", () => setDocType("CPF"));
    $("segCNPJ").addEventListener("click", () => setDocType("CNPJ"));

    $("docInput").addEventListener("input", () => {
      const d = onlyDigits($("docInput").value);
      if (d.length >= 14) setDocType("CNPJ");
      else if (d.length <= 11) setDocType("CPF");
    });

    function goStart(){
      currentDoc = "";
      foundRecord = null;
      selectedCase = null;
      $("docInput").value = "";
      setDocType("CPF");
      setActiveView("vStart");
    }

    $("btnVoltar").addEventListener("click", () => {
      if (currentView === "vLoading") return goStart();
      if (currentView === "vResult") return goStart();
      if (currentView === "vValidate") return setActiveView("vResult");
      if (currentView === "vChooseCase") return setActiveView("vValidate");
      if (currentView === "vNext") {
        // se veio de múltiplos casos, volta para seleção; se foi único, volta para validação
        if (foundRecord?.cases?.length > 1) return setActiveView("vChooseCase");
        return setActiveView("vValidate");
      }
      if (currentView === "vOffer") return setActiveView("vNext");
      if (currentView === "vWrongName" || currentView === "vNewConsulta" || currentView === "vError") return goStart();
      return goStart();
    });

    $("btnNovaConsulta1").addEventListener("click", goStart);
    $("btnNovaConsulta2").addEventListener("click", goStart);
    $("btnNovaConsulta3").addEventListener("click", goStart);

    $("openTerms").addEventListener("click", (e) => { e.preventDefault(); openOverlay("termsOverlay"); });
    $("closeTerms").addEventListener("click", () => closeOverlay("termsOverlay"));
    $("termsOverlay").addEventListener("click", (e) => {
      if (e.target.id === "termsOverlay") closeOverlay("termsOverlay");
    });

    $("openDebtDetails").addEventListener("click", (e) => {
      e.preventDefault();
      if (!selectedCase?.debt) return;
      renderDebtDetails(selectedCase.debt);
      openOverlay("debtOverlay");
    });
    $("closeDebt").addEventListener("click", () => closeOverlay("debtOverlay"));
    $("debtOverlay").addEventListener("click", (e) => {
      if (e.target.id === "debtOverlay") closeOverlay("debtOverlay");
    });

    function renderDebtDetails(debt){
      const body = $("debtBody");
      const parcelasHtml = (debt.parcelasDetalhe||[]).map(p =>
        `<div style="padding:10px 0;border-top:1px solid var(--line);">
          <b>Parcela ${p.parcela}</b><br/>
          Vencimento: ${p.venc}<br/>
          Valor: ${formatMoneyBR(p.valor)}
        </div>`
      ).join("");

      body.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div><b>Contrato:</b> ${debt.contrato}</div>
          <div><b>Vencimento original:</b> ${debt.vencimento}</div>
          <div><b>Valor original:</b> ${formatMoneyBR(debt.valorOriginal)}</div>
          <div><b>Valor atualizado:</b> ${formatMoneyBR(debt.valorAtual)}</div>
          ${parcelasHtml ? `<div style="margin-top:6px;"><b>Parcelas</b>${parcelasHtml}</div>` : ""}
          <div style="margin-top:14px;">
            <button class="btn outline small" type="button" onclick="document.getElementById('closeDebt').click()">Voltar</button>
          </div>
        </div>
      `;
    }

    $("btnConsultar").addEventListener("click", () => {
      const digits = onlyDigits($("docInput").value);
      currentDoc = digits;

      if (!isCPF(digits) && !isCNPJ(digits)){
        setActiveView("vError");
        return;
      }

      setActiveView("vLoading");

      setTimeout(() => {
        foundRecord = mockFetchCRM(digits);

        if (!foundRecord){
          setActiveView("vNewConsulta");
          return;
        }

        const name = foundRecord.displayName;
        if (foundRecord.type === "CPF"){
          $("resultMsg").innerHTML =
            `Localizamos o cadastro em nome de <b>${name}</b>.<br/>Estamos falando com essa pessoa?`;
        } else {
          $("resultMsg").innerHTML =
            `Localizamos o cadastro da empresa <b>${name}</b>.<br/>Você é responsável por esta empresa?`;
        }

        setActiveView("vResult");
      }, 650);
    });

    $("btnNao").addEventListener("click", () => {
      setActiveView("vNewConsulta");
    });

    $("btnSim").addEventListener("click", () => {
      if (!foundRecord) return setActiveView("vError");
      renderNameOptions(foundRecord.options || [], foundRecord.fullName);
      setActiveView("vValidate");
    });

    function renderNameOptions(options, correct){
      const wrap = $("nameOptions");
      wrap.innerHTML = "";

      const container = document.createElement("div");
      container.style.width = "100%";
      container.style.maxWidth = "640px";
      container.style.display = "flex";
      container.style.flexDirection = "column";
      container.style.gap = "12px";

      options.forEach(opt => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "btn outline";
        b.style.width = "100%";
        b.style.minWidth = "0";
        b.textContent = opt;

        b.addEventListener("click", () => {
          if (opt === correct){
            // Após confirmar nome, se existir mais de uma ficha, escolher qual tratar.
            const cases = (foundRecord?.cases || []).filter(x => x && x.credor);
            if (cases.length > 1){
              renderCaseOptions(cases);
              setActiveView("vChooseCase");
            } else {
              // caso único
              selectedCase = cases[0] || null;
              setActiveView("vNext");
            }
          } else {
            $("wrongNameText").textContent =
              "Para sua segurança, o nome selecionado não corresponde ao cadastro encontrado. Reinicie a consulta com o documento correto.";
            setActiveView("vWrongName");
          }
        });

        container.appendChild(b);
      });

      wrap.appendChild(container);
    }

    // Renderiza botões de “qual pendência tratar”
    function renderCaseOptions(cases){
      const wrap = $("caseOptions");
      wrap.innerHTML = "";

      const container = document.createElement("div");
      container.style.width = "100%";
      container.style.maxWidth = "640px";
      container.style.display = "flex";
      container.style.flexDirection = "column";
      container.style.gap = "12px";

      // remove duplicados por credor (se back vier repetido)
      const seen = new Set();
      const unique = [];
      for (const c of cases){
        const key = norm(c.credor);
        if (!seen.has(key)){
          seen.add(key);
          unique.push(c);
        }
      }

      unique.forEach(c => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "btn outline";
        b.style.width = "100%";
        b.style.minWidth = "0";
        b.textContent = `Tratar pendência: ${c.credor}`;

        b.addEventListener("click", () => {
          selectedCase = c;
          setActiveView("vNext");
        });

        container.appendChild(b);
      });

      wrap.appendChild(container);
    }

    // Autoatendimento: usa o caso selecionado
    $("btnAuto").addEventListener("click", () => {
      if (!selectedCase?.debt){
        setActiveView("vError");
        return;
      }

      const debt = selectedCase.debt;
      $("offerCredor").textContent = debt.credor || (selectedCase.credor || "Credor");
      $("offerVenc").textContent = `Venceu em ${debt.vencimento || "--/--/----"}`;
      $("offerValor").textContent = formatMoneyBR(debt.valorAtual);

      const of = debt.oferta || {parcelas:0, parcelaValor:0, descontoPct:0, total:0};
      $("offerParcelas").textContent = `${of.parcelas}x ${formatMoneyBR(of.parcelaValor)}`;
      $("offerTotal").textContent = formatMoneyBR(of.total);
      $("offerTag").textContent = (of.descontoPct && of.descontoPct > 0) ? `${of.descontoPct}%` : "Oferta";

      setActiveView("vOffer");
    });

    // Atendimento humano: abre link direto conforme credor selecionado
    $("btnHumano").addEventListener("click", () => {
      if (!selectedCase?.credor){
        setActiveView("vError");
        return;
      }
      openChatForCredor(selectedCase.credor);
    });

    // “Quero essa oferta” / “Ver outras ofertas”
    // Aqui você decide: jogar para chat humano do caso selecionado.
    $("btnQueroOferta").addEventListener("click", () => {
      if (!selectedCase?.credor) return setActiveView("vError");
      openChatForCredor(selectedCase.credor);
    });
    $("btnOutrasOfertas").addEventListener("click", () => {
      if (!selectedCase?.credor) return setActiveView("vError");
      openChatForCredor(selectedCase.credor);
    });

    (function initLogo(){
      const img = $("logoImg");
      img.src = LOGO_URL;
      img.onerror = () => { img.style.display = "none"; };
    })();

    setDocType("CPF");
  </script>
</body>
</html>
