<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Portal de Negociação • QuatroC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg: #f3f5f8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --stroke: #e5e7eb;

      /* inspiração Acerto */
      --brand: #22c55e;
      --brandDark: #16a34a;
      --brandSoft: rgba(34,197,94,.10);

      --shadow: 0 16px 40px rgba(17,24,39,.10);
      --radius: 16px;
      --radius2: 12px;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display:flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    /* container geral */
    .app{
      width: 100%;
      max-width: 980px;
      min-height: min(92vh, 760px);
      background: transparent;
      display:flex;
      flex-direction: column;
      gap: 14px;
    }

    /* Top */
    .topbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 18px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex; align-items:center; gap: 12px;
      min-width: 0;
    }
    .brand .logo{
      font-weight: 900;
      color: var(--brandDark);
      letter-spacing: .4px;
      font-size: 20px;
      line-height: 1;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta{
      display:flex; align-items:center; gap: 10px; flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill{
      font-size: 12px;
      color: var(--muted);
      background: #f9fafb;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 6px 10px;
    }
    .link{
      color: var(--muted);
      font-size: 12px;
      text-decoration: none;
      border-bottom: 1px dotted #cbd5e1;
      cursor: pointer;
    }

    /* VIEWs */
    .view{
      display:none;
      flex:1;
    }
    .view.active{ display:block; }

    /* ======================
       VIEW 1 (ENTRADA)
       ====================== */
    .gridStart{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .cardHeader{
      padding: 16px 18px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .cardHeader h2{
      margin:0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .cardHeader p{
      margin: 0;
      color: var(--muted);
      font-size: 12px;
    }

    .cardBody{ padding: 18px; }

    .heroNote{
      background: #f9fafb;
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      padding: 12px 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }
    .heroNote strong{ color: var(--text); }

    .formRow{
      margin-top: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .labelRow{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .field{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #dbe3ee;
    }
    .field input{
      width: 100%;
      border: none;
      outline:none;
      font-size: 14px;
      color: var(--text);
    }

    .btnPrimary{
      width: 100%;
      border: none;
      cursor: pointer;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 14px;
      font-weight: 800;
      color: #ffffff;
      background: linear-gradient(180deg, var(--brand), var(--brandDark));
      box-shadow: 0 10px 18px rgba(34,197,94,.20);
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
    }
    .btnPrimary:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btnPrimary:disabled{ opacity: .55; cursor: default; transform:none; }

    /* feed de mensagens na tela 1 */
    .startFeed{
      margin-top: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .bubble{
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 13px;
      line-height: 1.5;
      border: 1px solid var(--stroke);
      background: #ffffff;
      white-space: pre-line;
    }
    .bubble.warn{
      border-color: rgba(239,68,68,.25);
      background: rgba(239,68,68,.06);
    }
    .bubble.muted{
      color: var(--muted);
      background: #f9fafb;
    }

    /* ======================
       VIEW 2 (PENDÊNCIAS)
       ====================== */
    .layoutDebts{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .statusBar{
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }

    .statusTitle{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .statusTitle .t1{
      font-weight: 800;
      font-size: 16px;
    }
    .statusTitle .t2{
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 0 18px 14px;
    }
    .tab{
      border: 1px solid var(--stroke);
      background: #f9fafb;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      user-select:none;
    }
    .tab.active{
      background: var(--brandSoft);
      border-color: rgba(34,197,94,.35);
      color: var(--brandDark);
      font-weight: 800;
    }

    .debtList{
      padding: 0 18px 18px;
      display:flex;
      flex-direction: column;
      gap: 14px;
    }

    .debtCard{
      border: 1px solid var(--stroke);
      background: #ffffff;
      border-radius: var(--radius);
      box-shadow: 0 10px 24px rgba(17,24,39,.06);
      overflow:hidden;
    }

    .debtCardTop{
      padding: 14px 16px;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--stroke);
      background: #ffffff;
    }

    .debtCredor{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width:0;
    }
    .debtCredor .c1{
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .debtCredor .c2{
      font-size: 12px;
      color: var(--muted);
    }

    .debtMeta{
      text-align: right;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .debtCardBody{
      padding: 14px 16px;
      background: rgba(34,197,94,.06);
      border-top: 1px solid rgba(34,197,94,.14);
    }

    .priceRow{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .priceLabel{
      color: var(--muted);
      font-size: 12px;
    }
    .priceValue{
      font-size: 22px;
      font-weight: 900;
      color: var(--text);
    }

    .debtDetails{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      white-space: pre-line;
      line-height: 1.5;
    }

    .actions{
      padding: 12px 16px 16px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      background: #ffffff;
    }

    .btnGreen{
      border:none;
      cursor:pointer;
      border-radius: 10px;
      padding: 12px 14px;
      font-weight: 900;
      font-size: 13px;
      color:#ffffff;
      background: linear-gradient(180deg, var(--brand), var(--brandDark));
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
    }
    .btnGreen:hover{ transform: translateY(-1px); filter: brightness(1.02); }

    .btnOutline{
      border: 1px solid #cbd5e1;
      background: #ffffff;
      cursor:pointer;
      border-radius: 10px;
      padding: 12px 14px;
      font-weight: 800;
      font-size: 13px;
      color: #111827;
      transition: transform .08s ease, background .15s ease;
    }
    .btnOutline:hover{ transform: translateY(-1px); background: #f9fafb; }

    /* fallback chat (sempre disponível) */
    .chatBox{
      margin-top: 8px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: #ffffff;
      overflow:hidden;
    }
    .chatHeader{
      padding: 12px 16px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: #f9fafb;
    }
    .chatHeader strong{
      font-size: 13px;
    }
    .chatHeader span{
      font-size: 12px;
      color: var(--muted);
    }

    .chatMessages{
      max-height: 280px;
      overflow-y:auto;
      padding: 12px 12px 6px;
      background: #ffffff;
      scroll-behavior: smooth;
    }
    .msg{
      max-width: 86%;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.45;
      margin-bottom: 8px;
      white-space: pre-line;
      border: 1px solid var(--stroke);
    }
    .msg-bot{
      background: #ffffff;
      color: var(--text);
      border-bottom-left-radius: 6px;
    }
    .msg-user{
      background: #111827;
      color: #ffffff;
      border-color: rgba(17,24,39,.22);
      border-bottom-right-radius: 6px;
      margin-left: auto;
    }

    .options{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin: 6px 0 12px;
      padding: 0 12px 12px;
    }
    .option-btn{
      border: 1px solid var(--stroke);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #f9fafb;
      color: var(--text);
      text-align: left;
      transition: transform .08s ease, background .15s ease;
    }
    .option-btn:hover{
      transform: translateY(-1px);
      background: #f3f4f6;
    }

    .chatInputArea{
      display:flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid var(--stroke);
      background: #ffffff;
    }
    .chatInputArea input{
      flex:1;
      border-radius: 10px;
      border: 1px solid #dbe3ee;
      background: #ffffff;
      padding: 10px 12px;
      font-size: 13px;
      outline: none;
      color: var(--text);
    }
    .chatInputArea input:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
    }
    .chatInputArea button{
      border:none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(180deg, var(--brand), var(--brandDark));
      color: #ffffff;
      min-width: 96px;
      transition: transform .08s ease, opacity .15s ease;
    }
    .chatInputArea button:hover{ transform: translateY(-1px); }
    .chatInputArea button:disabled{ opacity: .55; cursor: default; transform:none; }

    .typing{
      font-size: 12px;
      color: var(--muted);
      padding: 0 16px 10px;
    }

    @media (min-width: 900px){
      .layoutDebts{
        grid-template-columns: 1.25fr .75fr;
        align-items: start;
      }
      .chatBox{ margin-top: 0; }
      .chatMessages{ max-height: 520px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div>
          <div class="logo">acerto.</div>
          <div class="sub">Portal de negociação • canal seguro</div>
        </div>
      </div>
      <div class="meta">
        <div class="pill" id="pillStep">step: inicio</div>
        <a class="link" href="javascript:void(0)" id="btnReiniciar">Reiniciar</a>
      </div>
    </div>

    <!-- VIEW 1 -->
    <div class="view active" id="viewStart">
      <div class="gridStart">
        <div class="card">
          <div class="cardHeader">
            <div>
              <h2>Bem-vindo(a)!</h2>
              <p>Vamos localizar suas informações para seguir com o atendimento.</p>
            </div>
          </div>

          <div class="cardBody">
            <div class="heroNote">
              Para começar, informe seu <strong>CPF ou CNPJ</strong> (somente números).
              Se houver pendência, você verá as opções de negociação na próxima tela.
            </div>

            <div class="formRow">
              <div class="labelRow">
                <span>CPF / CNPJ</span>
                <span>aceita colar com pontuação</span>
              </div>

              <div class="field">
                <input id="docInput" type="text" inputmode="numeric" autocomplete="off" placeholder="Digite seu CPF ou CNPJ" />
              </div>

              <button id="btnContinuar" class="btnPrimary">Continuar</button>
            </div>

            <!-- Aqui entram respostas quando NÃO tem pendência ou não localiza -->
            <div class="startFeed" id="startFeed"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW 2 -->
    <div class="view" id="viewDebts">
      <div class="card">
        <div class="statusBar">
          <div class="statusTitle">
            <div class="t1" id="debtTitle">Pronto!</div>
            <div class="t2" id="debtSubtitle">Aqui estão as informações encontradas para você.</div>
          </div>
          <div class="pill" id="pillDoc">doc: —</div>
        </div>

        <div class="tabs">
          <div class="tab active" id="tabDividas">Minhas dívidas</div>
          <div class="tab" id="tabAcordos">Meus acordos</div>
        </div>

        <div class="layoutDebts">
          <!-- Lista de propostas/cards -->
          <div>
            <div class="debtList" id="debtList">
              <!-- preenchido via JS -->
            </div>
          </div>

          <!-- fallback do chat (mantém toda a sua lógica atual viva) -->
          <div class="chatBox">
            <div class="chatHeader">
              <strong>Atendimento</strong>
              <span>Use os botões ou envie uma mensagem</span>
            </div>

            <div id="chatMessages" class="chatMessages"></div>
            <div class="chatInputArea">
              <input id="chatInput" type="text" placeholder="Digite aqui..." autocomplete="off" />
              <button id="chatSend">Enviar</button>
            </div>
          </div>
        </div>

        <div class="typing" id="typingIndicator" style="display:none;">Digitando...</div>
      </div>
    </div>
  </div>

  <script>
    // ================= CONFIGURAÇÃO =================
    const API_URL = "https://billowing-voice-6efd.asilvino19.workers.dev/";

    // ================= ELEMENTOS =================
    const viewStart = document.getElementById("viewStart");
    const viewDebts  = document.getElementById("viewDebts");

    const pillStep  = document.getElementById("pillStep");
    const pillDoc   = document.getElementById("pillDoc");

    const docInput = document.getElementById("docInput");
    const btnContinuar = document.getElementById("btnContinuar");
    const startFeed = document.getElementById("startFeed");

    const debtList = document.getElementById("debtList");
    const debtTitle = document.getElementById("debtTitle");
    const debtSubtitle = document.getElementById("debtSubtitle");

    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const typingEl = document.getElementById("typingIndicator");

    const btnReiniciar = document.getElementById("btnReiniciar");

    const tabDividas = document.getElementById("tabDividas");
    const tabAcordos = document.getElementById("tabAcordos");

    // ================= ESTADO =================
    let sessionId = Date.now().toString();
    let step = "inicio";
    let documento = null;

    function setStep(next) {
      step = next;
      pillStep.textContent = "step: " + (step ?? "null");
    }

    function sanitizeDoc(text) {
      return String(text || "").replace(/\D/g, "");
    }

    function showView(which){
      if (which === "start"){
        viewStart.classList.add("active");
        viewDebts.classList.remove("active");
      } else {
        viewDebts.classList.add("active");
        viewStart.classList.remove("active");
      }
    }

    function clearStartFeed() { startFeed.innerHTML = ""; }
    function addStartBubble(text, variant="normal"){
      const div = document.createElement("div");
      div.className = "bubble" + (variant==="warn" ? " warn" : (variant==="muted" ? " muted" : ""));
      div.textContent = text || "";
      startFeed.appendChild(div);
      startFeed.scrollIntoView({behavior:"smooth", block:"end"});
    }

    function scrollChatBottom(){
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addChatMessage(text, type="bot"){
      const div = document.createElement("div");
      div.className = "msg " + (type==="bot" ? "msg-bot" : "msg-user");
      div.textContent = text || "";
      chatMessages.appendChild(div);
      scrollChatBottom();
    }

    function addOptions(opcoes){
      const wrapper = document.createElement("div");
      wrapper.className = "options";
      opcoes.forEach(op => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = op.label;
        btn.onclick = () => handleOptionClick(op);
        wrapper.appendChild(btn);
      });
      chatMessages.appendChild(wrapper);
      scrollChatBottom();
    }

    function setInputEnabled(enabled){
      btnContinuar.disabled = !enabled;
      docInput.disabled = !enabled;
      chatInput.disabled = !enabled;
      chatSend.disabled = !enabled;
    }

    function showTyping(show){
      typingEl.style.display = show ? "block" : "none";
    }

    // ================= PROPOSTAS / CARDS =================
    function formatCurrency(v){
      const n = Number(String(v ?? "0").replace(/[^0-9,.-]/g,"").replace(".","").replace(",", ".")) || 0;
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function formatDate(iso){
      if (!iso) return "—";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return String(iso);
      return d.toLocaleDateString("pt-BR");
    }

    /**
     * Monta cards se existir response.parcelas (no seu fluxo, você já manda parcelas em alguns pontos)
     * Se não existir, mostramos um card "Informações disponíveis no atendimento" e deixamos o chat como principal.
     */
    function renderDebtCards(response){
      debtList.innerHTML = "";

      const credor = response?.credor || response?.Credor || response?.dadosCliente?.credor || "Pendência encontrada";
      const contrato = response?.dadosCliente?.contrato || response?.dadosCliente?.NumeroContrato || response?.contrato || "—";

      // Se tiver parcelas numéricas, criamos um card com total + detalhes
      const parcelas = Array.isArray(response?.parcelas) ? response.parcelas : null;

      if (parcelas && parcelas.length){
        let total = 0;
        const linhas = parcelas.map((p, idx) => {
          const valor = p.Valor ?? p.ValorOriginal ?? p._ValorEmAberto ?? p.valor ?? 0;
          total += Number(valor) || 0;
          const venc = formatDate(p.Vencimento);
          return `Parcela ${idx+1}: vencimento ${venc} - valor ${formatCurrency(valor)}`;
        });

        const card = document.createElement("div");
        card.className = "debtCard";
        card.innerHTML = `
          <div class="debtCardTop">
            <div class="debtCredor">
              <div class="c1">${credor}</div>
              <div class="c2">Contrato: ${contrato}</div>
            </div>
            <div class="debtMeta">Atualizado em ${new Date().toLocaleDateString("pt-BR")}</div>
          </div>
          <div class="debtCardBody">
            <div class="priceRow">
              <div>
                <div class="priceLabel">Valor total em aberto</div>
              </div>
              <div class="priceValue">${formatCurrency(total)}</div>
            </div>
            <div class="debtDetails">${linhas.join("\n")}</div>
          </div>
          <div class="actions">
            <button class="btnGreen" data-action="cta1">Quero seguir com essa pendência</button>
            <button class="btnOutline" data-action="cta2">Ver opções no atendimento</button>
          </div>
        `;
        debtList.appendChild(card);

        // Os botões aqui NÃO quebram seu fluxo: apenas “puxam” o usuário pro chat e mostram opções atuais
        card.querySelector('[data-action="cta1"]').onclick = () => {
          // Não envia nada extra. Só guia o usuário para os botões do chat (mantendo o backend intocado).
          addChatMessage("Quero seguir com essa pendência", "user");
          addChatMessage("Perfeito. Use os botões disponíveis abaixo para prosseguir.", "bot");
          scrollChatBottom();
        };
        card.querySelector('[data-action="cta2"]').onclick = () => {
          addChatMessage("Ver opções no atendimento", "user");
          addChatMessage("Certo. Abaixo estão as opções disponíveis.", "bot");
          scrollChatBottom();
        };

        return;
      }

      // Sem parcelas no payload: mostramos um card neutro e deixamos chat guiar
      const fallback = document.createElement("div");
      fallback.className = "debtCard";
      fallback.innerHTML = `
        <div class="debtCardTop">
          <div class="debtCredor">
            <div class="c1">Informações disponíveis</div>
            <div class="c2">Use o atendimento ao lado para ver detalhes e opções</div>
          </div>
          <div class="debtMeta">—</div>
        </div>
        <div class="debtCardBody">
          <div class="priceRow">
            <div class="priceLabel">Encontramos registros vinculados ao documento informado.</div>
          </div>
          <div class="debtDetails">As opções e direcionamentos serão exibidos no atendimento (botões e mensagens).</div>
        </div>
        <div class="actions">
          <button class="btnGreen" data-action="focusChat">Abrir opções no atendimento</button>
        </div>
      `;
      debtList.appendChild(fallback);
      fallback.querySelector('[data-action="focusChat"]').onclick = () => {
        chatInput.focus();
        addChatMessage("Ok, vamos continuar.", "user");
        addChatMessage("Use os botões disponíveis para seguir com o atendimento.", "bot");
      };
    }

    // ================= BACKEND =================
    async function sendToBackend(payload){
      try{
        console.log("API_URL:", API_URL, "payload:", payload);
        setInputEnabled(false);
        showTyping(true);

        const resp = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        showTyping(false);
        setInputEnabled(true);

        if (!resp.ok){
          const t = await resp.text();
          console.error("Erro HTTP", resp.status, t);
          if (viewDebts.classList.contains("active")){
            addChatMessage("Desculpe, ocorreu um erro ao processar sua solicitação.", "bot");
          } else {
            clearStartFeed();
            addStartBubble("Desculpe, ocorreu um erro ao processar sua solicitação.", "warn");
          }
          return;
        }

        const data = await resp.json().catch(async () => {
          const txt = await resp.text();
          try { return JSON.parse(txt); } catch { return null; }
        });

        console.log("Resposta backend:", data);
        handleBackendResponse(data);

      } catch(err){
        showTyping(false);
        setInputEnabled(true);
        console.error("Erro ao chamar backend", err);
        if (viewDebts.classList.contains("active")){
          addChatMessage("Não foi possível se conectar. Verifique sua conexão e tente novamente.", "bot");
        } else {
          clearStartFeed();
          addStartBubble("Não foi possível se conectar. Verifique sua conexão e tente novamente.", "warn");
        }
      }
    }

    function shouldGoToSecondScreen(response){
      const ps = response?.proximoStep;

      if (response?.temDivida === true) return true;

      // passos típicos do seu fluxo atual (expande conforme você for criando)
      const stepsQueIndicamPendencia = new Set([
        "confirmar_identidade",
        "selecionar_credor",
        "pos_identidade",
        "escolher_caminho",
        "escolher_caminho_ira",
        "aguardando_data_pagamento",
        "falar_atendente"
      ]);

      if (ps && stepsQueIndicamPendencia.has(ps)) return true;

      // se vier opções, geralmente é etapa de ação -> mantém tela 2
      if (response?.mensagens?.some(m => Array.isArray(m?.opcoes) && m.opcoes.length)) return true;

      return false;
    }

    function renderMensagensTela1(response){
      clearStartFeed();
      if (response?.mensagens && Array.isArray(response.mensagens)){
        response.mensagens.forEach(m => addStartBubble(m.texto || "", "normal"));
      } else {
        addStartBubble("Não foi possível interpretar a resposta do sistema.", "warn");
      }
    }

    function renderMensagensChat(response){
      if (response?.mensagens && Array.isArray(response.mensagens)){
        response.mensagens.forEach(m => {
          addChatMessage(m.texto || "", "bot");
          if (m.opcoes && Array.isArray(m.opcoes) && m.opcoes.length){
            addOptions(m.opcoes);
          }
        });
      }
    }

    function handleBackendResponse(response){
      if (!response) return;

      if (response.proximoStep !== undefined && response.proximoStep !== null){
        setStep(response.proximoStep);
      }

      // set doc pill
      const docShown = response?.documento || response?.dadosCliente?.documento || documento;
      pillDoc.textContent = "doc: " + (docShown || "—");

      if (shouldGoToSecondScreen(response)){
        showView("debts");

        // Título dinâmico se tiver nome
        const nome = response?.dadosCliente?.nome || response?.nome || null;
        debtTitle.textContent = nome ? `Pronto, ${String(nome).split(" ")[0]}!` : "Pronto!";
        debtSubtitle.textContent = "Aqui estão as informações encontradas para você.";

        // cards (se possível)
        renderDebtCards(response);

        // sempre renderiza chat (para não quebrar nenhuma etapa)
        renderMensagensChat(response);
      } else {
        showView("start");
        renderMensagensTela1(response);
      }
    }

    // ================= AÇÕES =================
    async function startWithDocumento(){
      const raw = docInput.value.trim();
      const doc = sanitizeDoc(raw);

      if (!doc){
        clearStartFeed();
        addStartBubble("Por favor, informe um CPF ou CNPJ para continuar.", "warn");
        return;
      }

      documento = doc;
      clearStartFeed();
      addStartBubble("Consultando…", "muted");

      await sendToBackend({ sessionId, step: "consulta_divida", documento });
    }

    async function processUserMessage(){
      const text = chatInput.value.trim();
      if (!text) return;

      addChatMessage(text, "user");
      chatInput.value = "";

      if (step === "consulta_divida"){
        documento = sanitizeDoc(text);
        await sendToBackend({ sessionId, step: "consulta_divida", documento });
        return;
      }

      if (step === "aguardando_data_pagamento"){
        await sendToBackend({ sessionId, step: "gerar_boleto", documento, dataPagamento: text });
        return;
      }

      if (step === "inicio"){
        documento = sanitizeDoc(text);
        await sendToBackend({ sessionId, step: "consulta_divida", documento });
        return;
      }

      await sendToBackend({ sessionId, step, documento, message: text });
    }

    function handleOptionClick(op){
      addChatMessage(op.label, "user");

      if (op.id === "gerar_boleto"){
        addChatMessage("Informe a data em que pretende realizar o pagamento (formato DD/MM/AAAA).", "bot");
        setStep("aguardando_data_pagamento");
        return;
      }

      if (op.id === "falar_atendente" || op.id === "duvidas"){
        const motivo = op.id === "duvidas" ? "dúvidas/contestação" : "negociação";
        sendToBackend({ sessionId, step: "falar_atendente", documento, motivo });
        return;
      }

      sendToBackend({ sessionId, step, optionId: op.id, documento });
    }

    async function init(){
      setStep("inicio");
      showView("start");
      clearStartFeed();

      await sendToBackend({ sessionId, step: "inicio" });
    }

    function resetAll(){
      sessionId = Date.now().toString();
      documento = null;
      setStep("inicio");
      docInput.value = "";
      chatInput.value = "";
      chatMessages.innerHTML = "";
      debtList.innerHTML = "";
      clearStartFeed();
      showView("start");
      init();
    }

    // ================= tabs (visual only) =================
    tabDividas.onclick = () => {
      tabDividas.classList.add("active");
      tabAcordos.classList.remove("active");
      // visual — sem efeito no backend por enquanto
    };
    tabAcordos.onclick = () => {
      tabAcordos.classList.add("active");
      tabDividas.classList.remove("active");
      // visual — sem efeito no backend por enquanto
      // se quiser, posso deixar essa aba mostrar "nenhum acordo" por padrão.
    };

    // ================= EVENTS =================
    btnContinuar.addEventListener("click", startWithDocumento);
    docInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter"){ e.preventDefault(); startWithDocumento(); }
    });

    chatSend.addEventListener("click", processUserMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter"){ e.preventDefault(); processUserMessage(); }
    });

    btnReiniciar.addEventListener("click", resetAll);

    // start
    init();
  </script>
</body>
</html>
