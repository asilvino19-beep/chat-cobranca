<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>QuatroC ‚Ä¢ Portal de Negocia√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --primary:#c8141f;        /* vermelho QuatroC (ajust√°vel) */
      --primary-dark:#a10f18;
      --shadow: 0 14px 40px rgba(2,6,23,.12);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    /* Evita ‚Äúcursor de digita√ß√£o‚Äù fora do input (sem travar no modal) */
    .no-caret, .no-caret *{
      caret-color: transparent;
    }
    .no-caret{
      cursor: default;
      user-select: none;
    }

    /* Wrapper */
    .shell{
      width: 100%;
      max-width: 980px;
      min-height: 78vh;
      background: var(--card);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.06);
    }

    .topbar{
      padding: 22px 26px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-bottom: 1px solid rgba(15,23,42,.05);
      background: #fff;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      flex-direction: column;
    }

    .brand img{
      height: 58px;             /* üîß tamanho do logo (um pouco maior, sem exagero) */
      width: auto;
      display:block;
      object-fit:contain;
    }

    .content{
      padding: 18px 26px 0;
      background: #fff;
    }

    .back-row{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      margin: 8px 0 18px;
    }
    .back-link{
      appearance:none;
      border:none;
      background:transparent;
      color: var(--muted);
      font-size: 16px;
      cursor:pointer;
      padding: 6px 6px;
    }
    .back-link:hover{ color: var(--text); }

    .stage{
      display:flex;
      justify-content:center;
      padding: 4px 0 26px;
    }

    .panel{
      width: 100%;
      max-width: 720px;
      padding: 26px 22px;
      border-radius: 22px;
      border: 1px solid rgba(15,23,42,.08);
      background: #fff;
    }

    .title{
      margin: 0;
      text-align:center;
      font-size: 40px;
      letter-spacing:-.02em;
      line-height:1.05;
    }

    .subtitle{
      margin: 12px 0 0;
      text-align:center;
      color: var(--muted);
      font-size: 18px;
      line-height:1.4;
    }

    .divider{
      height:1px;
      background: var(--line);
      margin: 22px 0;
    }

    /* Form */
    .form{
      margin-top: 22px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .label-row{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      margin-bottom: 2px;
      color: var(--text);
      font-weight:600;
      font-size: 16px;
    }
    .input{
      width: 100%;
      height: 56px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.15);
      padding: 0 16px;
      font-size: 18px;
      outline:none;
      caret-color: auto; /* s√≥ aqui tem cursor */
      user-select: auto;
    }
    .input:focus{
      border-color: rgba(200,20,31,.55);
      box-shadow: 0 0 0 4px rgba(200,20,31,.12);
    }

    .btn-primary{
      width:100%;
      height: 58px;
      border:none;
      border-radius: 16px;
      background: var(--primary);
      color:#fff;
      font-weight:800;
      font-size: 18px;
      cursor:pointer;
      margin-top: 10px;
      transition: transform .06s ease, background .15s ease;
    }
    .btn-primary:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn-primary:disabled{ opacity:.55; cursor:default; transform:none; }

    .switch-doc{
      text-align:center;
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
    }
    .switch-doc a{
      color: var(--primary);
      font-weight:700;
      text-decoration:none;
      cursor:pointer;
    }
    .switch-doc a:hover{ text-decoration:underline; }

    /* Options / Buttons alignment */
    .actions{
      display:flex;
      gap: 14px;
      justify-content:center; /* ‚úÖ centralizado */
      align-items:center;
      flex-wrap: wrap;
      margin-top: 18px;
    }
    .btn-outline{
      min-width: 220px;
      height: 56px;
      border-radius: 16px;
      background: #fff;
      border: 1px solid rgba(200,20,31,.35);
      color: var(--primary);
      font-weight:800;
      font-size: 18px;
      cursor:pointer;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
    }
    .btn-outline:hover{
      background: rgba(200,20,31,.06);
      border-color: rgba(200,20,31,.55);
      transform: translateY(-1px);
    }

    .btn-ghost{
      min-width: 220px;
      height: 56px;
      border-radius: 16px;
      background: #fff;
      border: 1px solid rgba(15,23,42,.12);
      color: var(--text);
      font-weight:800;
      font-size: 18px;
      cursor:pointer;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
    }
    .btn-ghost:hover{
      background: rgba(15,23,42,.03);
      border-color: rgba(15,23,42,.18);
      transform: translateY(-1px);
    }

    /* Loading (sem borda ao redor do conte√∫do) */
    .loading-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 12px;
      padding: 18px 0 6px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,.04);
      color: var(--text);
      font-weight:700;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--primary);
      box-shadow: 0 0 0 4px rgba(200,20,31,.12);
      animation: pulse 1.1s infinite ease-in-out;
    }
    @keyframes pulse{
      0%{ transform: scale(1); opacity:.9; }
      50%{ transform: scale(1.35); opacity:.6; }
      100%{ transform: scale(1); opacity:.9; }
    }

    /* Card proposta */
    .offer-card{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 18px;
      background: #fff;
    }
    .offer-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
    }
    .offer-title{
      margin:0;
      font-size: 18px;
      font-weight:900;
      letter-spacing:-.01em;
    }
    .offer-meta{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height:1.35;
    }
    .offer-link{
      border:none;
      background:transparent;
      color: var(--primary);
      font-weight:900;
      cursor:pointer;
      padding: 6px 0;
      text-decoration:none;
      font-size: 14px;
    }
    .offer-link:hover{ text-decoration:underline; }

    .offer-cta{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .btn-wide{
      min-width: 240px;
    }

    /* Footer trust */
    .footer{
      padding: 14px 26px 20px;
      border-top: 1px solid rgba(15,23,42,.05);
      background:#fff;
    }
    .trust{
      max-width: 980px;
      margin: 0 auto;
      text-align:center;
      color: var(--muted);
      font-size: 15px;
      line-height:1.4;
    }
    .trust a{
      color: var(--primary);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
    }
    .trust a:hover{ text-decoration:underline; }

    /* Modal Termos */
    .overlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(2,6,23,.55);
      padding: 18px;
      z-index: 999;
    }
    .overlay.show{ display:flex; }

    .modal{
      width: min(860px, 92vw);
      max-height: 78vh;              /* ‚úÖ n√£o cobre tudo */
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 22px 60px rgba(2,6,23,.32);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.22);
      user-select: auto;             /* ‚úÖ permite rolar/selecionar */
      caret-color: transparent;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      background: #fff;
    }
    .modal-header strong{
      font-size: 14px;
      letter-spacing:.02em;
      text-transform: uppercase;
      color: var(--text);
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size: 22px;
      line-height: 1;
      cursor:pointer;
      color: var(--muted);
      padding: 4px 8px;
    }
    .modal-close:hover{ color: var(--text); }

    .modal-body{
      padding: 16px;
      overflow:auto;                 /* ‚úÖ rolagem interna */
      max-height: calc(78vh - 52px);
      color: #0f172a;
    }
    .modal-body h3{
      margin: 0 0 10px;
      font-size: 18px;
      letter-spacing:-.01em;
    }
    .modal-body p{ margin: 10px 0; color:#334155; line-height:1.55; }
    .modal-body ul{ margin: 10px 0 10px 18px; color:#334155; line-height:1.55; }
    .modal-body li{ margin: 6px 0; }

    /* Mobile */
    @media (max-width: 640px){
      .title{ font-size: 30px; }
      .subtitle{ font-size: 16px; }
      .panel{ padding: 22px 16px; }
      .btn-outline,.btn-ghost{ min-width: 150px; flex:1; }
      .brand img{ height: 52px; }
    }
  </style>
</head>

<body>
  <div class="shell no-caret" id="appRoot">
    <div class="topbar">
      <div class="brand">
        <!-- ‚úÖ Troque pela URL final do logo -->
        <img id="brandLogo" src="LOGO_URL_AQUI" alt="QuatroC" />
      </div>
    </div>

    <div class="content">
      <div class="back-row">
        <button class="back-link" id="btnBack" type="button">‚Üê Voltar</button>
      </div>

      <div class="stage">
        <div class="panel" id="panel"></div>
      </div>
    </div>

    <div class="footer">
      <div class="trust">
        Conosco, seus dados s√£o tratados de forma segura e sigilosa. Caso tenha d√∫vidas ou queira saber mais sobre, acesse nossos
        <a id="openTerms">Termos e Pol√≠tica</a>.
      </div>
    </div>
  </div>

  <!-- Modal Termos -->
  <div class="overlay" id="termsOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Termos e Pol√≠tica">
      <div class="modal-header">
        <strong>Termos e Pol√≠tica</strong>
        <button class="modal-close" id="closeTerms" aria-label="Fechar">√ó</button>
      </div>
      <div class="modal-body" id="termsBody">
        <h3>Compromisso com seguran√ßa e sigilo</h3>
        <p>
          A QuatroC adota medidas t√©cnicas e organizacionais para proteger os dados utilizados neste portal,
          com foco em confidencialidade, integridade e disponibilidade das informa√ß√µes.
        </p>

        <h3>1) Finalidade do portal</h3>
        <p>
          Este portal viabiliza o autoatendimento para consulta de pend√™ncias vinculadas ao documento informado
          e direcionamento do atendimento, de forma objetiva e segura.
        </p>

        <h3>2) Dados tratados</h3>
        <ul>
          <li>Documento informado (CPF ou CNPJ);</li>
          <li>Informa√ß√µes necess√°rias para valida√ß√£o e continuidade do atendimento (quando aplic√°vel);</li>
          <li>Informa√ß√µes sobre pend√™ncias e encaminhamentos vinculados ao documento consultado.</li>
        </ul>

        <h3>3) Sigilo e acesso</h3>
        <p>
          Para reduzir exposi√ß√£o indevida, o portal pode solicitar valida√ß√µes adicionais antes de exibir informa√ß√µes.
          N√£o compartilhe seu documento com terceiros e finalize o atendimento ao concluir sua consulta.
        </p>

        <h3>4) Boas pr√°ticas</h3>
        <ul>
          <li>Utilize rede e dispositivo confi√°veis;</li>
          <li>Evite acessar o portal em equipamentos p√∫blicos;</li>
          <li>Ao concluir, encerre a sess√£o e feche o navegador.</li>
        </ul>

        <h3>5) Atendimento humano</h3>
        <p>
          Se preferir, voc√™ pode optar por atendimento humano pelos canais informados no fluxo de atendimento.
        </p>
      </div>
    </div>
  </div>

  <script>
    // ================= CONFIGURA√á√ÉO =================
    const API_URL = "https://billowing-voice-6efd.asilvino19.workers.dev/";

    // ‚úÖ URL do logo (GitHub raw / GitHub Pages / outro host)
    // Exemplo (RAW): https://raw.githubusercontent.com/USUARIO/REPO/main/Logo.png
    const LOGO_URL = "LOGO_URL_AQUI";

    // ================= ESTADO =================
    const panel = document.getElementById("panel");
    const btnBack = document.getElementById("btnBack");

    const brandLogo = document.getElementById("brandLogo");
    brandLogo.src = LOGO_URL;

    const termsOverlay = document.getElementById("termsOverlay");
    const openTerms = document.getElementById("openTerms");
    const closeTerms = document.getElementById("closeTerms");

    let sessionId = Date.now().toString();
    let step = "inicio";
    let documento = null;

    // estados auxiliares do front
    let docMode = "cpf"; // 'cpf' | 'cnpj'
    let lastResponse = null;

    // ================= MODAL TERMOS =================
    function showTerms(){
      termsOverlay.classList.add("show");
      termsOverlay.setAttribute("aria-hidden", "false");
      // permite rolagem do modal sem ‚Äútravamento‚Äù no body
      document.body.style.overflow = "hidden";
    }
    function hideTerms(){
      termsOverlay.classList.remove("show");
      termsOverlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }
    openTerms.addEventListener("click", showTerms);
    closeTerms.addEventListener("click", hideTerms);
    termsOverlay.addEventListener("click", (e) => {
      if (e.target === termsOverlay) hideTerms();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && termsOverlay.classList.contains("show")) hideTerms();
    });

    // ================= HELPERS CPF/CNPJ =================
    function onlyDigits(v){ return (v || "").replace(/\D/g,""); }

    function maskCPF(d){
      // 000.000.000-00
      d = onlyDigits(d).slice(0,11);
      d = d.replace(/^(\d{3})(\d)/, "$1.$2");
      d = d.replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
      d = d.replace(/\.(\d{3})(\d)/, ".$1-$2");
      return d;
    }

    function maskCNPJ(d){
      // 00.000.000/0000-00
      d = onlyDigits(d).slice(0,14);
      d = d.replace(/^(\d{2})(\d)/, "$1.$2");
      d = d.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
      d = d.replace(/\.(\d{3})(\d)/, ".$1/$2");
      d = d.replace(/(\d{4})(\d)/, "$1-$2");
      return d;
    }

    function formatDocForInput(v){
      return docMode === "cnpj" ? maskCNPJ(v) : maskCPF(v);
    }

    function docPlaceholder(){
      return docMode === "cnpj" ? "00.000.000/0000-00" : "000.000.000-00";
    }

    function docLabel(){
      return docMode === "cnpj" ? "Digite seu CNPJ:" : "Digite seu CPF:";
    }

    function isDocValid(d){
      d = onlyDigits(d);
      return docMode === "cnpj" ? d.length === 14 : d.length === 11;
    }

    // ================= UI RENDER =================
    function render(){
      // Determina ‚Äútela‚Äù com base no step
      // Observa√ß√£o: mantemos o backend igual ‚Äî aqui s√≥ troca a apresenta√ß√£o.
      const s = step;

      // back button vis√≠vel s√≥ depois do in√≠cio
      btnBack.style.visibility = (s === "inicio") ? "hidden" : "visible";

      if (s === "inicio"){
        panel.innerHTML = `
          <h1 class="title">Acesse ao portal de negocia√ß√£o</h1>
          <p class="subtitle">Preencha o campo abaixo</p>

          <div class="form">
            <div class="label-row">${docLabel()}</div>
            <input
              id="docInput"
              class="input"
              inputmode="numeric"
              autocomplete="off"
              placeholder="${docPlaceholder()}"
            />
            <button id="btnConfirm" class="btn-primary" disabled>Confirmar</button>

            <div class="switch-doc">
              ${docMode === "cnpj"
                ? `√â pessoa f√≠sica? <a id="toggleDoc">Entrar com CPF</a>`
                : `√â pessoa jur√≠dica? <a id="toggleDoc">Entrar com CNPJ</a>`
              }
            </div>
          </div>
        `;

        const docInput = document.getElementById("docInput");
        const btnConfirm = document.getElementById("btnConfirm");
        const toggleDoc = document.getElementById("toggleDoc");

        docInput.focus();

        docInput.addEventListener("input", () => {
          const masked = formatDocForInput(docInput.value);
          docInput.value = masked;

          btnConfirm.disabled = !isDocValid(masked);
        });

        btnConfirm.addEventListener("click", async () => {
          const digits = onlyDigits(docInput.value);
          if (!digits) return;
          documento = digits;
          // tela de carregamento (sem "Resultado da consulta")
          step = "loading_busca";
          render();
          await sendToBackend({ sessionId, step: "consulta_divida", documento });
        });

        toggleDoc.addEventListener("click", () => {
          docMode = (docMode === "cnpj") ? "cpf" : "cnpj";
          render();
        });

        return;
      }

      if (s === "loading_busca"){
        panel.innerHTML = `
          <p class="subtitle" style="margin-top:0;">
            Estamos localizando as informa√ß√µes vinculadas ao documento informado.
          </p>

          <div class="loading-wrap">
            <div class="pill"><span class="dot"></span>Carregando...</div>
            <div class="subtitle" style="margin:0;">Aguarde um momento.</div>
          </div>
        `;
        return;
      }

      if (s === "confirmar_identidade"){
        // Espera do backend: lastResponse.payload.nome_resumido, ou inferimos do texto
        const nomeResumido =
          (lastResponse && lastResponse.payload && lastResponse.payload.nome_resumido) ||
          (lastResponse && lastResponse.nome_resumido) ||
          extractNomeResumidoFromMensagens(lastResponse) ||
          "NOME LOCALIZADO";

        panel.innerHTML = `
          <h1 class="title">Resultado da consulta</h1>

          <div class="divider"></div>

          <p class="subtitle" style="margin-top:0; color: var(--text); font-size:18px;">
            Localizamos o cadastro em nome de <strong>${escapeHtml(nomeResumido)}</strong>.<br/>
            Estamos falando com essa pessoa?
          </p>

          <div class="actions">
            <button class="btn-outline" id="btnIdSim">Sim</button>
            <button class="btn-outline" id="btnIdNao">N√£o</button>
          </div>
        `;

        document.getElementById("btnIdSim").addEventListener("click", () => {
          // backend segue igual ‚Äî envia optionId
          sendToBackend({ sessionId, step: "confirmar_identidade", optionId: "identidade_sim", documento });
        });

        document.getElementById("btnIdNao").addEventListener("click", () => {
          // S√≥ aqui aparece ‚ÄúNova consulta‚Äù
          step = "nao_sou_cliente";
          render();
        });

        return;
      }

      if (s === "nao_sou_cliente"){
        panel.innerHTML = `
          <h1 class="title">Resultado da consulta</h1>
          <p class="subtitle">Para sua seguran√ßa, precisamos reiniciar a consulta com o documento correto.</p>
          <div class="actions" style="margin-top:18px;">
            <button class="btn-primary btn-wide" id="btnNovaConsulta">Nova consulta</button>
          </div>
        `;
        document.getElementById("btnNovaConsulta").addEventListener("click", resetToStart);
        return;
      }

      if (s === "validar_nome_completo"){
        const opcoes = (lastResponse && lastResponse.payload && Array.isArray(lastResponse.payload.opcoes_nome))
          ? lastResponse.payload.opcoes_nome
          : extractOpcoesFromMensagens(lastResponse);

        panel.innerHTML = `
          <h1 class="title">Resultado da consulta</h1>
          <div class="divider"></div>

          <h2 class="title" style="font-size:34px; margin-top:0;">Confirma√ß√£o</h2>
          <p class="subtitle">Para darmos sequ√™ncia, confirme o nome completo</p>

          <div class="divider"></div>

          <div class="actions" style="flex-direction:column; gap:12px;">
            ${opcoes.map((o,i)=>`
              <button class="btn-ghost" style="min-width: min(520px, 100%);" data-opt="${escapeAttr(o.id || ("opt_"+i))}">
                ${escapeHtml(o.label || o)}
              </button>
            `).join("")}
          </div>
        `;

        panel.querySelectorAll("button[data-opt]").forEach(btn=>{
          btn.addEventListener("click", () => {
            const optionId = btn.getAttribute("data-opt");
            sendToBackend({ sessionId, step: "validar_nome_completo", optionId, documento });
          });
        });

        return;
      }

      if (s === "direcionamento"){
        panel.innerHTML = `
          <h1 class="title">Como deseja prosseguir?</h1>
          <p class="subtitle">Selecione uma op√ß√£o para continuar o atendimento.</p>

          <div class="divider"></div>

          <div class="actions">
            <button class="btn-ghost" id="btnNegociar">Negociar pelo autoatendimento</button>
            <button class="btn-primary btn-wide" id="btnAtendente">Falar com um atendente</button>
          </div>
        `;

        document.getElementById("btnNegociar").addEventListener("click", () => {
          sendToBackend({ sessionId, step: "direcionamento", optionId: "negociar", documento });
        });

        document.getElementById("btnAtendente").addEventListener("click", () => {
          sendToBackend({ sessionId, step: "direcionamento", optionId: "falar_atendente", documento });
        });

        return;
      }

      if (s === "pendencias"){
        // Proposta (placeholder) + detalhes em modal
        const offer = (lastResponse && lastResponse.payload && lastResponse.payload.oferta) ? lastResponse.payload.oferta : {};
        const debt = (lastResponse && lastResponse.payload && lastResponse.payload.divida) ? lastResponse.payload.divida : {};

        const contrato = offer.contrato || debt.contrato || extractContrato(lastResponse) || "‚Äî";
        const valorOferta = offer.valor_oferta || offer.valor || null;
        const labelOferta = offer.titulo || "Proposta dispon√≠vel";

        panel.innerHTML = `
          <h1 class="title">Pend√™ncias localizadas</h1>
          <p class="subtitle">Selecione uma op√ß√£o para prosseguir.</p>

          <div class="divider"></div>

          <div class="offer-card">
            <div class="offer-top">
              <div>
                <p class="offer-title">${escapeHtml(labelOferta)}</p>
                <p class="offer-meta">
                  Contrato: <strong>${escapeHtml(contrato)}</strong>
                  ${valorOferta ? `<br/>Condi√ß√£o: <strong>${escapeHtml(valorOferta)}</strong>` : ``}
                </p>
              </div>

              <button class="offer-link" id="btnDebtDetails" type="button">Detalhes da d√≠vida</button>
            </div>

            <div class="offer-cta">
              <button class="btn-primary btn-wide" id="btnQueroOferta">Quero essa oferta</button>
              <button class="btn-ghost btn-wide" id="btnFalarAtendente2">Falar com um atendente</button>
            </div>
          </div>
        `;

        // abre modal com detalhes (um √∫nico bloco ‚Äî n√£o fragmentado)
        document.getElementById("btnDebtDetails").addEventListener("click", () => {
          fillDebtModal(debt, lastResponse);
          showTerms(); // reutiliza overlay, mas troca conte√∫do temporariamente
          swapTermsToDebtDetails();
        });

        document.getElementById("btnQueroOferta").addEventListener("click", () => {
          sendToBackend({ sessionId, step: "pendencias", optionId: "quero_oferta", documento });
        });

        document.getElementById("btnFalarAtendente2").addEventListener("click", () => {
          sendToBackend({ sessionId, step: "pendencias", optionId: "falar_atendente", documento });
        });

        return;
      }

      // fallback: se cair aqui, volta pro in√≠cio
      resetToStart();
    }

    // ================= BACK / RESET =================
    btnBack.addEventListener("click", () => {
      // comportamento simples: volta 1 passo conforme fluxo
      if (step === "confirmar_identidade" || step === "loading_busca") {
        resetToStart();
        return;
      }
      if (step === "validar_nome_completo"){
        step = "confirmar_identidade";
        render();
        return;
      }
      if (step === "direcionamento"){
        step = "validar_nome_completo";
        render();
        return;
      }
      if (step === "pendencias"){
        step = "direcionamento";
        render();
        return;
      }
      resetToStart();
    });

    function resetToStart(){
      step = "inicio";
      documento = null;
      lastResponse = null;
      render();
    }

    // ================= API =================
    async function sendToBackend(payload){
      try{
        const resp = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok){
          console.error("HTTP", resp.status, await resp.text());
          step = "inicio";
          render();
          alert("N√£o foi poss√≠vel processar sua solicita√ß√£o. Tente novamente.");
          return;
        }

        const data = await resp.json().catch(async () => {
          const txt = await resp.text();
          try { return JSON.parse(txt); } catch { return null; }
        });

        lastResponse = data;

        // IMPORTANT√çSSIMO:
        // Voc√™ j√° usa response.proximoStep ‚Äî vamos continuar respeitando isso.
        if (data && data.proximoStep){
          step = mapBackendStepToUI(data.proximoStep, data);
        } else {
          // fallback: tenta inferir (m√≠nimo)
          step = inferStep(data);
        }

        render();
      }catch(err){
        console.error(err);
        alert("N√£o foi poss√≠vel se conectar. Verifique sua conex√£o e tente novamente.");
        resetToStart();
      }
    }

    // ================= STEP MAPPING =================
    function mapBackendStepToUI(backendStep, data){
      // ajuste conforme seus steps reais no Worker/Fluxo
      // mantemos nomes amig√°veis no front
      switch(backendStep){
        case "inicio":
          return "inicio";
        case "consulta_divida":
          return "loading_busca";
        case "confirmar_identidade":
          return "confirmar_identidade";
        case "validar_nome_completo":
          return "validar_nome_completo";
        case "direcionamento":
          return "direcionamento";
        case "pendencias":
        case "resumo_divida":
          return "pendencias";
        default:
          return backendStep; // se j√° vier no formato do front
      }
    }

    function inferStep(data){
      // fallback bem conservador
      if (!data) return "inicio";
      if (data.mensagens && JSON.stringify(data.mensagens).toLowerCase().includes("estamos falando")) return "confirmar_identidade";
      return "inicio";
    }

    // ================= EXTRA√á√ÉO / UTIL =================
    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }
    function escapeAttr(str){
      return escapeHtml(str).replace(/"/g, "&quot;");
    }

    function extractNomeResumidoFromMensagens(data){
      try{
        const txt = (data.mensagens || []).map(m=>m.texto).join(" ");
        // pega ‚Äúem nome de X.‚Äù e remove sobrenomes extras (mant√©m 2 tokens)
        const m = txt.match(/nome de\s+([A-Z√Ä-√ö\s]+)[\.\,]/i);
        if (!m) return null;
        const nome = m[1].trim().replace(/\s+/g," ");
        const parts = nome.split(" ");
        return parts.slice(0,2).join(" ");
      }catch{
        return null;
      }
    }

    function extractOpcoesFromMensagens(data){
      // Espera algo como mensagens[0].opcoes = [{id,label}]
      const out = [];
      try{
        (data.mensagens || []).forEach(m=>{
          if (Array.isArray(m.opcoes)){
            m.opcoes.forEach(o => out.push(o));
          }
        });
      }catch{}
      // fallback com 3 op√ß√µes ‚Äúgen√©ricas‚Äù (n√£o ideal)
      if (!out.length) return [
        {id:"opt_1", label:"Confirmar nome 1"},
        {id:"opt_2", label:"Confirmar nome 2"},
        {id:"opt_3", label:"Confirmar nome 3"},
      ];
      return out;
    }

    function extractContrato(data){
      try{
        const txt = JSON.stringify(data);
        const m = txt.match(/"NumeroContrato"\s*:\s*"([^"]+)"/);
        return m ? m[1] : null;
      }catch{ return null; }
    }

    // ================= MODAL ‚ÄúDETALHES DA D√çVIDA‚Äù =================
    let termsBackup = null;

    function swapTermsToDebtDetails(){
      const body = document.getElementById("termsBody");
      if (!termsBackup){
        termsBackup = body.innerHTML;
      }
      // conte√∫do j√° preenchido pelo fillDebtModal()
      // ao fechar, restauramos termos
      closeTerms.onclick = () => {
        restoreTermsModal();
        hideTerms();
      };
    }

    function restoreTermsModal(){
      const body = document.getElementById("termsBody");
      if (termsBackup){
        body.innerHTML = termsBackup;
      }
      closeTerms.onclick = hideTerms;
    }

    function fillDebtModal(debt, data){
      const body = document.getElementById("termsBody");

      // tenta montar um bloco √∫nico de informa√ß√µes
      const contrato = debt.contrato || extractContrato(data) || "‚Äî";
      const credor = debt.credor || (debt.Credor || null);
      const valorTotal = debt.valor_total || debt.valor || null;
      const vencimento = debt.vencimento || null;

      // parcelas (se vier)
      const parcelas = Array.isArray(debt.parcelas) ? debt.parcelas : (debt.Parcelas || []);

      body.innerHTML = `
        <h3>Detalhes da d√≠vida</h3>
        <p><strong>Contrato:</strong> ${escapeHtml(contrato)}</p>
        ${credor ? `<p><strong>Credor:</strong> ${escapeHtml(credor)}</p>` : ``}
        ${valorTotal ? `<p><strong>Valor total em aberto:</strong> ${escapeHtml(valorTotal)}</p>` : ``}
        ${vencimento ? `<p><strong>Vencimento:</strong> ${escapeHtml(vencimento)}</p>` : ``}

        ${parcelas && parcelas.length ? `
          <h3 style="margin-top:16px;">Parcelas</h3>
          <ul>
            ${parcelas.map(p=>`
              <li>
                Vencimento: ${escapeHtml((p.Vencimento || p.vencimento || "").toString().slice(0,10) || "‚Äî")}
                ‚Ä¢ Valor: ${escapeHtml(String(p.Valor ?? p.valor ?? "‚Äî"))}
              </li>
            `).join("")}
          </ul>
        ` : `<p style="margin-top:14px; color:#334155;">Sem detalhamento adicional dispon√≠vel no momento.</p>`}
      `;
    }

    // ================= INIT =================
    function init(){
      render();
      // opcional: notificar backend ‚Äúinicio‚Äù (se voc√™ usa)
      // sendToBackend({ sessionId, step: "inicio" });
    }
    init();
  </script>

  <!--
    ‚úÖ COMO GERAR URL DO LOGO NO GITHUB (sem baixar)
    Use o dom√≠nio raw.githubusercontent.com no formato:
    https://raw.githubusercontent.com/SEU_USUARIO/SEU_REPO/main/Logo.png

    Exemplo:
    const LOGO_URL = "https://raw.githubusercontent.com/asilvino19-beep/Logo/main/Logo.png";
  -->
</body>
</html>
