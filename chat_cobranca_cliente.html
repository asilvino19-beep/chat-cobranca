<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>QuatroC | Portal de Negociação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      /* Identidade QuatroC (ajustável) */
      --q-red:#e11d2e;
      --q-red-dark:#b31320;
      --q-bg:#f5f6f8;
      --q-card:#ffffff;
      --q-text:#0f172a;
      --q-muted:#64748b;
      --q-border:#e5e7eb;
      --q-green:#16a34a;
      --shadow: 0 12px 30px rgba(2,6,23,.10);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--q-bg);
      color: var(--q-text);
      min-height:100vh;
    }

    /* Top bar (portal) */
    .topbar{
      width:100%;
      background:#fff;
      border-bottom:1px solid var(--q-border);
    }
    .topbar-inner{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .brand img{
      height:34px;
      width:auto;
      display:block;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      line-height:1.15;
    }
    .brand-text b{
      font-size:15px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .brand-text span{
      font-size:12px;
      color:var(--q-muted);
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      border:1px solid var(--q-border);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--q-muted);
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .link{
      color: var(--q-red);
      text-decoration:none;
      font-weight:700;
      font-size:12px;
    }
    .link:hover{ text-decoration:underline; }

    /* Layout */
    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .card{
      background: var(--q-card);
      border:1px solid var(--q-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-head{
      padding: 18px 20px;
      border-bottom:1px solid var(--q-border);
      background: linear-gradient(180deg,#fff, #fff);
    }
    .card-head h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .card-head p{
      margin:6px 0 0;
      color:var(--q-muted);
      font-size:13px;
    }

    .card-body{
      padding: 18px 20px 20px;
    }

    /* Tela 1 - Form */
    .hint{
      background: #fff;
      border: 1px solid var(--q-border);
      border-radius: 14px;
      padding: 14px 14px;
      color: var(--q-muted);
      font-size: 13px;
    }

    .field{
      margin-top: 14px;
    }
    .field label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color: var(--q-muted);
      margin-bottom:8px;
    }
    .field input{
      width:100%;
      border: 1px solid var(--q-border);
      border-radius: 14px;
      padding: 14px 14px;
      font-size: 16px;
      outline:none;
      background:#fff;
    }
    .field input:focus{
      border-color: rgba(225,29,46,.45);
      box-shadow: 0 0 0 4px rgba(225,29,46,.08);
    }

    .btn-primary{
      width:100%;
      margin-top: 14px;
      border:none;
      border-radius: 14px;
      padding: 14px 16px;
      font-size: 16px;
      font-weight: 800;
      color:#fff;
      background: linear-gradient(180deg, var(--q-red), var(--q-red-dark));
      cursor:pointer;
      transition: transform .05s ease, filter .15s ease;
    }
    .btn-primary:hover{ filter: brightness(1.02); }
    .btn-primary:active{ transform: translateY(1px); }
    .btn-primary:disabled{ opacity:.55; cursor:default; }

    .toggle-row{
      margin-top: 10px;
      text-align:center;
      font-size: 12px;
      color: var(--q-muted);
    }
    .toggle-row button{
      border:none;
      background:none;
      color: var(--q-red);
      font-weight:800;
      cursor:pointer;
      padding:0;
    }
    .toggle-row button:hover{ text-decoration:underline; }

    .trust{
      margin-top: 16px;
      text-align:center;
      color: var(--q-muted);
      font-size: 12px;
    }
    .trust a{ color: var(--q-red); font-weight:800; text-decoration:none; }
    .trust a:hover{ text-decoration:underline; }

    .inline-result{
      margin-top: 14px;
      border: 1px solid var(--q-border);
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      font-size: 13px;
      color: var(--q-text);
      white-space: pre-line;
    }

    /* Tela 2 - Conversa/resultado */
    .chat-wrap{
      display:flex;
      flex-direction:column;
      height: min(76vh, 720px);
    }
    .chat-messages{
      flex:1;
      overflow:auto;
      padding: 14px;
      background: var(--q-bg);
    }

    .bubble{
      max-width: 92%;
      border-radius: 16px;
      padding: 10px 12px;
      font-size: 13px;
      line-height:1.45;
      white-space: pre-line;
      word-break: break-word;
      margin-bottom: 8px;
      border:1px solid transparent;
    }
    .bot{
      background:#fff;
      border-color: var(--q-border);
      border-bottom-left-radius: 6px;
    }
    .user{
      margin-left:auto;
      background: linear-gradient(180deg, var(--q-red), var(--q-red-dark));
      color:#fff;
      border-bottom-right-radius: 6px;
    }

    .options{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin: 6px 0 14px;
    }
    .opt{
      border: 1px solid var(--q-border);
      background:#fff;
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 13px;
      text-align:left;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease;
    }
    .opt:hover{ background:#f8fafc; }
    .opt:active{ transform: translateY(1px); }

    .chat-input{
      padding: 12px;
      border-top:1px solid var(--q-border);
      background:#fff;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .chat-input input{
      flex:1;
      border:1px solid var(--q-border);
      border-radius: 999px;
      padding: 12px 14px;
      font-size: 14px;
      outline:none;
    }
    .chat-input input:focus{
      border-color: rgba(225,29,46,.45);
      box-shadow: 0 0 0 4px rgba(225,29,46,.08);
    }
    .chat-input button{
      border:none;
      border-radius: 999px;
      padding: 12px 16px;
      background: linear-gradient(180deg, var(--q-red), var(--q-red-dark));
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .chat-input button:disabled{ opacity:.55; cursor:default; }

    .typing{
      font-size: 12px;
      color: var(--q-muted);
      margin: 8px 0 0;
      padding-left: 4px;
    }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    @media (max-width: 560px){
      .topbar-inner{ padding: 12px 12px; }
      .container{ padding: 12px; }
      .brand-text span{ display:none; }
      .card-head h1{ font-size:20px; }
      .chat-wrap{ height: 78vh; }
    }
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img id="brandLogo" alt="QuatroC" />
        <div class="brand-text">
          <b>QuatroC</b>
          <span>Portal de negociação • canal seguro</span>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" id="pillStep" style="display:none;">
          <span>Etapa:</span>
          <b id="pillStepText" style="color:var(--q-text); font-weight:900;"></b>
        </div>
        <a class="link" href="#" id="btnReset">Reiniciar</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="grid">

      <!-- VIEW 1: INICIAL -->
      <div id="viewLogin" class="view active">
        <div class="card">
          <div class="card-head">
            <h1>Bem-vindo(a)!</h1>
            <p>Informe seu documento para localizarmos as informações e seguir com o atendimento.</p>
          </div>

          <div class="card-body">
            <div class="hint" id="loginHint">
              Para começar, informe seu <b>CPF</b> ou <b>CNPJ</b>.
            </div>

            <div class="field">
              <label>
                <span id="docLabel">CPF</span>
                <span style="color:var(--q-muted)">Aceita colar com pontuação</span>
              </label>
              <input id="docInput" type="text" inputmode="numeric" autocomplete="off" placeholder="Digite seu CPF" />
            </div>

            <button class="btn-primary" id="btnConfirm">Confirmar</button>

            <div class="toggle-row">
              <span id="toggleText">É pessoa jurídica?</span>
              <button id="btnToggleDoc" type="button">Entrar com CNPJ</button>
            </div>

            <div class="trust">
              Não se preocupe, seus dados estão seguros conosco.
              Caso tenha dúvidas, consulte nossos
              <a href="#" target="_blank" rel="noopener" id="termsLink">Termos e Política</a>.
            </div>

            <div id="inlineResult" class="inline-result" style="display:none;"></div>
          </div>
        </div>
      </div>

      <!-- VIEW 2: RESULTADO / CHAT -->
      <div id="viewChat" class="view">
        <div class="card">
          <div class="card-head">
            <h1>Informações encontradas</h1>
            <p>Abaixo, siga pelo autoatendimento para concluir a tratativa.</p>
          </div>

          <div class="chat-wrap">
            <div id="chatMessages" class="chat-messages"></div>

            <div class="chat-input">
              <input id="chatInput" type="text" placeholder="Digite aqui..." autocomplete="off" />
              <button id="chatSend">Enviar</button>
            </div>

            <div id="typingIndicator" class="typing" style="display:none;">Digitando...</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ================= CONFIGURAÇÃO =================
    const API_URL   = "https://billowing-voice-6efd.asilvino19.workers.dev/";
    const LOGO_URL  = "COLE_AQUI_A_URL_DO_LOGO_DA_QUATROC"; // Ex: https://seusite.com/quatroc.png
    const TERMS_URL = "https://acerto.com.br/seguranca"; // Troque para o link oficial QuatroC quando tiver

    // ====== Estado ======
    let sessionId = Date.now().toString();
    let step = "inicio";
    let documento = null;

    let docMode = "cpf"; // cpf | cnpj

    // ====== Elementos ======
    const viewLogin = document.getElementById("viewLogin");
    const viewChat  = document.getElementById("viewChat");

    const brandLogo = document.getElementById("brandLogo");
    const termsLink = document.getElementById("termsLink");

    const pillStep = document.getElementById("pillStep");
    const pillStepText = document.getElementById("pillStepText");

    const docInput  = document.getElementById("docInput");
    const docLabel  = document.getElementById("docLabel");
    const btnConfirm= document.getElementById("btnConfirm");
    const btnToggle = document.getElementById("btnToggleDoc");
    const toggleText= document.getElementById("toggleText");
    const inlineResult = document.getElementById("inlineResult");

    const chatMessages = document.getElementById("chatMessages");
    const chatInput    = document.getElementById("chatInput");
    const chatSend     = document.getElementById("chatSend");
    const typingIndicator = document.getElementById("typingIndicator");

    const btnReset = document.getElementById("btnReset");

    // ====== Init branding ======
    brandLogo.src = LOGO_URL || "";
    termsLink.href = TERMS_URL;

    // Se não setar LOGO_URL, mostra fallback simples
    brandLogo.onerror = () => {
      brandLogo.style.display = "none";
    };

    // ====== Helpers UI ======
    function setView(which){
      if (which === "login"){
        viewLogin.classList.add("active");
        viewChat.classList.remove("active");
        pillStep.style.display = "none";
      } else {
        viewLogin.classList.remove("active");
        viewChat.classList.add("active");
        pillStep.style.display = "flex";
      }
    }

    function setStepPill(){
      pillStepText.textContent = step || "-";
    }

    function setLoading(isLoading){
      btnConfirm.disabled = isLoading;
      chatSend.disabled   = isLoading;
      chatInput.disabled  = isLoading;
      docInput.disabled   = isLoading;
      typingIndicator.style.display = isLoading ? "block" : "none";
    }

    function addBubble(text, who="bot"){
      const div = document.createElement("div");
      div.className = "bubble " + (who === "bot" ? "bot" : "user");
      div.textContent = text || "";
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addOptions(opcoes){
      const wrap = document.createElement("div");
      wrap.className = "options";

      (opcoes || []).forEach(op => {
        const b = document.createElement("button");
        b.className = "opt";
        b.textContent = op.label;
        b.onclick = () => handleOptionClick(op);
        wrap.appendChild(b);
      });

      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function clearChat(){
      chatMessages.innerHTML = "";
    }

    function showInlineResult(text){
      inlineResult.style.display = "block";
      inlineResult.textContent = text || "";
      inlineResult.scrollIntoView({behavior:"smooth", block:"center"});
    }

    function hideInlineResult(){
      inlineResult.style.display = "none";
      inlineResult.textContent = "";
    }

    // ====== Documento (toggle CPF/CNPJ) ======
    function setDocMode(mode){
      docMode = mode;

      if (docMode === "cpf"){
        docLabel.textContent = "CPF";
        docInput.placeholder = "Digite seu CPF";
        toggleText.textContent = "É pessoa jurídica?";
        btnToggle.textContent = "Entrar com CNPJ";
      } else {
        docLabel.textContent = "CNPJ";
        docInput.placeholder = "Digite seu CNPJ";
        toggleText.textContent = "É pessoa física?";
        btnToggle.textContent = "Entrar com CPF";
      }
    }

    btnToggle.addEventListener("click", () => {
      setDocMode(docMode === "cpf" ? "cnpj" : "cpf");
      docInput.value = "";
      docInput.focus();
    });

    // ====== Backend ======
    async function sendToBackend(payload){
      try{
        setLoading(true);

        const resp = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        const raw = await resp.text();
        let data = null;
        try { data = JSON.parse(raw); } catch { data = null; }

        if (!resp.ok || !data){
          setLoading(false);
          if (viewLogin.classList.contains("active")){
            showInlineResult("Desculpe, ocorreu um erro ao processar sua solicitação. Tente novamente.");
          } else {
            addBubble("Desculpe, ocorreu um erro ao processar sua solicitação.", "bot");
          }
          return null;
        }

        setLoading(false);
        handleBackendResponse(data);
        return data;

      } catch (e){
        setLoading(false);
        if (viewLogin.classList.contains("active")){
          showInlineResult("Não foi possível se conectar. Verifique sua conexão e tente novamente.");
        } else {
          addBubble("Não foi possível se conectar. Verifique sua conexão e tente novamente.", "bot");
        }
        return null;
      }
    }

    function handleBackendResponse(response){
      if (!response) return;

      // Atualiza step se vier
      if (response.proximoStep !== undefined && response.proximoStep !== null){
        step = response.proximoStep;
      }

      setStepPill();

      // Regra de telas:
      // - Se temDivida = true, vamos para a Tela 2 (onde ficam identidade/resumo/opções)
      // - Se temDivida = false ou não existir, mantém na Tela 1 e mostra texto lá
      const hasDebt = response.temDivida === true;

      if (hasDebt){
        // Se estamos saindo da tela 1 para a 2, limpa e inicia a conversa
        if (viewLogin.classList.contains("active")){
          clearChat();
          setView("chat");
        }

        // Renderiza mensagens no chat
        if (Array.isArray(response.mensagens)){
          response.mensagens.forEach(m => {
            addBubble(m.texto || "", "bot");
            if (Array.isArray(m.opcoes) && m.opcoes.length){
              addOptions(m.opcoes);
            }
          });
        }
      } else {
        // Fica na tela 1 (retorno inline)
        if (Array.isArray(response.mensagens) && response.mensagens.length){
          const txt = response.mensagens.map(m => m.texto || "").join("\n\n").trim();
          showInlineResult(txt || "Nenhuma informação retornada.");
        } else {
          showInlineResult("Nenhuma pendência foi identificada para o documento informado.");
        }
      }
    }

    // ====== Ações Tela 1 ======
    btnConfirm.addEventListener("click", async () => {
      hideInlineResult();

      const raw = docInput.value.trim();
      if (!raw){
        showInlineResult("Por favor, informe o CPF ou CNPJ para continuar.");
        return;
      }

      documento = raw.replace(/\D/g, "");

      // Validação básica de tamanho só para UX (backend continua validando)
      if (documento.length !== 11 && documento.length !== 14){
        showInlineResult("Documento inválido. Informe um CPF (11 dígitos) ou CNPJ (14 dígitos).");
        return;
      }

      step = "consulta_divida";
      setStepPill();

      await sendToBackend({
        sessionId,
        step: "consulta_divida",
        documento,
      });
    });

    docInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        btnConfirm.click();
      }
    });

    // ====== Ações Tela 2 ======
    async function processUserMessage(){
      const text = (chatInput.value || "").trim();
      if (!text) return;

      addBubble(text, "user");
      chatInput.value = "";

      // Mantém seu comportamento atual:
      // - se estiver aguardando data, manda step gerar_boleto
      if (step === "aguardando_data_pagamento"){
        await sendToBackend({
          sessionId,
          step: "gerar_boleto",
          documento,
          dataPagamento: text,
        });
        return;
      }

      // caso geral: texto vira "message"
      await sendToBackend({
        sessionId,
        step,
        documento,
        message: text,
      });
    }

    chatSend.addEventListener("click", processUserMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        processUserMessage();
      }
    });

    function handleOptionClick(op){
      addBubble(op.label, "user");

      // Casos especiais que você já tinha
      if (op.id === "gerar_boleto"){
        addBubble("Informe a data em que pretende realizar o pagamento (formato DD/MM/AAAA).", "bot");
        step = "aguardando_data_pagamento";
        setStepPill();
        return;
      }

      if (op.id === "falar_atendente" || op.id === "duvidas"){
        const motivo = op.id === "duvidas" ? "dúvidas/contestação" : "negociação";

        sendToBackend({
          sessionId,
          step: "falar_atendente",
          documento,
          motivo,
        });
        return;
      }

      // Padrão para botões (identidade_sim / identidade_nao / negociar_auto etc.)
      sendToBackend({
        sessionId,
        step,
        optionId: op.id,
        documento,
      });
    }

    // ====== Reset ======
    btnReset.addEventListener("click", (e) => {
      e.preventDefault();
      sessionId = Date.now().toString();
      step = "inicio";
      documento = null;

      docInput.value = "";
      chatInput.value = "";
      clearChat();
      hideInlineResult();
      setView("login");
      setStepPill();
    });

    // ====== Start ======
    setDocMode("cpf");
    setStepPill();
  </script>
</body>
</html>
