<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal de Negociação - QuatroC</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e6eaf2;
      --shadow:0 18px 45px rgba(15,23,42,.08);
      --radius:22px;

      --brand:#c8102e;
      --brand2:#e11d48;
      --btnText:#ffffff;

      --btnOutlineBg:#ffffff;
      --btnOutlineText:var(--brand);
      --btnOutlineBorder:rgba(200,16,46,.28);

      --maxw:980px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f7f9ff 0%, var(--bg) 100%);
      color:var(--text);
    }

    .page{min-height:100vh;display:flex;flex-direction:column;align-items:center;}
    .top{width:100%;padding:18px 20px 8px;display:flex;justify-content:center;}
    .logo{width:78px;height:auto;filter: drop-shadow(0 14px 28px rgba(15,23,42,.08));}

    .wrap{width:100%;max-width:var(--maxw);padding:8px 16px 20px;}
    .shell{background:var(--card);border-radius:24px;box-shadow:var(--shadow);border:1px solid var(--line);overflow:hidden;}
    .shellInner{padding:18px 18px 14px;}

    .backRow{display:flex;align-items:center;gap:10px;color:var(--muted);font-weight:500;cursor:pointer;user-select:none;width:max-content;margin-bottom:10px;}
    .backRow:hover{opacity:.85}

    .panel{border:1px solid var(--line);border-radius:20px;padding:18px;background:#fff;}

    .title{text-align:center;font-size:44px;line-height:1.08;letter-spacing:-.02em;margin:14px 0 8px;font-weight:800;color:#0b1222;}
    .subtitle{text-align:center;margin:0 0 14px;color:var(--muted);font-size:18px;font-weight:600;}

    .centerText{text-align:center;}
    .stack{display:flex;flex-direction:column;gap:14px;align-items:center;}

    .segInline{
      display:inline-flex;gap:6px;background:#f7f8fc;border:1px solid var(--line);
      padding:5px;border-radius:999px;
    }
    .segInline button{
      border:0;background:transparent;padding:7px 11px;border-radius:999px;
      font-weight:900;color:var(--muted);cursor:pointer;font-size:12px;letter-spacing:.02em;line-height:1;
    }
    .segInline button.active{
      background:#fff;color:#111827;box-shadow:0 10px 18px rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.06);
    }

    .inputWrap{width:100%;max-width:620px;margin:0 auto;text-align:left;}
    .labelRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0 8px;}
    .labelRow .labelText{font-size:16px;font-weight:900;color:#111827;}

    .inputWrap input{
      width:100%;padding:14px 16px;font-size:18px;border-radius:14px;border:1px solid var(--line);
      outline:none;box-shadow: inset 0 1px 0 rgba(15,23,42,.02);
    }
    .inputWrap input:focus{
      border-color:rgba(200,16,46,.35);box-shadow:0 0 0 4px rgba(200,16,46,.08);
    }

    .row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;width:100%;}

    .btn{
      cursor:pointer;border-radius:999px;padding:14px 20px;font-weight:900;letter-spacing:.01em;
      font-size:16px;border:1px solid transparent;transition:.18s ease;min-width:200px;
      display:inline-flex;align-items:center;justify-content:center;text-align:center;user-select:none;line-height:1;
    }
    .btn.wide{min-width:480px; max-width:620px; width:100%;}
    .btn.outline{background:var(--btnOutlineBg);color:var(--btnOutlineText);border-color:var(--btnOutlineBorder);}
    .btn.outline:hover{background:rgba(200,16,46,.06);border-color:rgba(200,16,46,.38);}
    .btn.primary{
      background:linear-gradient(180deg, var(--brand2) 0%, var(--brand) 100%);
      color:var(--btnText);box-shadow:0 14px 26px rgba(200,16,46,.22);
    }
    .btn.primary:hover{transform:translateY(-1px)}
    .btn.primary:active{transform:translateY(0px); opacity:.98}
    .btn.small{min-width:0; width:100%; padding:12px 16px; font-size:15px}

    .loadingWrap{display:flex;flex-direction:column;align-items:center;gap:14px;padding:14px 0 0;}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:999px;background:#f2f4f8;font-weight:900;color:#0f172a;}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 6px rgba(200,16,46,.10);}
    .muted{color:var(--muted)}

    .foot{text-align:center;padding:14px 18px 10px;border-top:1px solid var(--line);color:var(--muted);font-size:16px;line-height:1.5;}
    .foot a{color:var(--brand);font-weight:900;text-decoration:none;cursor:pointer;}
    .foot a:hover{text-decoration:underline}

    .view{display:none}
    .view.active{display:block}

    /* Cards */
    .cardsWrap{width:100%;max-width:820px;margin:0 auto;}
    .cardsGrid{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:12px;}
    .card{
      border:1px solid var(--line);border-radius:18px;background:#fff;
      padding:14px;box-shadow:0 10px 22px rgba(15,23,42,.04);
      display:flex;flex-direction:column;gap:10px;
    }
    .cardTop{display:flex;align-items:center;gap:12px;}
    .cardLogo{
      width:56px;height:56px;border-radius:14px;border:1px solid var(--line);
      background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto;
    }
    .cardLogo img{width:100%;height:100%;object-fit:contain;display:block;}
    .cardHead{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .cardTitle{font-weight:900;color:#0b1222;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cardMeta{color:var(--muted);font-weight:700;font-size:13px;}
    .cardBody{display:flex;flex-direction:column;gap:10px;}
    .pillLine{
      border:1px dashed rgba(15,23,42,.12);border-radius:14px;padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:linear-gradient(180deg,#ffffff 0%,#fbfcff 100%);
    }
    .pillLine .k{color:var(--muted);font-weight:800;font-size:12px;}
    .pillLine .v{font-weight:900;color:#0b1222;font-size:14px;white-space:nowrap;}
    .cardActions{display:flex;gap:10px;flex-wrap:wrap;}
    .cardActions .btn{min-width:0;flex:1;}

    .hintLine{
      text-align:center;color:var(--muted);font-weight:700;font-size:14px;margin:0 0 10px;
    }

    /* Modal */
    .overlay{
      position:fixed;inset:0;background:rgba(15,23,42,.55);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:50;
    }
    .overlay.active{display:flex}
    .modal{
      width:min(820px, 96vw);max-height:min(82vh, 820px);
      background:#fff;border-radius:18px;border:1px solid rgba(15,23,42,.10);
      box-shadow:0 30px 90px rgba(15,23,42,.25);overflow:hidden;
      display:flex;flex-direction:column;
    }
    .modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);}
    .modalHead h3{margin:0;font-size:18px;font-weight:900;color:#0b1222;}
    .x{border:0;background:transparent;font-size:24px;cursor:pointer;color:#0b1222;padding:6px 10px;border-radius:10px;}
    .x:hover{background:#f3f5f9}
    .modalBody{padding:16px;overflow:auto;color:#0f172a;line-height:1.65;}
    .modalBody h4{margin:12px 0 8px;font-size:16px}
    .modalBody .smallMuted{color:var(--muted);font-size:13px;font-weight:700;margin-top:-6px}

    /* Form */
    .formGrid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px;margin-top:10px;}
    .field{display:flex;flex-direction:column;gap:6px;}
    .field label{font-weight:900;color:#0b1222;font-size:13px;}
    .field input,.field select,.field textarea{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);
      outline:none;font-size:14px;background:#fff;
    }
    .field textarea{min-height:86px;resize:vertical;}
    .field input:focus,.field select:focus,.field textarea:focus{
      border-color:rgba(200,16,46,.35);box-shadow:0 0 0 4px rgba(200,16,46,.08);
    }
    .span2{grid-column:1 / -1;}
    .checklist{display:flex;flex-direction:column;gap:8px;margin-top:6px;}
    .checkItem{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;}
    .checkItem input{margin-top:3px;}
    .checkItem .t{font-weight:900}
    .checkItem .s{color:var(--muted);font-weight:700;font-size:12px;margin-top:2px;}

    .formActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}
    .formActions .btn{min-width:0;flex:1;}

    @media (max-width:760px){
      .title{font-size:34px}
      .subtitle{font-size:16px}
      .btn{min-width:160px}
      .btn.wide{min-width:0}
      .shellInner{padding:16px}
      .panel{padding:16px}
      .foot{font-size:15px}
      .labelRow{flex-direction:column; align-items:flex-start; gap:8px;}
      .cardsGrid{grid-template-columns:1fr;}
      .formGrid{grid-template-columns:1fr;}
      .span2{grid-column:auto;}
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="top">
      <img class="logo" id="logoImg" alt="QuatroC" />
    </div>

    <div class="wrap">
      <div class="shell">
        <div class="shellInner">
          <div class="backRow" id="btnVoltar" style="visibility:hidden;">
            <span>←</span><span>Voltar</span>
          </div>

          <!-- VIEW: START -->
          <div class="view active" id="vStart">
            <div class="panel">
              <h1 class="title">Portal de negociação</h1>
              <p class="subtitle">Informe abaixo o documento:</p>

              <div class="inputWrap" style="margin-top:6px;">
                <div class="labelRow">
                  <div class="labelText">Digite:</div>
                  <div class="segInline" aria-label="Tipo de documento">
                    <button id="segCPF" class="active" type="button">CPF</button>
                    <button id="segCNPJ" type="button">CNPJ</button>
                  </div>
                </div>

                <input id="docInput" inputmode="numeric" autocomplete="off" placeholder="000.000.000-00" />

                <div class="row" style="margin-top:14px;">
                  <button class="btn primary wide" id="btnConsultar" type="button">Confirmar</button>
                </div>
              </div>
            </div>
          </div>

          <!-- VIEW: LOADING -->
          <div class="view" id="vLoading">
            <div class="panel">
              <p class="subtitle" style="margin-top:10px;">
                Estamos localizando as informações vinculadas ao documento informado.
              </p>

              <div class="loadingWrap">
                <div class="muted" style="font-size:20px;font-weight:700;">Aguarde um momento.</div>
                <div class="pill"><span class="dot"></span>Carregando...</div>
              </div>
            </div>
          </div>

          <!-- VIEW: NO RECORD -->
          <div class="view" id="vNoRecord">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">Não foi possível concluir</h1>
              <p class="subtitle" id="noRecordMsg">
                Não localizamos contrato vinculado a este documento. Verifique se o documento informado está correto.
              </p>
              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnNovaConsultaNoRecord" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

          <!-- VIEW: CONFIRM (nome/razão) -->
          <div class="view" id="vConfirmName">
            <div class="panel">
              <h1 class="title" style="font-size:44px;margin-bottom:4px;">Para darmos sequência, confirme os dados</h1>
              <p class="subtitle" id="confirmSubtitle">Confirme o nome completo.</p>

              <div class="stack" style="margin-top:10px;">
                <div class="msgBox centerText" style="width:100%;max-width:760px;border:1px solid var(--line);border-radius:18px;padding:18px;background:#fff;color:#0f172a;font-size:19px;line-height:1.55;">
                  Selecione uma das opções abaixo:
                </div>

                <div class="stack" id="nameOptions" style="width:100%;"></div>
              </div>
            </div>
          </div>

          <!-- VIEW: WRONG NAME -->
          <div class="view" id="vWrongName">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">Não foi possível validar</h1>
              <p class="subtitle" id="wrongNameText">
                Para sua segurança, o nome selecionado não corresponde ao cadastro encontrado.
                Reinicie a consulta com o documento correto.
              </p>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnNovaConsultaWrong" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

          <!-- VIEW: NEXT (cards + botões) -->
          <div class="view" id="vNext">
            <div class="panel">
              <p class="subtitle" id="cardsIntro" style="margin-top:10px;margin-bottom:10px;">Revise o resumo da sua pendência:</p>

              <div class="cardsWrap">
                <div class="cardsGrid" id="cardsGrid"></div>
              </div>

              <div style="margin-top:14px;">
                <h2 class="title" style="font-size:34px;margin:10px 0 6px;">Como deseja prosseguir?</h2>
                <p class="subtitle" style="margin:0 0 12px;">
                  Você pode seguir com a negociação por aqui ou, se preferir, falar com um atendente.
                </p>

                <div class="hintLine" id="ctaLine"></div>

                <div class="row" style="margin-top:10px;">
                  <button class="btn outline" id="btnAuto" type="button">Negociar pelo autoatendimento</button>
                  <button class="btn outline" id="btnHumano" type="button">Falar com um atendente</button>
                </div>
              </div>
            </div>
          </div>

          <!-- VIEW: ERROR -->
          <div class="view" id="vError">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">Não foi possível concluir</h1>
              <p class="subtitle" id="errorMsg">
                Não foi possível se conectar. Verifique sua conexão e tente novamente.
              </p>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnNovaConsultaErr" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

        </div>

        <div class="foot">
          Conosco, seus dados são tratados de forma segura e sigilosa.
          Caso tenha dúvidas ou queira saber mais, acesse nossos
          <a id="openTerms">Termos e Política</a>.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Termos e Política -->
  <div class="overlay" id="termsOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Termos e Política">
      <div class="modalHead">
        <h3>Termos e Política</h3>
        <button class="x" id="closeTerms" aria-label="Fechar">×</button>
      </div>
      <div class="modalBody">
        <h4>Compromisso com segurança e sigilo</h4>
        <p>
          A QuatroC adota medidas técnicas e organizacionais para proteger os dados utilizados neste portal,
          com foco em confidencialidade, integridade e disponibilidade das informações.
        </p>
      </div>
    </div>
  </div>

  <!-- MODAL: Detalhes (todas as dívidas) -->
  <div class="overlay" id="detailsOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Detalhes">
      <div class="modalHead">
        <h3 id="detailsTitle">Detalhes</h3>
        <button class="x" id="closeDetails" aria-label="Fechar">×</button>
      </div>
      <div class="modalBody">
        <div id="detailsBody"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: IRA - Formulário de agendamento -->
  <div class="overlay" id="iraOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Agendamento IRA">
      <div class="modalHead">
        <h3>Agendar retirada de equipamento</h3>
        <button class="x" id="closeIra" aria-label="Fechar">×</button>
      </div>
      <div class="modalBody">
        <div style="font-weight:900;font-size:16px;color:#0b1222;">Preencha os dados para prosseguirmos com o agendamento</div>
        <div class="smallMuted">As informações serão encaminhadas para validação e retorno do time responsável.</div>

        <div class="formGrid" style="margin-top:12px;">
          <div class="field span2">
            <label for="iraEndereco">Endereço completo</label>
            <textarea id="iraEndereco" placeholder="Rua, número, complemento, bairro, cidade, UF e CEP"></textarea>
          </div>

          <div class="field">
            <label for="iraData1">Opção de data 1</label>
            <input id="iraData1" type="date" />
          </div>
          <div class="field">
            <label for="iraPeriodo1">Período 1</label>
            <select id="iraPeriodo1">
              <option value="">Selecione</option>
              <option value="manhã">Manhã</option>
              <option value="tarde">Tarde</option>
              <option value="integral">Integral</option>
            </select>
          </div>

          <div class="field">
            <label for="iraData2">Opção de data 2</label>
            <input id="iraData2" type="date" />
          </div>
          <div class="field">
            <label for="iraPeriodo2">Período 2</label>
            <select id="iraPeriodo2">
              <option value="">Selecione</option>
              <option value="manhã">Manhã</option>
              <option value="tarde">Tarde</option>
              <option value="integral">Integral</option>
            </select>
          </div>

          <div class="field span2">
            <label>Placa(s) para retirada</label>
            <div class="checklist" id="iraPlacas"></div>
          </div>
        </div>

        <div class="formActions">
          <button class="btn outline" id="btnIraCancelar" type="button">Cancelar</button>
          <button class="btn primary" id="btnIraEnviar" type="button">Enviar solicitação</button>
        </div>

        <div class="smallMuted" id="iraFeedback" style="margin-top:10px;display:none;"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: Escolher projeto para atendimento humano (quando houver mais de 1) -->
  <div class="overlay" id="humanOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Escolher projeto">
      <div class="modalHead">
        <h3>Falar com um atendente</h3>
        <button class="x" id="closeHuman" aria-label="Fechar">×</button>
      </div>
      <div class="modalBody">
        <div style="font-weight:900;font-size:16px;">Selecione o projeto para continuar:</div>
        <div class="modalBtns" id="humanProjectBtns" style="display:flex;flex-direction:column;gap:10px;margin-top:10px;"></div>
        <div class="smallMuted" style="margin-top:8px;">Você será direcionado para o chat do projeto selecionado.</div>
      </div>
    </div>
  </div>

  <script>
    const LOGO_URL = "https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/Logo.png";

    // Ponte Cloudflare Worker -> n8n
    const CRM_ENDPOINT = "https://billowing-voice-6efd.asilvino19.workers.dev/";

    // Chats
    const CHAT_LINK_SASCAR       = "https://lh.grupoasserth.com.br:7180/chat/ass-pu-sascar?theme=blue&pickup=y";
    const CHAT_LINK_IRA          = "https://lh.grupoasserth.com.br:7180/chat/ass-pu-ira?theme=blue&pickup=y";
    const CHAT_LINK_AMIL_DEFAULT = "https://lh.grupoasserth.com.br:7180/chat/ass-pu-amil?theme=blue&pickup=y";
    const CHAT_LINK_REDE_AMERICAS= "https://lh.grupoasserth.com.br:7180/chat/ass-pu-ede-americas?theme=blue&pickup=y";

    // Logos por credor
    const LOGO_AMIL      = "https://asilvino19-beep.github.io/LogoAmil/LogoAmil.jpg";
    const LOGO_MICHELIN  = "https://asilvino19-beep.github.io/LogoMichelin/LogoMichelin.png";
    const LOGO_SHAM      = "https://asilvino19-beep.github.io/LogoSham/LogoSham.jfif";
    const LOGO_REDE      = "https://asilvino19-beep.github.io/LogoRedeAmericas/LogoRedeAmericas.jfif";

    const $ = (id) => document.getElementById(id);

    function onlyDigits(str){ return (str||"").replace(/\D/g,""); }
    function isCPF(d){ return d.length === 11; }
    function isCNPJ(d){ return d.length === 14; }

    function norm(str){
      return (str||"").toString().toUpperCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ").trim();
    }

    function formatBRL(v){
      const n = Number(String(v ?? "0").replace(/[^0-9,.-]/g,"").replace(".","").replace(",", ".")) || 0;
      return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }
    function formatDateBR(iso){
      if (!iso) return "sem data";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return String(iso);
      return d.toLocaleDateString("pt-BR");
    }

    // ====== De/Para credor (nome + logo + chat) ======
    function getCredorPresentation(credorRaw, unidade){
      const c = norm(credorRaw);

      // AMIL Hospitais / Rede Americas -> nome por unidade (fallback)
      const isAmilHosp =
        c.includes("AMIL HOSPITAIS") ||
        c.includes("REDE AMERICAS IMPAR") ||
        c.includes("REDE AMERICAS");

      if (isAmilHosp){
        const nomeUnidade = (unidade && String(unidade).trim()) ? String(unidade).trim() : "Atendimento Hospitalar";
        const logo = c.includes("REDE AMERICAS") ? LOGO_REDE : LOGO_AMIL;
        const chat = c.includes("REDE AMERICAS") ? CHAT_LINK_REDE_AMERICAS : CHAT_LINK_AMIL_DEFAULT;
        return { nome: nomeUnidade, logo, chat, credorTag: c };
      }

      if (c.includes("AMIL OPERADORAS")){
        return { nome:"Amil", logo:LOGO_AMIL, chat:CHAT_LINK_AMIL_DEFAULT, credorTag:c };
      }

      if (c.includes("SASCAR_IRA")){
        return { nome:"Michelin | Equipamentos", logo:LOGO_MICHELIN, chat:CHAT_LINK_IRA, credorTag:c };
      }

      if (c.includes("SASCAR FIXA VARIAVEL")){
        return { nome:"Michelin Connect Fleet", logo:LOGO_MICHELIN, chat:CHAT_LINK_SASCAR, credorTag:c };
      }

      if (c.includes("SANTA HELENA")){
        return { nome:"Santa Helena Saúde", logo:LOGO_SHAM, chat:CHAT_LINK_AMIL_DEFAULT, credorTag:c };
      }

      // default
      return { nome: credorRaw || "Projeto", logo: LOGO_URL, chat: CHAT_LINK_AMIL_DEFAULT, credorTag:c };
    }

    function openChat(url){
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // Máscaras
    function maskCPF(digits){
      const d = digits.slice(0, 11);
      let out = d;
      if (d.length > 3) out = d.slice(0,3) + "." + d.slice(3);
      if (d.length > 6) out = out.slice(0,7) + "." + out.slice(7);
      if (d.length > 9) out = out.slice(0,11) + "-" + out.slice(11);
      return out;
    }
    function maskCNPJ(digits){
      const d = digits.slice(0, 14);
      let out = d;
      if (d.length > 2) out = d.slice(0,2) + "." + d.slice(2);
      if (d.length > 5) out = out.slice(0,6) + "." + out.slice(6);
      if (d.length > 8) out = out.slice(0,10) + "/" + out.slice(10);
      if (d.length > 12) out = out.slice(0,15) + "-" + out.slice(15);
      return out;
    }

    function applyMask(){
      const input = $("docInput");
      const digits = onlyDigits(input.value);
      if (docType === "CPF"){
        input.value = maskCPF(digits);
        input.maxLength = 14;
      } else {
        input.value = maskCNPJ(digits);
        input.maxLength = 18;
      }
    }

    function detectTypeFromDigits(d){
      if (d.length >= 12) return "CNPJ";
      return "CPF";
    }

    // Views
    function setActiveView(viewId){
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      $(viewId).classList.add("active");
      $("btnVoltar").style.visibility = (viewId === "vStart") ? "hidden" : "visible";
      currentView = viewId;
    }

    // Overlays
    function openOverlay(id){
      const el = $(id);
      el.classList.add("active");
      el.setAttribute("aria-hidden", "false");
    }
    function closeOverlay(id){
      const el = $(id);
      el.classList.remove("active");
      el.setAttribute("aria-hidden", "true");
    }

    let currentView = "vStart";
    let docType = "CPF";
    let currentDoc = "";
    let sessionId = Date.now().toString();
    let foundRecord = null;

    // ===== CHAMADA BACK =====
    async function callBackend(step, payload) {
      const body = { step, sessionId, ...payload };

      const res = await fetch(CRM_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok) throw new Error("Falha ao consultar back");
      return await res.json();
    }

    function setDocType(type){
      docType = type;
      $("segCPF").classList.toggle("active", type==="CPF");
      $("segCNPJ").classList.toggle("active", type==="CNPJ");
      $("docInput").placeholder = (type==="CPF") ? "000.000.000-00" : "00.000.000/0000-00";
      applyMask();
    }

    function goStart(){
      currentDoc = "";
      foundRecord = null;
      $("docInput").value = "";
      setDocType("CPF");
      setActiveView("vStart");
    }

    // ====== Nomes para confirmação (real + 2 variações) ======
    function buildNameOptions(realName, typeUpper){
      const name = String(realName || "").trim();
      const clean = name.replace(/\s+/g," ").trim();
      const parts = clean.split(" ").filter(Boolean);

      // fallback seguro
      if (!clean || parts.length < 2){
        const base = (typeUpper === "CNPJ")
          ? "Razão Social"
          : "Nome Completo";
        return [clean || base, typeUpper==="CNPJ" ? "Empresa Exemplo LTDA" : "Maria Helena Santos", typeUpper==="CNPJ" ? "Comercial Brasil SA" : "João Pedro Almeida"];
      }

      const first = parts[0];
      const second = parts[1];
      const prefix = `${first} ${second}`;

      // sufixos fixos (diferentes do real), por tipo
      const pfSuf = ["DA SILVA","DE SOUZA","ALMEIDA","PEREIRA","ROCHA","FERREIRA"];
      const pjSuf = ["SERVIÇOS LTDA","COMÉRCIO LTDA","LOGÍSTICA LTDA","INDÚSTRIA SA","SOLUÇÕES LTDA","DISTRIBUIDORA LTDA"];

      // garante que as variações não coincidam com o final real
      const realUpper = clean.toUpperCase();
      function pick2(list){
        const a = list[0], b = list[1]; // determinístico
        return [a,b];
      }
      const [s1,s2] = pick2(typeUpper==="CNPJ" ? pjSuf : pfSuf);

      let v1 = `${prefix} ${s1}`.toUpperCase();
      let v2 = `${prefix} ${s2}`.toUpperCase();
      let real = clean.toUpperCase();

      // se por acaso bater igual, troca pro próximo
      if (v1 === real) v1 = `${prefix} ${ (typeUpper==="CNPJ" ? pjSuf[2] : pfSuf[2]) }`.toUpperCase();
      if (v2 === real || v2 === v1) v2 = `${prefix} ${ (typeUpper==="CNPJ" ? pjSuf[3] : pfSuf[3]) }`.toUpperCase();

      // embaralhar sem aleatoriedade (real no meio visualmente costuma ser melhor)
      return [v1, real, v2];
    }

    function renderNameOptions(typeUpper, realName){
      const wrap = $("nameOptions");
      wrap.innerHTML = "";

      const opts = buildNameOptions(realName, typeUpper);

      const container = document.createElement("div");
      container.style.width = "100%";
      container.style.maxWidth = "760px";
      container.style.display = "flex";
      container.style.flexDirection = "column";
      container.style.gap = "12px";

      // frase dinâmica CPF/CNPJ
      $("confirmSubtitle").textContent =
        (typeUpper === "CNPJ")
          ? "Confirme a razão social / nome social."
          : "Confirme o nome completo.";

      opts.forEach(opt => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "btn outline";
        b.style.width = "100%";
        b.style.minWidth = "0";
        b.textContent = opt;

        b.addEventListener("click", async () => {
          const realUpper = String(realName || "").trim().toUpperCase();
          const chosen = String(opt || "").trim().toUpperCase();

          // Se escolheu o real, segue. Senão, bloqueia.
          if (realUpper && chosen === realUpper){
            // confirma identidade no back e segue para resumo
            try{
              setActiveView("vLoading");
              const data = await callBackend("confirmar_identidade", {
                documento: currentDoc,
                optionId: "identidade_sim"
              });

              // se back já devolver o resumo, guarda e renderiza cards
              foundRecord = { ...(foundRecord||{}), ...(data||{}) };
              await loadResumoDividas();
            }catch(e){
              $("errorMsg").textContent = "Não foi possível confirmar os dados no momento. Tente novamente.";
              setActiveView("vError");
            }
          } else {
            $("wrongNameText").textContent =
              "Para sua segurança, o dado selecionado não corresponde ao cadastro encontrado. Reinicie a consulta com o documento correto.";
            setActiveView("vWrongName");
          }
        });

        container.appendChild(b);
      });

      wrap.appendChild(container);
    }

    // ====== CARDS (resumo) ======
    function sumParcelas(parcelas){
      const arr = Array.isArray(parcelas) ? parcelas : [];
      let t = 0;
      for (const p of arr){
        const v = Number(p?.Valor ?? p?.ValorOriginal ?? p?._ValorEmAberto ?? p?.valor ?? 0) || 0;
        t += v;
      }
      return t;
    }

    function extractPlacasFromCases(cases){
      const placas = new Set();
      (Array.isArray(cases)?cases:[]).forEach(c=>{
        // no seu fluxo aparece "Numerododocumento" em alguns cenários
        const p = c?.Numerododocumento || c?.numerodocumento || c?.Placa || c?.placa;
        if (p && String(p).trim()) placas.add(String(p).trim().toUpperCase());
      });
      return Array.from(placas);
    }

    function buildDetailsHTML(card){
      // Ordem: Documento > Vencimento > Valor
      const parcelas = Array.isArray(card.parcelas) ? card.parcelas : [];
      if (!parcelas.length) return "<div class='smallMuted'>Sem parcelas para detalhar.</div>";

      const rows = parcelas.map(p=>{
        const doc = (p?.NumeroDocumento ?? p?.numerodocumento ?? p?.Documento ?? p?.documento ?? "-");
        const venc = formatDateBR(p?.Vencimento ?? p?.vencimento);
        const val = formatBRL(p?.Valor ?? p?.ValorOriginal ?? p?._ValorEmAberto ?? p?.valor ?? 0);
        return `
          <div class="pillLine">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <div class="k">Documento</div>
              <div class="v">${String(doc)}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:2px;text-align:right;">
              <div class="k">Vencimento</div>
              <div class="v">${venc}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:2px;text-align:right;">
              <div class="k">Valor</div>
              <div class="v">${val}</div>
            </div>
          </div>
        `;
      }).join("");

      return `<div style="display:flex;flex-direction:column;gap:10px;">${rows}</div>`;
    }

    function buildDetailsHTML_IRA(card){
      // IRA: Placa (numerodocumento) > Data OS (vencimento) > OS (IraOS)
      const parcelas = Array.isArray(card.parcelas) ? card.parcelas : [];
      if (!parcelas.length) return "<div class='smallMuted'>Sem OS para detalhar.</div>";

      const rows = parcelas.map(p=>{
        const placa = (p?.numerodocumento ?? p?.NumeroDocumento ?? card?.placa ?? "-");
        const dataOS = formatDateBR(p?.Vencimento ?? p?.vencimento);
        const os = (p?.IraOS ?? p?.iraos ?? "-");
        return `
          <div class="pillLine">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <div class="k">Placa</div>
              <div class="v">${String(placa)}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:2px;text-align:right;">
              <div class="k">Data OS</div>
              <div class="v">${dataOS}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:2px;text-align:right;">
              <div class="k">OS</div>
              <div class="v">${String(os)}</div>
            </div>
          </div>
        `;
      }).join("");

      return `<div style="display:flex;flex-direction:column;gap:10px;">${rows}</div>`;
    }

    function renderCards(cases){
      const grid = $("cardsGrid");
      grid.innerHTML = "";

      const list = Array.isArray(cases) ? cases : [];
      const plural = list.length > 1;
      $("cardsIntro").textContent = plural ? "Revise o resumo das suas pendências:" : "Revise o resumo da sua pendência:";

      // CTA line
      $("ctaLine").textContent = plural
        ? "Clique em “Detalhes” para revisar cada pendência antes de prosseguir."
        : "Clique em “Detalhes” para revisar sua pendência antes de prosseguir.";

      // define label do botão auto (IRA apenas)
      const hasIRA = list.some(c => norm(c?.credor).includes("SASCAR_IRA"));
      $("btnAuto").textContent = hasIRA ? "Agendar pelo autoatendimento" : "Negociar pelo autoatendimento";

      list.forEach((c, idx) => {
        const credorRaw = c?.credor || c?.Credor || "";
        const unidade = c?.unidade || c?.Unidade || c?.unidadeHospital || "";
        const pres = getCredorPresentation(credorRaw, unidade);

        const contrato = c?.numeroContrato || c?.NumeroContrato || "não informado";
        const total = sumParcelas(c?.parcelas);

        const isIRA = norm(credorRaw).includes("SASCAR_IRA");

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="cardTop">
            <div class="cardLogo"><img alt="Logo" src="${pres.logo}" onerror="this.style.display='none'"></div>
            <div class="cardHead">
              <div class="cardTitle">${pres.nome}</div>
              <div class="cardMeta">Contrato: ${contrato}</div>
            </div>
          </div>

          <div class="cardBody">
            ${isIRA ? "" : `
              <div class="pillLine">
                <div>
                  <div class="k">Valor total atualizado</div>
                  <div class="v">${formatBRL(total)}</div>
                </div>
                <div class="k" style="font-weight:900;">&nbsp;</div>
              </div>
            `}
            <div class="cardActions">
              <button class="btn outline small" type="button" data-action="details" data-idx="${idx}">Detalhes</button>
              <button class="btn primary small" type="button" data-action="${isIRA ? "ira" : "auto"}" data-idx="${idx}">
                ${isIRA ? "Iniciar agendamento" : "Negociar agora"}
              </button>
            </div>
          </div>
        `;

        grid.appendChild(card);
      });

      // bind buttons
      grid.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");
          const idx = Number(btn.getAttribute("data-idx"));
          const c = list[idx];
          if (!c) return;

          const credorRaw = c?.credor || c?.Credor || "";
          const pres = getCredorPresentation(credorRaw, c?.unidade || c?.Unidade);

          if (action === "details"){
            $("detailsTitle").textContent = `Detalhes — ${pres.nome}`;
            const isIRA = norm(credorRaw).includes("SASCAR_IRA");
            $("detailsBody").innerHTML = isIRA ? buildDetailsHTML_IRA(c) : buildDetailsHTML(c);
            openOverlay("detailsOverlay");
            return;
          }

          if (action === "auto"){
            // aqui você pode redirecionar para autoatendimento do projeto (quando existir)
            $("errorMsg").textContent = "Autoatendimento ainda não está conectado ao CRM. (Aguardando mapeamento do back.)";
            setActiveView("vError");
            return;
          }

          if (action === "ira"){
            openIraForm(c);
            return;
          }
        });
      });
    }

    // ====== IRA FORM ======
    let iraContext = null;

    function openIraForm(card){
      iraContext = card;

      // monta placas disponíveis
      const wrap = $("iraPlacas");
      wrap.innerHTML = "";
      const placas = extractPlacasFromCases([card, ...(Array.isArray(foundRecord?.cases)?foundRecord.cases:[])].filter(x => norm(x?.credor||x?.Credor).includes("SASCAR_IRA")));

      // fallback com 1 placa
      const finalPlacas = placas.length ? placas : [String(card?.Numerododocumento || card?.numerodocumento || "Placa não informada").toUpperCase()];

      finalPlacas.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "checkItem";
        div.innerHTML = `
          <input type="checkbox" id="iraPlaca_${i}" value="${p}">
          <div>
            <div class="t">${p}</div>
            <div class="s">Selecione a placa para retirada</div>
          </div>
        `;
        wrap.appendChild(div);
      });

      // reset
      $("iraEndereco").value = "";
      $("iraData1").value = "";
      $("iraData2").value = "";
      $("iraPeriodo1").value = "";
      $("iraPeriodo2").value = "";
      $("iraFeedback").style.display = "none";
      $("iraFeedback").textContent = "";

      openOverlay("iraOverlay");
    }

    function getSelectedPlacas(){
      const checks = $("iraPlacas").querySelectorAll("input[type='checkbox']");
      const out = [];
      checks.forEach(ch => { if (ch.checked) out.push(ch.value); });
      return out;
    }

    // ===== Eventos topo =====
    $("segCPF").addEventListener("click", () => setDocType("CPF"));
    $("segCNPJ").addEventListener("click", () => setDocType("CNPJ"));

    $("docInput").addEventListener("input", () => {
      const digits = onlyDigits($("docInput").value);
      const inferred = detectTypeFromDigits(digits);
      if (inferred !== docType) setDocType(inferred);
      applyMask();
    });

    $("btnVoltar").addEventListener("click", goStart);

    $("btnNovaConsultaNoRecord").addEventListener("click", goStart);
    $("btnNovaConsultaWrong").addEventListener("click", goStart);
    $("btnNovaConsultaErr").addEventListener("click", goStart);

    // Termos
    $("openTerms").addEventListener("click", (e) => { e.preventDefault(); openOverlay("termsOverlay"); });
    $("closeTerms").addEventListener("click", () => closeOverlay("termsOverlay"));
    $("termsOverlay").addEventListener("click", (e) => { if (e.target.id === "termsOverlay") closeOverlay("termsOverlay"); });

    // Detalhes
    $("closeDetails").addEventListener("click", () => closeOverlay("detailsOverlay"));
    $("detailsOverlay").addEventListener("click", (e) => { if (e.target.id === "detailsOverlay") closeOverlay("detailsOverlay"); });

    // IRA modal
    $("closeIra").addEventListener("click", () => closeOverlay("iraOverlay"));
    $("btnIraCancelar").addEventListener("click", () => closeOverlay("iraOverlay"));
    $("iraOverlay").addEventListener("click", (e) => { if (e.target.id === "iraOverlay") closeOverlay("iraOverlay"); });

    $("btnIraEnviar").addEventListener("click", async () => {
      const endereco = String($("iraEndereco").value || "").trim();
      const data1 = $("iraData1").value || "";
      const data2 = $("iraData2").value || "";
      const periodo1 = $("iraPeriodo1").value || "";
      const periodo2 = $("iraPeriodo2").value || "";
      const placas = getSelectedPlacas();

      if (!endereco || !data1 || !periodo1 || !data2 || !periodo2 || !placas.length){
        const fb = $("iraFeedback");
        fb.style.display = "block";
        fb.textContent = "Por favor, preencha endereço, as duas opções de data/período e selecione ao menos uma placa.";
        return;
      }

      try{
        $("btnIraEnviar").disabled = true;
        $("btnIraEnviar").style.opacity = "0.7";

        // Envia para o back (o back grava no SharePoint)
        await callBackend("ira_agendamento", {
          documento: currentDoc,
          credor: iraContext?.credor || iraContext?.Credor || "SASCAR_IRA",
          numeroContrato: iraContext?.numeroContrato || iraContext?.NumeroContrato || null,
          idContrato: iraContext?.idContrato || iraContext?.IDContrato || null,
          enderecoCompleto: endereco,
          opcaoData1: data1,
          opcaoData2: data2,
          periodo1,
          periodo2,
          placas
        });

        const fb = $("iraFeedback");
        fb.style.display = "block";
        fb.textContent = "Solicitação enviada com sucesso. Em breve, retornaremos com a confirmação do agendamento.";
        fb.style.color = "#0f172a";

        setTimeout(() => {
          closeOverlay("iraOverlay");
        }, 900);

      }catch(e){
        const fb = $("iraFeedback");
        fb.style.display = "block";
        fb.textContent = "Não foi possível enviar sua solicitação no momento. Tente novamente.";
      }finally{
        $("btnIraEnviar").disabled = false;
        $("btnIraEnviar").style.opacity = "1";
      }
    });

    // Modal humano
    $("closeHuman").addEventListener("click", () => closeOverlay("humanOverlay"));
    $("humanOverlay").addEventListener("click", (e) => { if (e.target.id === "humanOverlay") closeOverlay("humanOverlay"); });

    // ====== Fluxo principal ======

    // 1) Consultar documento -> back retorna identificação + opções (tela confirmação)
    $("btnConsultar").addEventListener("click", async () => {
      const digits = onlyDigits($("docInput").value);
      currentDoc = digits;

      if (!isCPF(digits) && !isCNPJ(digits)){
        $("errorMsg").textContent = "Documento inválido. Verifique e tente novamente.";
        setActiveView("vError");
        return;
      }

      setActiveView("vLoading");

      try {
        // step consulta_divida (no back ele já consulta CRM e monta identificação + contexto)
        const data = await callBackend("consulta_divida", { documento: digits });

        // Se não localizou, não mostra confirmação
        if (!data || data.clienteLocalizado === false || data.temDivida === false && data.proximoStep === "consulta_divida"){
          $("noRecordMsg").textContent = (data?.mensagens?.[0]?.texto)
            ? data.mensagens[0].texto
            : "Não localizamos contrato vinculado a este documento. Verifique se o documento informado está correto.";
          setActiveView("vNoRecord");
          return;
        }

        foundRecord = data;

        // confirma tela de nome/razão
        const typeUpper = (data.type || (isCNPJ(digits) ? "CNPJ" : "CPF")).toUpperCase();
        const realName = (data.fullName || data.displayName || "").trim();

        // se veio vazio, trata como não localizado (evita “cadastro localizado”)
        if (!realName){
          $("noRecordMsg").textContent = "Não localizamos cadastro vinculado a este documento. Verifique se o documento informado está correto.";
          setActiveView("vNoRecord");
          return;
        }

        renderNameOptions(typeUpper, realName);
        setActiveView("vConfirmName");

      } catch (err) {
        $("errorMsg").textContent = "Não foi possível concluir a consulta no momento. Tente novamente.";
        setActiveView("vError");
      }
    });

    // 2) Depois de confirmar identidade, carregamos resumo (cards)
    async function loadResumoDividas(){
      try{
        // caso o back já tenha devolvido cases/parcelas aqui, aproveita
        // senão chama step "pos_identidade" ou "resumo_dividas" conforme seu fluxo.
        let data = foundRecord;

        // Se não tiver cases, busca resumo
        if (!data || !Array.isArray(data.cases) || data.cases.length === 0){
          data = await callBackend("pos_identidade", { documento: currentDoc });
          foundRecord = { ...(foundRecord||{}), ...(data||{}) };
        }

        const cases = Array.isArray(foundRecord?.cases) ? foundRecord.cases : [];

        if (!cases.length){
          $("noRecordMsg").textContent = "Não identificamos pendências vinculadas a este documento. Agradecemos o seu contato.";
          setActiveView("vNoRecord");
          return;
        }

        renderCards(cases);
        setActiveView("vNext");
      }catch(e){
        $("errorMsg").textContent = "Não foi possível carregar o resumo no momento. Tente novamente.";
        setActiveView("vError");
      }
    }

    // Botões “Como deseja prosseguir?”
    $("btnHumano").addEventListener("click", () => {
      const cases = Array.isArray(foundRecord?.cases) ? foundRecord.cases : [];

      if (!cases.length){
        $("errorMsg").textContent = "Não foi possível identificar o projeto para atendimento. Tente novamente.";
        return setActiveView("vError");
      }

      // monta lista por card (mesmo se logo for igual)
      const btnWrap = $("humanProjectBtns");
      btnWrap.innerHTML = "";

      cases.forEach((c) => {
        const credorRaw = c?.credor || c?.Credor || "";
        const unidade = c?.unidade || c?.Unidade || "";
        const pres = getCredorPresentation(credorRaw, unidade);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn outline";
        btn.style.minWidth = "0";
        btn.textContent = pres.nome;

        btn.addEventListener("click", () => {
          closeOverlay("humanOverlay");
          openChat(pres.chat);
        });

        btnWrap.appendChild(btn);
      });

      openOverlay("humanOverlay");
    });

    $("btnAuto").addEventListener("click", () => {
      const cases = Array.isArray(foundRecord?.cases) ? foundRecord.cases : [];
      const hasIRA = cases.some(c => norm(c?.credor || c?.Credor).includes("SASCAR_IRA"));
      if (hasIRA){
        // se tiver IRA, abre o formulário direto no 1º card IRA
        const ira = cases.find(c => norm(c?.credor || c?.Credor).includes("SASCAR_IRA"));
        if (ira) return openIraForm(ira);
      }

      $("errorMsg").textContent = "Autoatendimento ainda não está conectado ao CRM. (Aguardando mapeamento do back.)";
      setActiveView("vError");
    });

    // Logo
    (function initLogo(){
      const img = $("logoImg");
      img.src = LOGO_URL;
      img.onerror = () => { img.style.display = "none"; };
    })();

    setDocType("CPF");
  </script>
</body>
</html>
