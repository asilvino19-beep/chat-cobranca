<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuatroC • Portal de Negociação</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#d71920;
      --brandDark:#b31218;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }

    .app{ width: 100%; max-width: 520px; }

    .shell{
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(17,24,39,.04);
    }

    .topbar{
      padding: 22px 22px 8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .logo{
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction: column;
    }

    .logo img{
      width: 92px; /* um pouco maior */
      height: auto;
      display:block;
    }

    .screen{
      padding: 10px 26px 24px;
    }

    .title{
      margin: 6px 0 4px;
      font-size: 21px; /* um pouco menor */
      line-height: 1.2;
      font-weight: 780;
      text-align:center;
      letter-spacing: -0.02em;
    }
    .subtitle{
      margin: 0 0 16px; /* centralizado mais “junto” do campo */
      color: var(--muted);
      font-size: 13px;
      text-align:center;
    }

    .divider{ height:1px; background: var(--line); margin: 14px 0 18px; }

    .fieldrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 6px;
    }
    .label{
      font-size: 13px;
      font-weight: 650;
      color: #111827;
    }

    .input{
      width:100%;
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px 14px;
      font-size: 18px;
      outline: none;
      background: #fff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .input:focus{
      border-color: rgba(215,25,32,.45);
      box-shadow: 0 0 0 4px rgba(215,25,32,.10);
    }

    .btn{
      width:100%;
      border: none;
      border-radius: 16px;
      padding: 16px 16px;
      font-size: 15px;
      font-weight: 780;
      cursor:pointer;
      margin-top: 14px;
      background: var(--brand);
      color:#fff;
      transition: transform .05s ease, background .15s ease, opacity .15s ease;
    }
    .btn:hover{ background: var(--brandDark); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .toggle{
      margin-top: 12px;
      text-align:center;
      font-size: 13px;
      color: var(--muted);
      user-select:none;
    }
    .toggle a{
      color: var(--brand);
      font-weight: 780;
      text-decoration:none;
      cursor:pointer;
    }
    .toggle a:hover{ text-decoration: underline; }

    .footer{
      padding: 16px 22px 20px;
      color: var(--muted);
      font-size: 12.5px;
      text-align:center;
      background: linear-gradient(to bottom, rgba(243,244,246,.0), rgba(243,244,246,.65));
      border-top: 1px solid rgba(229,231,235,.6);
    }
    .footer a{
      color: var(--brand);
      font-weight: 750;
      text-decoration:none;
    }
    .footer a:hover{ text-decoration: underline; }

    .cards{
      display:flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }
    .card{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px 14px;
      background:#fff;
      text-align:left;
    }

    .pill{
      font-size: 11px;
      font-weight: 780;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(17,24,39,.06);
      color: #111827;
      white-space: nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .card-title{
      font-size: 14px;
      font-weight: 780;
      margin: 0;
      line-height: 1.25;
    }
    .card-meta{
      margin: 8px 0 0;
      color: #111827;
      font-size: 13.5px;
      line-height: 1.5;
      white-space: pre-line;
    }

    .row-actions{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btn2{
      border-radius: 14px;
      padding: 11px 12px;
      font-size: 13px;
      font-weight: 780;
      border: 1px solid var(--line);
      cursor:pointer;
      background:#fff;
    }
    .btn2.primary{
      background: var(--brand);
      color:#fff;
      border-color: transparent;
    }
    .btn2.primary:hover{ background: var(--brandDark); }
    .btn2:hover{ border-color: rgba(17,24,39,.18); }

    .backlink{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 13px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      margin-bottom: 10px;
    }
    .backlink:hover{ color:#374151; }

    /* Modal Termos */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(17,24,39,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:100%;
      max-width: 720px;
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      overflow:hidden;
      border: 1px solid rgba(17,24,39,.08);
    }
    .modal-top{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }
    .modal-top strong{ font-size: 14px; }
    .modal-close{
      border:none;
      background: transparent;
      font-size: 18px;
      cursor:pointer;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .modal-close:hover{ background: rgba(17,24,39,.06); }
    .modal-body{
      padding: 16px;
      color:#111827;
      font-size: 13.5px;
      line-height: 1.65;
      max-height: 70vh;
      overflow:auto;
    }

    @media (max-width: 420px){
      .screen{ padding: 10px 18px 22px; }
      .title{ font-size: 19px; }
      .logo img{ width: 86px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="shell">

      <div class="topbar">
        <div class="logo">
          <img id="logoImg" alt="QuatroC" />
        </div>
      </div>

      <!-- SCREEN 1 -->
      <div id="screen1" class="screen">
        <div class="title">Acesse ao portal de negociação</div>
        <div class="subtitle">Preencha o campo abaixo</div>

        <div class="divider"></div>

        <div class="fieldrow">
          <div class="label" id="docLabel">Digite seu CPF:</div>
        </div>

        <input
          id="docInput"
          class="input"
          inputmode="numeric"
          autocomplete="off"
          placeholder="000.000.000-00"
        />

        <button id="btnConfirm" class="btn">Confirmar</button>

        <div class="toggle">
          <span>É pessoa jurídica?</span>
          <a id="toggleLink">Entrar com CNPJ</a>
        </div>
      </div>

      <!-- SCREEN 2 -->
      <div id="screen2" class="screen" style="display:none;">
        <div class="backlink" id="btnBack">← Voltar</div>

        <div class="title" id="resultTitle">Resultado da consulta</div>
        <div class="subtitle" id="resultSubtitle">
          Estamos localizando as informações vinculadas ao documento informado.
        </div>

        <div id="resultArea"></div>
      </div>

      <div class="footer">
        Conosco, seus dados são tratados de forma segura e sigilosa.
        Caso tenha dúvidas ou queira saber mais, acesse nossos
        <a id="openTerms">Termos e Política</a>.
      </div>
    </div>
  </div>

  <!-- Modal Termos -->
  <div id="termsOverlay" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-top">
        <strong>Termos e Política • QuatroC</strong>
        <button class="modal-close" id="closeTerms" aria-label="Fechar">✕</button>
      </div>
      <div class="modal-body" id="termsBody"></div>
    </div>
  </div>

  <script>
    // =================== CONFIG ===================
    const API_URL = "https://billowing-voice-6efd.asilvino19.workers.dev/";
    const LOGO_URL = "https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/Logo.png";

    const TERMOS_HTML = `
      <p><strong>1) Confidencialidade e uso de dados</strong><br/>
      A QuatroC trata as informações fornecidas neste portal de forma segura e sigilosa, com o objetivo de viabilizar o atendimento de negociação, regularização ou orientação relacionada a pendências vinculadas ao documento informado.</p>

      <p><strong>2) Finalidade do portal</strong><br/>
      Este portal disponibiliza informações e direcionamentos de autoatendimento quando aplicável. Em alguns cenários, o atendimento poderá ser concluído com suporte humano.</p>

      <p><strong>3) Segurança</strong><br/>
      Recomendamos que você não compartilhe informações sensíveis com terceiros. Caso identifique qualquer comportamento incomum, interrompa o atendimento e solicite suporte.</p>

      <p><strong>4) Atualização</strong><br/>
      As informações exibidas podem sofrer atualização conforme registros e validações internas. Se houver divergência, você poderá solicitar revisão com um atendente.</p>

      <p style="color:#6b7280;font-size:12.5px;margin-top:18px;">
      Última atualização: ${new Date().toLocaleDateString('pt-BR')}
      </p>
    `;

    // =================== STATE ===================
    let sessionId = Date.now().toString();
    let isCnpjMode = false;
    let documentoDigits = "";
    let lastBackendResponse = null;

    // Para o passo de sigilo:
    let pendingIdentityOption = null; // guarda opção que seria enviada, após validação do nome
    let extractedFullName = "";       // nome completo vindo do backend

    // =================== DOM ===================
    const screen1 = document.getElementById("screen1");
    const screen2 = document.getElementById("screen2");

    const logoImg = document.getElementById("logoImg");
    const docInput = document.getElementById("docInput");
    const docLabel = document.getElementById("docLabel");
    const btnConfirm = document.getElementById("btnConfirm");
    const toggleLink = document.getElementById("toggleLink");

    const btnBack = document.getElementById("btnBack");
    const resultArea = document.getElementById("resultArea");
    const resultTitle = document.getElementById("resultTitle");
    const resultSubtitle = document.getElementById("resultSubtitle");

    const termsOverlay = document.getElementById("termsOverlay");
    const openTerms = document.getElementById("openTerms");
    const closeTerms = document.getElementById("closeTerms");
    const termsBody = document.getElementById("termsBody");

    // =================== INIT ===================
    logoImg.src = LOGO_URL;
    termsBody.innerHTML = TERMOS_HTML;

    function showScreen(n){
      if(n === 1){
        screen1.style.display = "";
        screen2.style.display = "none";
        setTimeout(()=> docInput.focus(), 50);
      }else{
        screen1.style.display = "none";
        screen2.style.display = "";
      }
    }

    // =================== MASKS ===================
    function onlyDigits(s){ return (s || "").replace(/\D/g, ""); }

    function maskCpf(d){
      const p1 = d.slice(0,3);
      const p2 = d.slice(3,6);
      const p3 = d.slice(6,9);
      const p4 = d.slice(9,11);
      let out = p1;
      if(p2) out += "." + p2;
      if(p3) out += "." + p3;
      if(p4) out += "-" + p4;
      return out;
    }

    function maskCnpj(d){
      const p1 = d.slice(0,2);
      const p2 = d.slice(2,5);
      const p3 = d.slice(5,8);
      const p4 = d.slice(8,12);
      const p5 = d.slice(12,14);
      let out = p1;
      if(p2) out += "." + p2;
      if(p3) out += "." + p3;
      if(p4) out += "/" + p4;
      if(p5) out += "-" + p5;
      return out;
    }

    function applyMask(){
      const max = isCnpjMode ? 14 : 11;
      documentoDigits = documentoDigits.slice(0, max);

      docInput.value = isCnpjMode ? maskCnpj(documentoDigits) : maskCpf(documentoDigits);

      if(isCnpjMode){
        docLabel.textContent = "Digite seu CNPJ:";
        docInput.placeholder = "00.000.000/0000-00";
        toggleLink.textContent = "Entrar com CPF";
      }else{
        docLabel.textContent = "Digite seu CPF:";
        docInput.placeholder = "000.000.000-00";
        toggleLink.textContent = "Entrar com CNPJ";
      }

      btnConfirm.disabled = documentoDigits.length !== max;
    }

    docInput.addEventListener("input", (e)=>{
      documentoDigits = onlyDigits(e.target.value);
      applyMask();
    });

    toggleLink.addEventListener("click", ()=>{
      isCnpjMode = !isCnpjMode;
      documentoDigits = onlyDigits(docInput.value);
      applyMask();
      docInput.focus();
    });

    // =================== MODAL TERMOS ===================
    function openTermsModal(){ termsOverlay.style.display = "flex"; }
    function closeTermsModal(){ termsOverlay.style.display = "none"; }

    openTerms.addEventListener("click", openTermsModal);
    closeTerms.addEventListener("click", closeTermsModal);
    termsOverlay.addEventListener("click", (e)=>{
      if(e.target === termsOverlay) closeTermsModal();
    });

    // =================== BACKEND ===================
    async function sendToBackend(payload){
      try{
        const resp = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        const txt = await resp.text();
        let data = null;
        try { data = JSON.parse(txt); } catch { data = null; }

        if(!resp.ok || !data){
          return { error: true, raw: txt };
        }
        return data;
      }catch(err){
        return { error: true, raw: String(err) };
      }
    }

    // =================== UTIL ===================
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeSpaces(s){
      return String(s || "").replace(/\s+/g, " ").trim();
    }

    function extractNameFromText(text){
      // Ex: "Localizamos o cadastro em nome de ALEXANDRE VALENTE LEAL.\nEstamos falando com essa pessoa?"
      const t = normalizeSpaces(text);
      const m = t.match(/nome de\s+(.+?)(?:\.\s|\.|,|\sEstamos|Estamos)/i);
      if(m && m[1]) return normalizeSpaces(m[1]).toUpperCase();
      return "";
    }

    function displayShortName(fullName){
      const parts = normalizeSpaces(fullName).split(" ").filter(Boolean);
      if(parts.length >= 3){
        return (parts[0] + " " + parts[1]).toUpperCase(); // primeiro + segundo nome
      }
      if(parts.length === 2){
        return parts[0].toUpperCase(); // somente 1 sobrenome -> exibe só primeiro nome
      }
      return (parts[0] || "").toUpperCase();
    }

    function buildNameOptions(fullName){
      const base = normalizeSpaces(fullName).toUpperCase();
      const parts = base.split(" ").filter(Boolean);

      // Fallback se vier nome estranho
      if(parts.length < 1){
        return [base || "CONFIRMAR", "CONFIRMAR", "CONFIRMAR"].slice(0,3);
      }

      const first = parts[0];
      const second = parts[1] || ""; // pode não existir
      const lastReal = parts[parts.length - 1] || "";

      const commonLast = ["SILVA","SANTOS","OLIVEIRA","SOUSA","PEREIRA","COSTA","ROCHA","ALMEIDA"];
      const pickDifferent = (avoid) => {
        const pool = commonLast.filter(x => x !== avoid);
        return pool[Math.floor(Math.random() * pool.length)];
      };

      // Se tiver 1 sobrenome (2 partes), ainda assim mostramos 3 opções com 2 “iscas”
      // Mantendo "primeiro + (segundo se existir)" + sobrenome
      const prefix = (second ? `${first} ${second}` : `${first}`).trim();

      const opt1 = base; // correto
      const opt2 = `${prefix} ${pickDifferent(lastReal)}`.trim();
      const opt3 = `${prefix} ${pickDifferent(lastReal)}`.trim();

      // embaralha e garante 3 distintos
      const set = Array.from(new Set([opt1,opt2,opt3]));
      while(set.length < 3){
        set.push(`${prefix} ${pickDifferent(lastReal)}`.trim());
      }
      return shuffle(set).slice(0,3);
    }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    // =================== RENDERERS ===================
    function renderLoading(){
      resultTitle.textContent = "Resultado da consulta";
      resultSubtitle.textContent = "Estamos localizando as informações vinculadas ao documento informado.";
      resultArea.innerHTML = `
        <div class="card" style="text-align:center;">
          <span class="pill">Carregando...</span>
          <p class="card-meta" style="margin-top:10px;">Aguarde um momento.</p>
        </div>
      `;
    }

    function renderEmptyState(title, desc){
      resultArea.innerHTML = `
        <div class="card" style="text-align:center;">
          <span class="pill">Consulta finalizada</span>
          <p class="card-title" style="margin-top:10px;">${escapeHtml(title)}</p>
          <p class="card-meta" style="margin-top:8px;color:var(--muted);">${escapeHtml(desc)}</p>
          <div class="row-actions" style="justify-content:center;margin-top:14px;">
            <button class="btn2 primary" id="btnNew">Nova consulta</button>
          </div>
        </div>
      `;
      document.getElementById("btnNew").onclick = ()=>{
        documentoDigits = "";
        applyMask();
        showScreen(1);
      };
    }

    function renderMensagemComOpcoes(texto, opcoes){
      // Renderiza a “mensagem” como card + botões de opção
      const buttons = (opcoes || []).map((op, idx) => {
        const id = escapeHtml(op.id || `op_${idx}`);
        const label = escapeHtml(op.label || "Selecionar");
        const primary = idx === 0 ? "primary" : "";
        return `<button class="btn2 ${primary}" data-option-id="${id}" data-option-label="${label}">${label}</button>`;
      }).join("");

      resultArea.innerHTML = `
        <div class="cards">
          <div class="card">
            <p class="card-meta">${escapeHtml(texto || "")}</p>
            <div class="row-actions">
              ${buttons}
            </div>
          </div>

          <div class="card">
            <div class="row-actions">
              <button class="btn2" id="btnNew2">Nova consulta</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("btnNew2").onclick = ()=>{
        documentoDigits = "";
        applyMask();
        showScreen(1);
      };

      [...resultArea.querySelectorAll("button[data-option-id]")].forEach(btn=>{
        btn.onclick = async ()=>{
          const optionId = btn.getAttribute("data-option-id");
          const optionLabel = btn.getAttribute("data-option-label") || "";

          await handleOptionSelection({ id: optionId, label: optionLabel });
        };
      });
    }

    function renderNameChallenge(fullName){
      const short = displayShortName(fullName);
      const opts = buildNameOptions(fullName);

      resultArea.innerHTML = `
        <div class="cards">
          <div class="card">
            <p class="card-meta">Localizamos o cadastro em nome de <strong>${escapeHtml(short)}</strong>.<br/>Estamos falando com essa pessoa?</p>
            <div class="row-actions">
              <button class="btn2 primary" id="btnYes">Sim</button>
              <button class="btn2" id="btnNo">Não</button>
            </div>
          </div>

          <div class="card" id="challengeCard" style="display:none;">
            <p class="card-title">Para darmos sequência, confirme o nome completo</p>
            <div class="row-actions" style="margin-top:12px;flex-direction:column;">
              ${opts.map(n => `<button class="btn2" data-fullname="${escapeHtml(n)}">${escapeHtml(n)}</button>`).join("")}
            </div>
          </div>

          <div class="card">
            <div class="row-actions">
              <button class="btn2" id="btnNew3">Nova consulta</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("btnNew3").onclick = ()=>{
        documentoDigits = "";
        applyMask();
        showScreen(1);
      };

      document.getElementById("btnNo").onclick = async ()=>{
        // Se não é a pessoa, manda pro backend como identidade_nao (mantém lógica)
        const data = await sendToBackend({
          sessionId,
          step: "confirmar_identidade",
          optionId: "identidade_nao",
          documento: documentoDigits
        });
        handleBackendResponse(data);
      };

      document.getElementById("btnYes").onclick = ()=>{
        // Mostra validação (sigilo) antes de mandar identidade_sim
        document.getElementById("challengeCard").style.display = "";
      };

      [...resultArea.querySelectorAll("button[data-fullname]")].forEach(btn=>{
        btn.onclick = async ()=>{
          const chosen = normalizeSpaces(btn.getAttribute("data-fullname")).toUpperCase();
          const correct = normalizeSpaces(fullName).toUpperCase();

          if(chosen === correct){
            // Só agora envia o "identidade_sim"
            const data = await sendToBackend({
              sessionId,
              step: "confirmar_identidade",
              optionId: "identidade_sim",
              documento: documentoDigits
            });
            handleBackendResponse(data);
          } else {
            // Resposta errada -> por sigilo, encerra e direciona
            renderEmptyState(
              "Não foi possível validar a identificação",
              "Para sua segurança, recomendamos iniciar uma nova consulta ou falar com um atendente."
            );
          }
        };
      });
    }

    function renderFallbackMensagens(mensagens){
      // agora renderiza mensagens + opções se existirem
      const firstWithOptions = (mensagens || []).find(m => Array.isArray(m.opcoes) && m.opcoes.length);
      const firstText = (firstWithOptions && firstWithOptions.texto) ? String(firstWithOptions.texto) : "";

      // Se detectarmos que é a pergunta de identidade, usamos o passo de sigilo
      const full = extractNameFromText(firstText);
      if(full && /estamos falando com essa pessoa/i.test(firstText)){
        extractedFullName = full;
        renderNameChallenge(full);
        return;
      }

      // Caso padrão: lista tudo em cards, e se houver opções em alguma mensagem, prioriza a primeira com opções
      if(firstWithOptions){
        renderMensagemComOpcoes(firstWithOptions.texto || "", firstWithOptions.opcoes || []);
        return;
      }

      const blocks = (mensagens || []).map(m=>{
        const text = (m.texto || "").trim();
        if(!text) return "";
        return `<div class="card"><p class="card-meta" style="margin:0;">${escapeHtml(text)}</p></div>`;
      }).join("");

      resultArea.innerHTML = `
        <div class="cards">
          ${blocks || ""}
          <div class="card">
            <div class="row-actions">
              <button class="btn2 primary" id="btnBackToStart">Nova consulta</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("btnBackToStart").onclick = ()=>{
        documentoDigits = "";
        applyMask();
        showScreen(1);
      };
    }

    function handleBackendResponse(response){
      lastBackendResponse = response;

      if(response && response.error){
        renderEmptyState("Falha ao consultar", "Não foi possível concluir a consulta agora. Tente novamente.");
        return;
      }

      // Fallback do modelo atual do backend
      const msgs = response && Array.isArray(response.mensagens) ? response.mensagens : null;
      if(msgs){
        renderFallbackMensagens(msgs);
        return;
      }

      renderEmptyState("Consulta concluída", "Não foi possível interpretar a resposta. Faça uma nova consulta.");
    }

    async function handleOptionSelection(op){
      // Se vier do backend a opção identidade_sim/nao, a gente aplica o passo de sigilo (quando sim)
      if(op.id === "identidade_sim"){
        // se já temos o nome completo extraído, segue o fluxo de validação
        if(extractedFullName){
          renderNameChallenge(extractedFullName);
          return;
        }
        // se por algum motivo não temos, manda normal
      }

      const data = await sendToBackend({
        sessionId,
        step: "confirmar_identidade",
        optionId: op.id,
        documento: documentoDigits
      });
      handleBackendResponse(data);
    }

    // =================== ACTIONS ===================
    btnConfirm.addEventListener("click", async ()=>{
      const max = isCnpjMode ? 14 : 11;
      if(documentoDigits.length !== max) return;

      showScreen(2);
      renderLoading();

      // limpa estado de sigilo antes de nova consulta
      extractedFullName = "";
      pendingIdentityOption = null;

      const data = await sendToBackend({
        sessionId,
        step: "consulta_divida",
        documento: documentoDigits
      });

      handleBackendResponse(data);
    });

    btnBack.addEventListener("click", ()=>{
      showScreen(1);
    });

    // Estado inicial
    documentoDigits = "";
    applyMask();
    showScreen(1);
  </script>
</body>
</html>
