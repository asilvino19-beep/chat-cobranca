<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>QuatroC • Portal de Negociação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --shadow:0 16px 40px rgba(2,6,23,.12);
      --primary:#c8102e;         /* vermelho QuatroC */
      --primary-2:#e11d48;
      --focus:rgba(200,16,46,.22);
      --radius:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .shell{
      width:100%;
      max-width:980px;
      background:var(--card);
      border-radius:28px;
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.25);
    }

    /* Topo */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px 18px 12px;
      background:linear-gradient(180deg,#ffffff 0%, #ffffff 55%, rgba(255,255,255,.7) 100%);
    }

    .logo-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      user-select:none;
    }

    .logo-img{
      width:92px; /* ajuste solicitado: um pouco maior */
      height:auto;
      display:block;
      filter: drop-shadow(0 10px 24px rgba(2,6,23,.10));
    }

    /* Conteúdo */
    .content{
      padding:28px 18px 6px;
      display:flex;
      justify-content:center;
    }

    .panel{
      width:100%;
      max-width:720px;
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.25);
      background:#fff;
      padding:26px 22px 22px;
    }

    .back{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      text-decoration:none;
      font-weight:600;
      margin-bottom:12px;
      cursor:pointer;
    }
    .back:hover{ color:#334155; }

    .title{
      text-align:center;
      font-size:34px;
      letter-spacing:-.02em;
      margin:6px 0 6px;
    }

    .subtitle{
      text-align:center;
      color:var(--muted);
      font-size:15px; /* ajuste solicitado: menor */
      margin:0 0 18px; /* e centralizado melhor */
    }

    .divider{
      height:1px;
      background:linear-gradient(90deg,transparent,var(--line),transparent);
      margin:18px 0;
    }

    /* Form */
    .form{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .label-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:#0f172a;
      font-weight:700;
      font-size:14px;
    }
    .toggle-link{
      font-weight:700;
      color:var(--primary);
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .toggle-link:hover{ text-decoration:underline; }

    .input{
      width:100%;
      height:56px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.35);
      padding:0 18px;
      font-size:18px;
      outline:none;
      background:#fff;
      color:#0f172a;
      box-shadow:0 1px 0 rgba(2,6,23,.04);
      caret-color: var(--primary); /* “tracinho” só aqui */
    }
    .input:focus{
      border-color:rgba(200,16,46,.55);
      box-shadow:0 0 0 4px var(--focus);
    }

    .btn-row{
      display:flex;
      gap:14px;
      justify-content:center;
      align-items:center;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .btn{
      min-width:210px;
      height:56px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.35);
      background:#fff;
      color:#0f172a;
      font-weight:800;
      font-size:18px;
      cursor:pointer;
      transition:transform .06s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
      box-shadow:0 10px 22px rgba(2,6,23,.06);
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 14px 26px rgba(2,6,23,.10); }
    .btn:active{ transform:translateY(0); }

    .btn-primary{
      background:linear-gradient(180deg,var(--primary-2),var(--primary));
      color:#fff;
      border-color:rgba(200,16,46,.55);
    }
    .btn-primary:hover{ filter:brightness(1.02); }

    /* Botões sim/não e afins — harmonizados */
    .btn-ghost-primary{
      background:#fff;
      color:var(--primary);
      border:1px solid rgba(200,16,46,.35);
    }
    .btn-ghost-primary:hover{
      border-color:rgba(200,16,46,.55);
      box-shadow:0 14px 26px rgba(2,6,23,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(15,23,42,.04);
      color:#0f172a;
      font-weight:800;
      width:max-content;
      margin:0 auto;
    }

    .dot{
      width:9px;height:9px;border-radius:999px;
      background:var(--primary);
      box-shadow:0 0 0 4px rgba(200,16,46,.14);
    }

    /* Cards */
    .card{
      border:1px solid rgba(148,163,184,.25);
      border-radius:18px;
      padding:16px 16px;
      background:#fff;
    }
    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .card-title{
      font-weight:900;
      font-size:18px;
      margin:0;
    }
    .card-meta{
      margin:8px 0 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
      white-space:pre-line;
    }
    .card-link{
      color:var(--primary);
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .card-link:hover{ text-decoration:underline; }

    /* Rodapé */
    .footer{
      padding:14px 18px 18px;
      text-align:center;
      color:var(--muted);
      font-size:14px;
    }
    .footer a{
      color:var(--primary);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
    }
    .footer a:hover{ text-decoration:underline; }

    /* Modal (Termos / Detalhes) — não cobre a tela toda */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:100%;
      max-width:820px;
      background:#fff;
      border-radius:20px;
      box-shadow:0 30px 70px rgba(2,6,23,.25);
      border:1px solid rgba(148,163,184,.35);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff, #fafafa);
    }
    .modal-title{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .modal-close{
      width:40px;height:40px;border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .modal-body{
      padding:16px;
      max-height:70vh; /* caixa rolável */
      overflow:auto;
      color:#0f172a;
      line-height:1.55;
    }

    .modal-body h3{ margin:18px 0 8px; }
    .modal-body ul{ margin:8px 0 14px 18px; color:#0f172a; }
    .modal-body p{ margin:10px 0; color:#0f172a; }
    .note{
      margin-top:10px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(15,23,42,.04);
      border:1px solid rgba(148,163,184,.25);
      color:#334155;
      font-size:13px;
    }

    /* Responsivo */
    @media (max-width:520px){
      .shell{ border-radius:22px; }
      .panel{ padding:22px 16px; }
      .title{ font-size:28px; }
      .btn{ min-width: 160px; width:100%; }
      .btn-row{ gap:10px; }
      .logo-img{ width:84px; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="logo-wrap">
        <!-- Logo (URL via jsdelivr) -->
        <img id="logoImg" class="logo-img" alt="QuatroC" src="https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/Logo.png" />
      </div>
    </div>

    <div class="content">
      <div class="panel">
        <div id="backBtn" class="back" style="display:none;">← Voltar</div>

        <h1 id="title" class="title"></h1>
        <p id="subtitle" class="subtitle"></p>

        <div id="body"></div>

        <div class="divider"></div>

        <div class="footer">
          Conosco, seus dados são tratados de forma segura e sigilosa. Caso tenha dúvidas ou queira saber mais sobre,
          acesse nossos <a id="openTerms">Termos e Política</a>.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal (Termos / Detalhes) -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <h2 id="modalTitle" class="modal-title">Termos e Política</h2>
        <button id="modalClose" class="modal-close" aria-label="Fechar">×</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
    </div>
  </div>

  <script>
    // ================= CONFIGURAÇÃO (mantida) =================
    const API_URL = "https://billowing-voice-6efd.asilvino19.workers.dev/";

    // ================= STATE =================
    let sessionId = Date.now().toString();
    let step = "inicio";
    let documento = null;

    // tipo doc para copy/prompt
    let docMode = "cpf"; // "cpf" | "cnpj"
    const state = {
      // extra: armazenar último retorno bruto (p/ detalhes)
      lastResponse: null,
      lastTexts: [],
      // nome completo que veio do backend (se aparecer no texto)
      fullNameFromBackend: null,
      // rótulo resumido (2 tokens) para exibir na tela de confirmação
      shortNameForConfirm: null
    };

    // ================= ELEMENTS =================
    const backBtn = document.getElementById("backBtn");
    const titleEl = document.getElementById("title");
    const subtitleEl = document.getElementById("subtitle");
    const bodyEl = document.getElementById("body");

    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");
    const openTerms = document.getElementById("openTerms");

    // ================= HELPERS =================
    function onlyDigits(s){ return (s || "").replace(/\D/g,""); }

    function formatCPF(v){
      const d = onlyDigits(v).slice(0,11);
      // 000.000.000-00
      const p1 = d.slice(0,3);
      const p2 = d.slice(3,6);
      const p3 = d.slice(6,9);
      const p4 = d.slice(9,11);
      let out = p1;
      if (p2) out += "." + p2;
      if (p3) out += "." + p3;
      if (p4) out += "-" + p4;
      return out;
    }

    function formatCNPJ(v){
      const d = onlyDigits(v).slice(0,14);
      // 00.000.000/0000-00
      const p1 = d.slice(0,2);
      const p2 = d.slice(2,5);
      const p3 = d.slice(5,8);
      const p4 = d.slice(8,12);
      const p5 = d.slice(12,14);
      let out = p1;
      if (p2) out += "." + p2;
      if (p3) out += "." + p3;
      if (p4) out += "/" + p4;
      if (p5) out += "-" + p5;
      return out;
    }

    function inferDocModeByDigits(digits){
      if (!digits) return docMode;
      if (digits.length > 11) return "cnpj";
      return "cpf";
    }

    function extractNameFromText(text){
      // tenta extrair "nome de XXXX." ou "em nome de XXXX."
      const t = (text || "").replace(/\s+/g," ").trim();
      const m = t.match(/nome de\s+([A-ZÀ-Ü\s'.-]+?)(?:\.\s|\.?$)/i) || t.match(/em nome de\s+([A-ZÀ-Ü\s'.-]+?)(?:\.\s|\.?$)/i);
      if (!m) return null;
      return (m[1] || "").trim();
    }

    function shortName(full){
      if (!full) return null;
      const parts = full.trim().split(/\s+/).filter(Boolean);
      if (parts.length === 0) return null;
      if (parts.length === 1) return parts[0]; // cenário 1 sobrenome/1 nome
      return (parts[0] + " " + parts[1]);      // primeiro + segundo token
    }

    function setPage({title, subtitle, showBack=false}){
      titleEl.textContent = title || "";
      subtitleEl.textContent = subtitle || "";
      backBtn.style.display = showBack ? "inline-flex" : "none";
    }

    function button(label, {primary=false, ghostPrimary=false, onClick}){
      const b = document.createElement("button");
      b.className = "btn" + (primary ? " btn-primary" : "") + (ghostPrimary ? " btn-ghost-primary" : "");
      b.type = "button";
      b.textContent = label;
      b.onclick = onClick;
      return b;
    }

    function showModal({title, html}){
      modalTitle.textContent = title || "Informações";
      modalBody.innerHTML = html || "";
      modalOverlay.style.display = "flex";
    }
    function closeModal(){
      modalOverlay.style.display = "none";
      modalBody.innerHTML = "";
    }

    modalClose.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e)=>{ if(e.target === modalOverlay) closeModal(); });
    openTerms.addEventListener("click", ()=> showTerms());

    // ================= TERMOS E POLÍTICA (inline no portal) =================
    function showTerms(){
      const html = `
        <h3>Compromisso com segurança e sigilo</h3>
        <p>
          A <strong>QuatroC</strong> adota medidas técnicas e organizacionais para proteger os dados utilizados neste portal,
          com foco em confidencialidade, integridade e disponibilidade das informações.
        </p>

        <h3>1) Finalidade do portal</h3>
        <p>
          Este portal viabiliza o <strong>autoatendimento</strong> para consulta de pendências e direcionamento do atendimento,
          de forma objetiva e segura.
        </p>

        <h3>2) Dados tratados</h3>
        <ul>
          <li>Documento informado (<strong>CPF</strong> ou <strong>CNPJ</strong>);</li>
          <li>Informações mínimas de cadastro necessárias para validações de segurança;</li>
          <li>Informações relacionadas às pendências vinculadas ao documento consultado.</li>
        </ul>

        <h3>3) Sigilo e acesso</h3>
        <p>
          Para reduzir exposição indevida, este portal pode solicitar validações adicionais antes de exibir informações
          sobre pendências. Não compartilhe seu documento com terceiros.
        </p>

        <h3>4) Boas práticas</h3>
        <ul>
          <li>Utilize rede e dispositivo confiáveis;</li>
          <li>Evite acessar o portal em equipamentos públicos;</li>
          <li>Ao finalizar, encerre sua consulta.</li>
        </ul>

        <h3>5) Atendimento humano</h3>
        <p>
          Caso prefira, você pode optar por seguir com atendimento humano pelos canais disponibilizados ao final do fluxo.
        </p>

        <div class="note">
          <strong>Importante:</strong> a QuatroC atua na gestão e controle de recebíveis. Este portal não coleta senhas,
          códigos bancários ou informações que não sejam necessárias ao atendimento.
        </div>
      `;
      showModal({ title: "Termos e Política", html });
    }

    // ================= BACKEND CALL (mantida) =================
    async function sendToBackend(payload) {
      try {
        // UI: sempre vai para "carregando" antes do retorno
        renderLoading();

        const resp = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!resp.ok) {
          renderError("Desculpe, ocorreu um erro ao processar sua solicitação.");
          return;
        }

        const data = await resp.json().catch(async () => {
          const txt = await resp.text();
          try { return JSON.parse(txt); } catch { return null; }
        });

        if (!data) {
          renderError("Não foi possível interpretar a resposta. Tente novamente.");
          return;
        }

        state.lastResponse = data;

        // Armazena textos retornados (para detalhes)
        state.lastTexts = [];
        if (data.mensagens && Array.isArray(data.mensagens)) {
          data.mensagens.forEach(m => { if (m && m.texto) state.lastTexts.push(String(m.texto)); });
        }

        // Atualiza step
        if (data.proximoStep !== undefined && data.proximoStep !== null) {
          step = data.proximoStep;
        }

        // Decide tela por conteúdo/step/opções
        routeFromResponse(data);
      } catch (err) {
        renderError("Não foi possível se conectar. Verifique sua conexão e tente novamente.");
      }
    }

    // ================= ROUTING (UI por step/response) =================
    function routeFromResponse(data){
      // 1) Se estamos no início
      if (step === "inicio") {
        renderStart();
        return;
      }

      // 2) Se backend devolveu opções
      const allOptions = collectOptions(data);

      // Tenta capturar nome completo do backend (se veio em texto)
      const maybeName = state.lastTexts.map(extractNameFromText).find(Boolean);
      if (maybeName) {
        state.fullNameFromBackend = maybeName.toUpperCase();
        state.shortNameForConfirm = shortName(state.fullNameFromBackend);
      }

      // 2a) Confirmação identidade (Sim/Não)
      if (hasOptionIds(allOptions, ["identidade_sim","identidade_nao"])) {
        renderConfirmIdentity(allOptions);
        return;
      }

      // 2b) Validação nome completo (lista de nomes como opções)
      // heurística: se tiver 2+ opções e o texto sugerir confirmação do nome
      const joinedText = (state.lastTexts || []).join(" ").toLowerCase();
      if (allOptions.length >= 2 && (joinedText.includes("confirme") || joinedText.includes("nome completo") || joinedText.includes("para dar") )) {
        renderNameValidation(allOptions);
        return;
      }

      // 2c) Escolha de canal (negociar / falar com atendente)
      if (allOptions.length >= 2 && (joinedText.includes("como deseja") || joinedText.includes("prosseguir") || joinedText.includes("selecione uma opção"))) {
        renderHowProceed(allOptions);
        return;
      }

      // 2d) Se tiver opção falar_atendente/duvidas etc. (fluxo antigo) -> renderiza escolha
      if (hasOptionIds(allOptions, ["falar_atendente","duvidas"])) {
        renderHowProceed(allOptions);
        return;
      }

      // 2e) Se escolheu falar com atendente e backend devolveu link/mensagem
      if (step === "falar_atendente") {
        renderAttendantMessage();
        return;
      }

      // 2f) Pendências / negociação
      // A ideia aqui: 1 card com proposta (placeholder) + “Detalhes da dívida” abre modal com tudo que veio do backend.
      if (joinedText.includes("valor") || joinedText.includes("parcela") || joinedText.includes("venc") || joinedText.includes("contrato") || joinedText.includes("pend")) {
        renderPendenciasCard(allOptions);
        return;
      }

      // fallback: mostra uma tela informativa com ações (se houver)
      renderInfoFallback(allOptions);
    }

    function collectOptions(data){
      const out = [];
      if (data && data.mensagens && Array.isArray(data.mensagens)) {
        data.mensagens.forEach(m=>{
          if (m && Array.isArray(m.opcoes)) {
            m.opcoes.forEach(op=>{
              if (op && op.id) out.push(op);
            });
          }
        });
      }
      return out;
    }
    function hasOptionIds(options, ids){
      const set = new Set(options.map(o=>o.id));
      return ids.every(id=>set.has(id));
    }

    // ================= RENDERS =================
    function renderStart(){
      setPage({
        title: "Acesse ao portal de negociação",
        subtitle: "Preencha o campo abaixo",
        showBack: false
      });

      bodyEl.innerHTML = "";

      const form = document.createElement("div");
      form.className = "form";

      const labelRow = document.createElement("div");
      labelRow.className = "label-row";
      const label = document.createElement("div");
      label.textContent = (docMode === "cpf") ? "Digite seu CPF:" : "Digite seu CNPJ:";
      const toggle = document.createElement("a");
      toggle.className = "toggle-link";
      toggle.textContent = (docMode === "cpf") ? "É pessoa jurídica? Entrar com CNPJ" : "É pessoa física? Entrar com CPF";
      toggle.onclick = ()=>{
        docMode = (docMode === "cpf") ? "cnpj" : "cpf";
        renderStart();
        setTimeout(()=> document.getElementById("docInput")?.focus(), 0);
      };

      labelRow.appendChild(label);
      labelRow.appendChild(toggle);

      const input = document.createElement("input");
      input.id = "docInput";
      input.className = "input";
      input.inputMode = "numeric";
      input.autocomplete = "off";
      input.placeholder = (docMode === "cpf") ? "000.000.000-00" : "00.000.000/0000-00";
      input.addEventListener("input", ()=>{
        if (docMode === "cpf") input.value = formatCPF(input.value);
        else input.value = formatCNPJ(input.value);
      });

      const actions = document.createElement("div");
      actions.className = "btn-row";
      const confirmar = button("Confirmar", {
        primary: true,
        onClick: ()=>{
          const digits = onlyDigits(input.value);
          if (!digits) return;
          // define modo pelo que o usuário digitou (se colar algo)
          docMode = inferDocModeByDigits(digits);
          documento = digits;

          // chama backend (mantendo lógica)
          sendToBackend({
            sessionId,
            step: "consulta_divida",
            documento
          });
        }
      });

      actions.appendChild(confirmar);

      form.appendChild(labelRow);
      form.appendChild(input);
      form.appendChild(actions);

      bodyEl.appendChild(form);

      setTimeout(()=> input.focus(), 0);
    }

    function renderLoading(){
      // IMPORTANTE: aqui NÃO aparece "Resultado da consulta"
      setPage({
        title: "",
        subtitle: "Estamos localizando as informações vinculadas ao documento informado.",
        showBack: true
      });

      bodyEl.innerHTML = "";

      const box = document.createElement("div");
      box.style.textAlign = "center";
      box.style.padding = "18px 0 4px";

      const pill = document.createElement("div");
      pill.className = "pill";
      pill.innerHTML = `<span class="dot"></span> Carregando...`;

      const p = document.createElement("p");
      p.style.margin = "14px 0 0";
      p.style.color = "var(--muted)";
      p.style.fontWeight = "700";
      p.textContent = "Aguarde um momento.";

      box.appendChild(pill);
      box.appendChild(p);

      bodyEl.appendChild(box);
    }

    function renderConfirmIdentity(options){
      // decide copy CPF/CNPJ
      const tipo = inferDocModeByDigits(documento || "");
      const short = (state.shortNameForConfirm || state.fullNameFromBackend || "").trim();

      const pergunta = (tipo === "cnpj")
        ? `Localizamos o cadastro da empresa <strong>${escapeHtml(short || "INFORMAÇÃO LOCALIZADA")}</strong>.<br>Você é responsável por esta empresa?`
        : `Localizamos o cadastro em nome de <strong>${escapeHtml(short || "INFORMAÇÃO LOCALIZADA")}</strong>.<br>Estamos falando com essa pessoa?`;

      setPage({
        title: "Resultado da consulta",
        subtitle: "",
        showBack: true
      });

      bodyEl.innerHTML = "";

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<div class="card-meta" style="color:#0f172a;font-size:16px;line-height:1.55">${pergunta}</div>`;

      const row = document.createElement("div");
      row.className = "btn-row";

      const opSim = options.find(o=>o.id==="identidade_sim") || {id:"identidade_sim", label:"Sim"};
      const opNao = options.find(o=>o.id==="identidade_nao") || {id:"identidade_nao", label:"Não"};

      // Harmonizado: ambos brancos com borda vermelha (igual)
      row.appendChild(button(opSim.label || "Sim", {
        ghostPrimary: true,
        onClick: ()=> handleOptionClick(opSim)
      }));
      row.appendChild(button(opNao.label || "Não", {
        ghostPrimary: true,
        onClick: ()=> handleOptionClick(opNao)
      }));

      bodyEl.appendChild(card);
      bodyEl.appendChild(document.createElement("div")).className="divider";
      bodyEl.appendChild(row);
    }

    function renderNewConsultOnly(){
      // ao clicar NÃO -> tela sem "Resultado da consulta"
      setPage({
        title: "",
        subtitle: "",
        showBack: true
      });

      bodyEl.innerHTML = "";

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3 style="margin:0 0 8px;font-size:22px;letter-spacing:-.01em">Orientação</h3>
        <p class="card-meta" style="margin:0">
          Para sua segurança, precisamos reiniciar a consulta com o documento correto.
        </p>
      `;

      const row = document.createElement("div");
      row.className = "btn-row";
      row.appendChild(button("Nova consulta", {
        primary:true,
        onClick: ()=>{
          resetFlow();
          renderStart();
        }
      }));

      bodyEl.appendChild(card);
      bodyEl.appendChild(row);
    }

    function renderNameValidation(options){
      setPage({
        title: "Resultado da consulta",
        subtitle: "Para darmos sequência, confirme o nome completo",
        showBack: true
      });

      bodyEl.innerHTML = "";

      const wrap = document.createElement("div");
      wrap.style.display = "flex";
      wrap.style.flexDirection = "column";
      wrap.style.gap = "12px";

      options.forEach(op=>{
        wrap.appendChild(button(op.label, {
          ghostPrimary: true,
          onClick: ()=> handleOptionClick(op)
        }));
      });

      bodyEl.appendChild(wrap);
    }

    function renderHowProceed(options){
      setPage({
        title: "Como deseja prosseguir?",
        subtitle: "Selecione uma opção para continuar o atendimento.",
        showBack: true
      });

      bodyEl.innerHTML = "";

      const row = document.createElement("div");
      row.className = "btn-row";

      // mantém duas opções harmonizadas
      options.slice(0,2).forEach((op, idx)=>{
        row.appendChild(button(op.label, {
          ghostPrimary: idx===0,
          primary: idx===1,
          onClick: ()=> handleOptionClick(op)
        }));
      });

      bodyEl.appendChild(row);
    }

    function renderAttendantMessage(){
      setPage({
        title: "Atendimento humano",
        subtitle: "",
        showBack: true
      });

      bodyEl.innerHTML = "";

      // tenta achar um link na resposta
      const text = (state.lastTexts || []).join("\n\n");
      const urlMatch = text.match(/https?:\/\/[^\s)]+/i);
      const url = urlMatch ? urlMatch[0] : null;

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <h3 style="margin:0 0 8px;font-size:22px;letter-spacing:-.01em">Preferiu falar com um atendente</h3>
        <p class="card-meta" style="margin:0 0 12px">
          Para seguir com atendimento humano, utilize o link abaixo:
        </p>
        ${url ? `<a class="card-link" href="${escapeAttr(url)}" target="_blank" rel="noopener">Abrir atendimento</a>` : `<p class="card-meta" style="margin:0">Link indisponível no momento.</p>`}
      `;

      bodyEl.appendChild(card);
    }

    function renderPendenciasCard(options){
      setPage({
        title: "Pendências localizadas",
        subtitle: "Selecione uma opção para prosseguir.",
        showBack: true
      });

      bodyEl.innerHTML = "";

      // Card ÚNICO (como você pediu): proposta “fora”, detalhes “dentro”
      const card = document.createElement("div");
      card.className = "card";

      // resumo simples (placeholder de proposta)
      // (quando o back gerar a proposta, você troca estes campos por dados reais)
      const resumo = `
        <div class="card-head">
          <div>
            <p class="card-title" style="margin:0">Opção de negociação disponível</p>
            <p class="card-meta" style="margin:8px 0 0">
              Uma proposta foi identificada para esta pendência. Você pode seguir pelo autoatendimento ou solicitar suporte de um atendente.
            </p>
          </div>
          <a class="card-link" id="openDebtDetails">Detalhes da dívida</a>
        </div>
      `;

      card.innerHTML = resumo;

      // botões: Negociar agora / Falar com atendente
      const row = document.createElement("div");
      row.className = "btn-row";

      // tenta localizar botões do backend
      // se não vier, mantém padrões (sem quebrar a lógica)
      const opNegociar = options.find(o=>/negociar/i.test(o.label || "") || o.id==="negociar_agora") || { id:"negociar_agora", label:"Negociar agora" };
      const opAtendente = options.find(o=>/atendente/i.test(o.label || "") || o.id==="falar_atendente") || { id:"falar_atendente", label:"Falar com um atendente" };

      row.appendChild(button(opNegociar.label, {
        ghostPrimary:true,
        onClick: ()=> handleOptionClick(opNegociar)
      }));
      row.appendChild(button(opAtendente.label, {
        primary:true,
        onClick: ()=> handleOptionClick(opAtendente)
      }));

      bodyEl.appendChild(card);
      bodyEl.appendChild(row);

      // Detalhes da dívida (modal)
      const open = card.querySelector("#openDebtDetails");
      if (open) {
        open.onclick = ()=>{
          const html = `
            <p class="card-meta" style="margin:0 0 10px">
              Abaixo estão as informações retornadas na consulta.
            </p>
            <div class="note" style="white-space:pre-line">${escapeHtml((state.lastTexts || []).join("\n\n"))}</div>
          `;
          showModal({ title: "Detalhes da dívida", html });
        };
      }
    }

    function renderInfoFallback(options){
      setPage({
        title: "Resultado",
        subtitle: "",
        showBack: true
      });

      bodyEl.innerHTML = "";
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <p class="card-meta" style="white-space:pre-line;margin:0">${escapeHtml((state.lastTexts || []).join("\n\n") || "Informações recebidas.")}</p>
      `;
      bodyEl.appendChild(card);

      if (options && options.length){
        const row = document.createElement("div");
        row.className = "btn-row";
        options.forEach(op=>{
          row.appendChild(button(op.label, { ghostPrimary:true, onClick: ()=> handleOptionClick(op) }));
        });
        bodyEl.appendChild(row);
      }
    }

    function renderError(msg){
      setPage({ title: "Não foi possível concluir", subtitle: msg, showBack: true });
      bodyEl.innerHTML = "";
      const row = document.createElement("div");
      row.className = "btn-row";
      row.appendChild(button("Nova consulta", { primary:true, onClick: ()=>{ resetFlow(); renderStart(); } }));
      bodyEl.appendChild(row);
    }

    // ================= OPTION HANDLER (mantendo lógica do fluxo antigo) =================
    function handleOptionClick(op){
      // Se clicou "Não" na confirmação, não precisa ir no backend: vai para nova consulta (como você pediu)
      if (op.id === "identidade_nao") {
        renderNewConsultOnly();
        return;
      }

      // Casos especiais já existentes
      if (op.id === "gerar_boleto") {
        // Se vocês ainda usam boleto/data: aqui você pode criar uma tela específica depois
        // Mantém o step legado para o backend
        step = "aguardando_data_pagamento";
        // (por ora, não implementado no UX novo)
      }

      // Envia padrão (não haverá digitação; só clique)
      sendToBackend({
        sessionId,
        step,          // step atual vindo do backend
        optionId: op.id,
        documento
      });
    }

    // ================= BACK BUTTON =================
    backBtn.addEventListener("click", ()=>{
      // Voltar: comportamento simples e seguro
      // - se já temos documento: volta para início com o documento preservado? aqui não.
      // - para evitar exposição, volta para início e reinicia.
      resetFlow();
      renderStart();
    });

    function resetFlow(){
      sessionId = Date.now().toString();
      step = "inicio";
      documento = null;
      state.lastResponse = null;
      state.lastTexts = [];
      state.fullNameFromBackend = null;
      state.shortNameForConfirm = null;
    }

    // ================= SAFE ESCAPE =================
    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
    function escapeAttr(str){
      return String(str || "")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;")
        .replaceAll("<","")
        .replaceAll(">","");
    }

    // ================= LOGO FALLBACK =================
    const logoImg = document.getElementById("logoImg");
    logoImg.addEventListener("error", ()=>{
      // fallback discreto se CDN falhar
      logoImg.style.display = "none";
      const t = document.createElement("div");
      t.style.fontWeight = "900";
      t.style.color = "#0f172a";
      t.style.padding = "8px 0";
      t.textContent = "QuatroC";
      logoImg.parentNode.appendChild(t);
    });

    // ================= INIT =================
    (function init(){
      // inicia no layout novo diretamente (sem chat)
      renderStart();
      // se você quiser manter a “mensagem inicial” do backend, descomente:
      // sendToBackend({ sessionId, step: "inicio" });
    })();
  </script>
</body>
</html>
