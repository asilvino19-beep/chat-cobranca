<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal de Negociação - QuatroC</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e6eaf2;
      --shadow:0 18px 45px rgba(15,23,42,.08);
      --radius:22px;

      --brand:#c8102e;
      --brand2:#e11d48;
      --btnText:#ffffff;

      --btnOutlineBg:#ffffff;
      --btnOutlineText:var(--brand);
      --btnOutlineBorder:rgba(200,16,46,.28);

      --maxw:980px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f7f9ff 0%, var(--bg) 100%);
      color:var(--text);
    }

    .page{min-height:100vh;display:flex;flex-direction:column;align-items:center;}
    .top{width:100%;padding:18px 20px 8px;display:flex;justify-content:center;}
    .logo{width:78px;height:auto;filter: drop-shadow(0 14px 28px rgba(15,23,42,.08));}

    .wrap{width:100%;max-width:var(--maxw);padding:8px 16px 20px;}
    .shell{background:var(--card);border-radius:24px;box-shadow:var(--shadow);border:1px solid var(--line);overflow:hidden;}
    .shellInner{padding:18px 18px 14px;}

    .backRow{display:flex;align-items:center;gap:10px;color:var(--muted);font-weight:500;cursor:pointer;user-select:none;width:max-content;margin-bottom:10px;}
    .backRow:hover{opacity:.85}

    .panel{border:1px solid var(--line);border-radius:20px;padding:18px;background:#fff;}

    .title{text-align:center;font-size:44px;line-height:1.08;letter-spacing:-.02em;margin:14px 0 8px;font-weight:800;color:#0b1222;}
    .subtitle{text-align:center;margin:0 0 14px;color:var(--muted);font-size:18px;font-weight:500;}

    .centerText{text-align:center;}
    .stack{display:flex;flex-direction:column;gap:14px;align-items:center;}

    .segInline{
      display:inline-flex;gap:6px;background:#f7f8fc;border:1px solid var(--line);
      padding:5px;border-radius:999px;
    }
    .segInline button{
      border:0;background:transparent;padding:7px 11px;border-radius:999px;
      font-weight:900;color:#64748b;cursor:pointer;font-size:12px;letter-spacing:.02em;line-height:1;
    }
    .segInline button.active{
      background:#fff;color:#111827;box-shadow:0 10px 18px rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.06);
    }

    .inputWrap{width:100%;max-width:620px;margin:0 auto;text-align:left;}
    .labelRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0 8px;}
    .labelRow .labelText{font-size:16px;font-weight:900;color:#111827;}

    .inputWrap input{
      width:100%;padding:14px 16px;font-size:18px;border-radius:14px;border:1px solid var(--line);
      outline:none;box-shadow: inset 0 1px 0 rgba(15,23,42,.02);
    }
    .inputWrap input:focus{
      border-color:rgba(200,16,46,.35);box-shadow:0 0 0 4px rgba(200,16,46,.08);
    }

    .row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;width:100%;}

    .btn{
      cursor:pointer;border-radius:999px;padding:14px 20px;font-weight:900;letter-spacing:.01em;
      font-size:16px;border:1px solid transparent;transition:.18s ease;min-width:200px;
      display:inline-flex;align-items:center;justify-content:center;text-align:center;user-select:none;line-height:1;
    }
    .btn.wide{min-width:480px; max-width:620px; width:100%;}
    .btn.outline{background:var(--btnOutlineBg);color:var(--btnOutlineText);border-color:var(--btnOutlineBorder);}
    .btn.outline:hover{background:rgba(200,16,46,.06);border-color:rgba(200,16,46,.38);}
    .btn.primary{
      background:linear-gradient(180deg, var(--brand2) 0%, var(--brand) 100%);
      color:var(--btnText);box-shadow:0 14px 26px rgba(200,16,46,.22);
    }
    .btn.primary:hover{transform:translateY(-1px)}
    .btn.primary:active{transform:translateY(0px); opacity:.98}
    .btn.small{min-width:0; width:100%; padding:14px 18px; font-size:16px}

    .msgBox{
      width:100%;max-width:760px;border:1px solid var(--line);border-radius:18px;
      padding:18px;background:#fff;color:#0f172a;font-size:19px;line-height:1.55;
    }
    .msgBox b{font-weight:900}

    .loadingWrap{display:flex;flex-direction:column;align-items:center;gap:14px;padding:14px 0 0;}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:999px;background:#f2f4f8;font-weight:900;color:#0f172a;}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 6px rgba(200,16,46,.10);}
    .muted{color:var(--muted)}

    .foot{text-align:center;padding:14px 18px 10px;border-top:1px solid var(--line);color:var(--muted);font-size:16px;line-height:1.5;}
    .foot a{color:var(--brand);font-weight:900;text-decoration:none;cursor:pointer;}
    .foot a:hover{text-decoration:underline}

    .view{display:none}
    .view.active{display:block}

    .overlay{
      position:fixed;inset:0;background:rgba(15,23,42,.55);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:50;
    }
    .overlay.active{display:flex}
    .modal{
      width:min(760px, 94vw);max-height:min(78vh, 720px);
      background:#fff;border-radius:18px;border:1px solid rgba(15,23,42,.10);
      box-shadow:0 30px 90px rgba(15,23,42,.25);overflow:hidden;
      display:flex;flex-direction:column;
    }
    .modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);}
    .modalHead h3{margin:0;font-size:18px;font-weight:900;color:#0b1222;}
    .x{border:0;background:transparent;font-size:24px;cursor:pointer;color:#0b1222;padding:6px 10px;border-radius:10px;}
    .x:hover{background:#f3f5f9}
    .modalBody{padding:16px;overflow:auto;color:#0f172a;line-height:1.65;}
    .modalBody h4{margin:14px 0 8px;font-size:16px}
    .modalBody ul{margin:8px 0 10px 18px}

    .modalBtns{display:flex;flex-direction:column;gap:10px;margin-top:8px;}
    .modalHint{color:var(--muted);font-size:14px;margin-top:6px;}

    /* ---- CARDS DE DÍVIDA ---- */

    .debtCards{
      width:100%;
      max-width:820px;
      margin:12px auto 4px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .debtCard{
      border-radius:18px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 12px 30px rgba(15,23,42,.06);
      padding:16px 18px 14px;
    }

    .debtHeader{
      display:flex;
      align-items:center;
      gap:14px;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .debtLeft{
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
      min-width:0;
    }

    .debtLogoWrap{
      width:46px;
      height:46px;
      border-radius:999px;
      background:#f9fafb;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid #e5e7eb;
    }

    .debtLogo{
      max-width:34px;
      max-height:26px;
      object-fit:contain;
    }

    .debtCredor{
      font-weight:800;
      font-size:18px;
      color:#0b1222;
      text-transform:uppercase;
      letter-spacing:.02em;
    }

    .debtMeta{
      font-size:14px;
      color:var(--muted);
      margin-top:2px;
    }

    .debtRight{
      text-align:right;
      min-width:180px;
    }

    .debtValue{
      font-size:20px;
      font-weight:800;
      color:#b91c1c;
    }

    .debtContract{
      font-size:14px;
      color:var(--muted);
      margin-top:2px;
    }

    .debtActionsRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .debtHint{
      font-size:14px;
      color:var(--muted);
    }

    .debtDetailsBtn{
      border-radius:999px;
      border:1px dashed rgba(148,163,184,.8);
      background:#f9fafb;
      padding:8px 12px;
      font-size:13px;
      font-weight:600;
      color:#0f172a;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .debtDetailsBtn span.chevron{
      font-size:16px;
      transition:transform .16s ease;
    }
    .debtDetailsBtn.open span.chevron{
      transform:rotate(90deg);
    }

    .debtDetails{
      margin-top:10px;
      border-radius:14px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      display:none;
    }
    .debtDetails.open{
      display:block;
    }

    .debtTable{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    .debtTable thead{
      background:#eef2ff;
    }
    .debtTable th,
    .debtTable td{
      padding:8px 6px;
      text-align:left;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
    }
    .debtTable th{
      font-weight:700;
      color:#4b5563;
    }
    .debtTable td:last-child{
      text-align:right;
    }

    .nextHint{
      margin-top:14px;
      font-size:15px;
      color:var(--muted);
      text-align:center;
      max-width:720px;
      margin-left:auto;
      margin-right:auto;
    }

    @media (max-width:640px){
      .title{font-size:34px}
      .subtitle{font-size:16px}
      .btn{min-width:160px}
      .btn.wide{min-width:0}
      .shellInner{padding:16px}
      .panel{padding:16px}
      .foot{font-size:15px}
      .labelRow{flex-direction:column; align-items:flex-start; gap:8px;}
      .debtHeader{align-items:flex-start;}
      .debtRight{text-align:left;}
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="top">
      <img class="logo" id="logoImg" alt="QuatroC" />
    </div>

    <div class="wrap">
      <div class="shell">
        <div class="shellInner">
          <div class="backRow" id="btnVoltar" style="visibility:hidden;">
            <span>←</span><span>Voltar</span>
          </div>

          <!-- VIEW: START -->
          <div class="view active" id="vStart">
            <div class="panel">
              <h1 class="title">Portal de negociação</h1>
              <p class="subtitle">Informe abaixo o documento:</p>

              <div class="inputWrap" style="margin-top:6px;">
                <div class="labelRow">
                  <div class="labelText">Digite:</div>
                  <div class="segInline" aria-label="Tipo de documento">
                    <button id="segCPF" class="active" type="button">CPF</button>
                    <button id="segCNPJ" type="button">CNPJ</button>
                  </div>
                </div>

                <input id="docInput" inputmode="numeric" autocomplete="off" placeholder="000.000.000-00" />

                <div class="row" style="margin-top:14px;">
                  <button class="btn primary wide" id="btnConsultar" type="button">Confirmar</button>
                </div>
              </div>
            </div>
          </div>

          <!-- VIEW: LOADING -->
          <div class="view" id="vLoading">
            <div class="panel">
              <p class="subtitle" style="margin-top:10px;">
                Estamos localizando as informações vinculadas ao documento informado.
              </p>

              <div class="loadingWrap">
                <div class="muted" style="font-size:20px;font-weight:600;">Aguarde um momento.</div>
                <div class="pill"><span class="dot"></span>Carregando...</div>
              </div>
            </div>
          </div>

          <!-- VIEW: VALIDATION (nome / razão social) -->
          <div class="view" id="vValidate">
            <div class="panel">
              <h1 class="title" id="validateTitle" style="font-size:42px;margin-bottom:6px;">
                Para darmos sequência, confirme os dados
              </h1>
              <p class="subtitle" id="validateSubtitle" style="margin-top:4px;">
                Confirme o nome completo.
              </p>

              <div class="stack" style="margin-top:8px;">
                <div class="msgBox centerText" style="max-width:640px;">
                  Selecione uma das opções abaixo:
                </div>

                <div class="stack" id="nameOptions" style="width:100%;"></div>
              </div>
            </div>
          </div>

          <!-- VIEW: WRONG NAME -->
          <div class="view" id="vWrongName">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">Não foi possível validar</h1>
              <p class="subtitle" id="wrongNameText">
                Para sua segurança, o nome selecionado não corresponde ao cadastro encontrado.
                Reinicie a consulta com o documento correto.
              </p>

              <div class="row" style="margin-top:10px%;">
                <button class="btn primary" id="btnNovaConsulta1" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

          <!-- VIEW: NEXT (cards de dívida + ações) -->
          <div class="view" id="vNext">
            <div class="panel">
              <h1 class="title" style="font-size:46px;">Como deseja prosseguir?</h1>
              <p class="subtitle">
                Revise o resumo da sua dívida e escolha como prefere seguir com a regularização.
              </p>

              <div id="debtCardsContainer" class="debtCards"></div>

              <p class="nextHint">
                Após analisar os detalhes, você pode seguir com a negociação automática ou, se preferir,
                falar diretamente com um atendente.
              </p>

              <div class="row" style="margin-top:14px;">
                <button class="btn outline" id="btnAuto" type="button">
                  Negociar pelo autoatendimento
                </button>
                <button class="btn outline" id="btnHumano" type="button">
                  Falar com um atendente
                </button>
              </div>
            </div>
          </div>

          <!-- VIEW: NEW CONSULTA -->
          <div class="view" id="vNewConsulta">
            <div class="panel">
              <h1 class="title" style="font-size:46px;">Nova consulta</h1>
              <p class="subtitle">Para sua segurança, precisamos reiniciar a consulta com o documento correto.</p>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnNovaConsulta2" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

          <!-- VIEW: ERROR / SEM DÍVIDA / NÃO LOCALIZADO -->
          <div class="view" id="vError">
            <div class="panel">
              <h1 class="title" style="font-size:42px;">Não foi possível concluir</h1>
              <p class="subtitle" id="errorMsg">
                Não foi possível se conectar. Verifique sua conexão e tente novamente.
              </p>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnNovaConsulta3" type="button">Nova consulta</button>
              </div>
            </div>
          </div>

        </div>

        <div class="foot">
          Conosco, seus dados são tratados de forma segura e sigilosa.
          Caso tenha dúvidas ou queira saber mais, acesse nossos
          <a id="openTerms">Termos e Política</a>.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Termos e Política -->
  <div class="overlay" id="termsOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Termos e Política">
      <div class="modalHead">
        <h3>Termos e Política</h3>
        <button class="x" id="closeTerms" aria-label="Fechar">×</button>
      </div>
      <div class="modalBody">
        <h4>Compromisso com segurança e sigilo</h4>
        <p>
          A QuatroC adota medidas técnicas e organizacionais para proteger os dados utilizados neste portal,
          com foco em confidencialidade, integridade e disponibilidade das informações.
        </p>
      </div>
    </div>
  </div>

  <!-- MODAL: Escolher projeto para atendimento humano (quando houver mais de 1) -->
  <div class="overlay" id="humanOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Escolher projeto">
      <div class="modalHead">
        <h3>Falar com um atendente</h3>
        <button class="x" id="closeHuman" aria-label="Fechar">×</button>
      </div>
      <div class="modalBody">
        <div style="font-weight:900;font-size:16px;">Selecione o projeto para continuar:</div>
        <div class="modalBtns" id="humanProjectBtns"></div>
        <div class="modalHint">Você será direcionado para o chat do projeto selecionado.</div>
      </div>
    </div>
  </div>

  <script>
    const LOGO_URL = "https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/Logo.png";

    // URL do Cloudflare Worker que faz ponte com o n8n
    const CRM_ENDPOINT = "https://billowing-voice-6efd.asilvino19.workers.dev/";

    const CHAT_LINK_SASCAR = "https://lh.grupoasserth.com.br:7180/chat/ass-pu-sascar?theme=blue&pickup=y";
    const CHAT_LINK_IRA    = "https://lh.grupoasserth.com.br:7180/chat/ass-pu-ira?theme=blue&pickup=y";
    const CHAT_LINK_DEFAULT= "https://lh.grupoasserth.com.br:7180/chat/ass-pu-amil?theme=blue&pickup=y";

    // Logos por credor (ajuste os URLs conforme for tendo cada arte oficial)
    const LOGO_SASCAR  = "https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/sascar.png";
    const LOGO_IRA     = "https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/ira.png";
    const LOGO_AMIL    = "https://cdn.jsdelivr.net/gh/asilvino19-beep/Logo@main/amil.png";

    const $ = (id) => document.getElementById(id);

    function onlyDigits(str){ return (str||"").replace(/\D/g,""); }
    function isCPF(d){ return d.length === 11; }
    function isCNPJ(d){ return d.length === 14; }

    function norm(str){
      return (str||"").toString().toUpperCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ").trim();
    }

    function normalizeText(str){
      return (str || "")
        .toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toLowerCase();
    }

    function getChatLinkByCredor(credor){
      const c = norm(credor);
      if (c.includes("SASCAR")) return CHAT_LINK_SASCAR;
      if (c.includes("IRA")) return CHAT_LINK_IRA;
      return CHAT_LINK_DEFAULT;
    }

    function getLogoByCredor(credor){
      const c = norm(credor);
      if (c.includes("SASCAR")) return LOGO_SASCAR;
      if (c.includes("IRA")) return LOGO_IRA;
      if (c.includes("AMIL")) return LOGO_AMIL;
      return LOGO_URL; // fallback: logo QuatroC
    }

    function openChatForCredor(credor){
      const url = getChatLinkByCredor(credor);
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // Máscara / limite CPF
    function maskCPF(digits){
      const d = digits.slice(0, 11);
      let out = d;
      if (d.length > 3) out = d.slice(0,3) + "." + d.slice(3);
      if (d.length > 6) out = out.slice(0,7) + "." + out.slice(7);
      if (d.length > 9) out = out.slice(0,11) + "-" + out.slice(11);
      return out;
    }

    // Máscara / limite CNPJ
    function maskCNPJ(digits){
      const d = digits.slice(0, 14);
      let out = d;
      if (d.length > 2) out = d.slice(0,2) + "." + d.slice(2);
      if (d.length > 5) out = out.slice(0,6) + "." + out.slice(6);
      if (d.length > 8) out = out.slice(0,10) + "/" + out.slice(10);
      if (d.length > 12) out = out.slice(0,15) + "-" + out.slice(15);
      return out;
    }

    function applyMask(){
      const input = $("docInput");
      const digits = onlyDigits(input.value);

      if (docType === "CPF"){
        const masked = maskCPF(digits);
        input.value = masked;
        input.maxLength = 14; // 000.000.000-00
      } else {
        const masked = maskCNPJ(digits);
        input.value = masked;
        input.maxLength = 18; // 00.000.000/0000-00
      }
    }

    function detectTypeFromDigits(d){
      if (d.length >= 12) return "CNPJ";
      return "CPF";
    }

    // Views
    function setActiveView(viewId){
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      $(viewId).classList.add("active");
      $("btnVoltar").style.visibility = (viewId === "vStart") ? "hidden" : "visible";
      currentView = viewId;
    }

    // Overlays
    function openOverlay(id){
      const el = $(id);
      el.classList.add("active");
      el.setAttribute("aria-hidden", "false");
    }
    function closeOverlay(id){
      const el = $(id);
      el.classList.remove("active");
      el.setAttribute("aria-hidden", "true");
    }

    let currentView = "vStart";
    let docType = "CPF";
    let currentDoc = "";
    let foundRecord = null;

    // ==== CHAMADA GENÉRICA PARA O BACK (step + payload) ====
    async function callBackend(step, payload) {
      const body = { step, ...payload };

      const res = await fetch(CRM_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        throw new Error("Falha ao consultar CRM");
      }

      const data = await res.json();
      return data;
    }

    // Verifica se o retorno é "cliente não localizado"
    function isNaoLocalizado(data){
      if (!data || !Array.isArray(data.mensagens) || !data.mensagens.length) return false;
      const texto = normalizeText(data.mensagens[0].texto);
      return (
        texto.includes("cliente nao localizado") ||
        texto.includes("nao localizamos contrato vinculado a esse documento") ||
        texto.includes("nao localizamos contrato vinculado a este documento") ||
        texto.includes("nao localizamos contrato vinculado a este cpf") ||
        texto.includes("nao localizamos contrato vinculado a este cnpj")
      );
    }

    function setDocType(type){
      docType = type;
      $("segCPF").classList.toggle("active", type==="CPF");
      $("segCNPJ").classList.toggle("active", type==="CNPJ");
      $("docInput").placeholder = (type==="CPF") ? "000.000.000-00" : "00.000.000/0000-00";
      applyMask();
    }

    function goStart(){
      currentDoc = "";
      foundRecord = null;
      $("docInput").value = "";
      setDocType("CPF");
      setActiveView("vStart");
    }

    // Define textos da tela de validação conforme CPF/CNPJ
    function setValidationTexts(isCnpj){
      const s = $("validateSubtitle");
      if (!s) return;

      if (isCnpj){
        s.textContent = "Confirme a razão social (nome social) completa.";
      } else {
        s.textContent = "Confirme o nome completo.";
      }
    }

    // Gera opções de nome:
    //  - 1ª opção: nome REAL do CRM (todo em maiúsculo)
    //  - 2ª e 3ª: mesmas primeiras palavras, final diferente
    function buildNameOptions(fullName, isCnpj){
      let clean = (fullName || "").toString().trim();
      if (!clean) clean = "CADASTRO LOCALIZADO";

      const upper = clean.toUpperCase().replace(/\s+/g," ").trim();
      const tokens = upper.split(" ").filter(Boolean);

      let baseTokens;
      if (tokens.length >= 2) baseTokens = tokens.slice(0,2);
      else baseTokens = tokens.slice(0,1);

      const base = baseTokens.join(" ");

      const suffixesPF   = [" SANTOS", " SILVA"];
      const suffixesCNPJ = [" COMÉRCIO LTDA", " SERVIÇOS LTDA"];

      const suffixes = isCnpj ? suffixesCNPJ : suffixesPF;

      const optionsSet = new Set();
      optionsSet.add(upper); // nome real

      suffixes.forEach(suf => {
        const alt = (base + suf).trim();
        if (!optionsSet.has(alt)) optionsSet.add(alt);
      });

      return Array.from(optionsSet);
    }

    // -------- Helpers para dívidas / parcelas --------
    function pickParcelDate(p){
      return p?.vencimento || p?.Vencimento || p?.DataVencimento || p?.dataVencimento || "";
    }

    function pickParcelDoc(p){
      return p?.numeroDocumento || p?.NumeroDocumento || p?.Documento || p?.descricao || "";
    }

    function pickParcelValue(p){
      const v =
        p?.valor ??
        p?.Valor ??
        p?.ValorParcela ??
        p?.ValorAtualizado ??
        p?._ValorEmAberto ??
        0;
      return Number(v) || 0;
    }

    function formatCurrencyBR(v){
      return Number(v || 0).toLocaleString("pt-BR", {
        style:"currency",
        currency:"BRL"
      });
    }

    function normalizeDebtList(rec){
      // Estrutura ideal: rec.dividas = [ { credor, numeroContrato, valorAtualizado, parcelas: [] } ]
      if (Array.isArray(rec?.dividas) && rec.dividas.length){
        return rec.dividas.map(d => {
          const parcelas = Array.isArray(d.parcelas) ? d.parcelas : [];
          let total = Number(d.valorAtualizado || 0);
          if (!total && parcelas.length){
            total = parcelas.reduce((acc,p) => acc + pickParcelValue(p), 0);
          }
          return {
            credor: d.credor || d.Credor || "Projeto",
            numeroContrato: d.numeroContrato || d.NumeroContrato || d.contrato || "",
            valorAtualizado: total,
            parcelas
          };
        });
      }

      // Fallback: usar um único card com dados soltos
      const parcelas = Array.isArray(rec?.parcelas) ? rec.parcelas : [];
      let total = Number(rec?.valorAtualizado || rec?.valorTotal || 0);
      if (!total && parcelas.length){
        total = parcelas.reduce((acc,p) => acc + pickParcelValue(p), 0);
      }
      if (!parcelas.length && !total){
        return [];
      }

      return [{
        credor: rec?.credor || rec?.Credor || "Projeto",
        numeroContrato: rec?.numeroContrato || rec?.NumeroContrato || rec?.idContrato || "",
        valorAtualizado: total,
        parcelas
      }];
    }

    function renderDebtCardsFromRecord(rec){
      const container = $("debtCardsContainer");
      if (!container) return;

      container.innerHTML = "";

      const list = normalizeDebtList(rec);
      if (!list.length){
        const msg = document.createElement("div");
        msg.className = "msgBox centerText";
        msg.textContent = "Não foi possível carregar o resumo das dívidas. Tente novamente em instantes.";
        container.appendChild(msg);
        return;
      }

      list.forEach((d, index) => {
        const card = document.createElement("div");
        card.className = "debtCard";

        const header = document.createElement("div");
        header.className = "debtHeader";

        const left = document.createElement("div");
        left.className = "debtLeft";

        const logoWrap = document.createElement("div");
        logoWrap.className = "debtLogoWrap";

        const logo = document.createElement("img");
        logo.className = "debtLogo";
        logo.src = getLogoByCredor(d.credor || "");
        logo.alt = d.credor || "Credor";
        logoWrap.appendChild(logo);

        const titleBox = document.createElement("div");
        const credorEl = document.createElement("div");
        credorEl.className = "debtCredor";
        credorEl.textContent = d.credor || "Projeto";

        const metaEl = document.createElement("div");
        metaEl.className = "debtMeta";
        metaEl.textContent = d.numeroContrato
          ? `Contrato nº ${d.numeroContrato}`
          : "Contrato em aberto";

        titleBox.appendChild(credorEl);
        titleBox.appendChild(metaEl);

        left.appendChild(logoWrap);
        left.appendChild(titleBox);

        const right = document.createElement("div");
        right.className = "debtRight";

        const valEl = document.createElement("div");
        valEl.className = "debtValue";
        valEl.textContent = formatCurrencyBR(d.valorAtualizado || 0);

        const contrEl = document.createElement("div");
        contrEl.className = "debtContract";
        contrEl.textContent = "Valor total atualizado";

        right.appendChild(valEl);
        right.appendChild(contrEl);

        header.appendChild(left);
        header.appendChild(right);

        const actions = document.createElement("div");
        actions.className = "debtActionsRow";

        const hint = document.createElement("div");
        hint.className = "debtHint";
        hint.textContent = "Veja os detalhes antes de escolher como deseja negociar.";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "debtDetailsBtn";
        btn.innerHTML = '<span class="chevron">›</span> Detalhes da dívida';

        const details = document.createElement("div");
        details.className = "debtDetails";

        btn.addEventListener("click", () => {
          const open = details.classList.toggle("open");
          btn.classList.toggle("open", open);
        });

        actions.appendChild(hint);
        actions.appendChild(btn);

        // tabela de parcelas
        const table = document.createElement("table");
        table.className = "debtTable";

        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th>Vencimento</th>
            <th>Documento</th>
            <th>Valor</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        if (Array.isArray(d.parcelas) && d.parcelas.length){
          d.parcelas.forEach(p => {
            const tr = document.createElement("tr");
            const dt = pickParcelDate(p) || "-";
            const doc = pickParcelDoc(p) || "-";
            const val = formatCurrencyBR(pickParcelValue(p));

            tr.innerHTML = `
              <td>${dt}</td>
              <td>${doc}</td>
              <td>${val}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td colspan="3">Não há parcelas detalhadas para exibir.</td>
          `;
          tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        details.appendChild(table);

        card.appendChild(header);
        card.appendChild(actions);
        card.appendChild(details);

        container.appendChild(card);
      });
    }

    // Eventos topo
    $("segCPF").addEventListener("click", () => setDocType("CPF"));
    $("segCNPJ").addEventListener("click", () => setDocType("CNPJ"));

    $("docInput").addEventListener("input", () => {
      const digits = onlyDigits($("docInput").value);
      const inferred = detectTypeFromDigits(digits);
      if (inferred !== docType) setDocType(inferred);
      applyMask();
    });

    $("btnVoltar").addEventListener("click", () => {
      goStart();
    });

    $("btnNovaConsulta1").addEventListener("click", goStart);
    $("btnNovaConsulta2").addEventListener("click", goStart);
    $("btnNovaConsulta3").addEventListener("click", goStart);

    // Termos
    $("openTerms").addEventListener("click", (e) => { e.preventDefault(); openOverlay("termsOverlay"); });
    $("closeTerms").addEventListener("click", () => closeOverlay("termsOverlay"));
    $("termsOverlay").addEventListener("click", (e) => { if (e.target.id === "termsOverlay") closeOverlay("termsOverlay"); });

    // Modal humano
    $("closeHuman").addEventListener("click", () => closeOverlay("humanOverlay"));
    $("humanOverlay").addEventListener("click", (e) => { if (e.target.id === "humanOverlay") closeOverlay("humanOverlay"); });

    // Consultar (step inicial consulta_divida)
    $("btnConsultar").addEventListener("click", async () => {
      const digits = onlyDigits($("docInput").value);
      currentDoc = digits;

      if (!isCPF(digits) && !isCNPJ(digits)){
        $("errorMsg").textContent = "Documento inválido. Verifique e tente novamente.";
        setActiveView("vError");
        return;
      }

      setActiveView("vLoading");

      try {
        const data = await callBackend("consulta_divida", { documento: digits });

        if (!data){
          setActiveView("vNewConsulta");
          return;
        }

        // 1) Documento sem ficha -> tela direta de "não localizamos contrato"
        if (isNaoLocalizado(data)) {
          $("errorMsg").textContent =
            "Não identificamos débitos pendentes vinculados a este documento. Agradecemos o seu contato.";
          setActiveView("vError");
          return;
        }

        const tipoDocRaw = (data.tipoDocumento || (isCNPJ(digits) ? "cnpj" : "cpf")).toLowerCase();
        const isCnpjDoc = tipoDocRaw === "cnpj";

        const fullName =
          data.fullName ||
          data.displayName ||
          data.nome ||
          data.nomeCliente ||
          data.Nome ||
          data.empresa ||
          data.razaoSocial ||
          "CADASTRO LOCALIZADO";

        foundRecord = {
          ...data,
          fullName,
          tipoDocumento: tipoDocRaw,
          isCnpj: isCnpjDoc
        };

        const options = buildNameOptions(fullName, isCnpjDoc);
        setValidationTexts(isCnpjDoc);
        renderNameOptions(options, fullName.toUpperCase());
        setActiveView("vValidate");
      } catch (err) {
        $("errorMsg").textContent = "Não foi possível concluir a consulta no momento. Tente novamente.";
        setActiveView("vError");
      }
    });

    function renderNameOptions(options, correctUpper){
      const correct = (correctUpper || "").toString().toUpperCase().replace(/\s+/g," ").trim();
      const wrap = $("nameOptions");
      wrap.innerHTML = "";

      const container = document.createElement("div");
      container.style.width = "100%";
      container.style.maxWidth = "640px";
      container.style.display = "flex";
      container.style.flexDirection = "column";
      container.style.gap = "12px";

      options.forEach(opt => {
        const label = opt.toUpperCase();
        const b = document.createElement("button");
        b.type = "button";
        b.className = "btn outline";
        b.style.width = "100%";
        b.style.minWidth = "0";
        b.textContent = label;

        b.addEventListener("click", () => {
          const chosen = label.replace(/\s+/g," ").trim();
          const isCorreto = !!correct && chosen === correct;

          if (isCorreto) {
            if (foundRecord && foundRecord.temDivida === false) {
              $("errorMsg").textContent =
                "Não identificamos débitos pendentes vinculados a este documento. Agradecemos o seu contato.";
              setActiveView("vError");
            } else {
              // Tem dívida -> renderiza os cards e segue
              renderDebtCardsFromRecord(foundRecord || {});
              setActiveView("vNext");
            }
          } else if (!correct) {
            renderDebtCardsFromRecord(foundRecord || {});
            setActiveView("vNext");
          } else {
            $("wrongNameText").textContent =
              "Para sua segurança, o nome selecionado não corresponde ao cadastro encontrado. Reinicie a consulta com o documento correto.";
            setActiveView("vWrongName");
          }
        });

        container.appendChild(b);
      });

      wrap.appendChild(container);
    }

    // HUMANO (links por credor via modal)
    $("btnHumano").addEventListener("click", () => {
      if (!foundRecord || !Array.isArray(foundRecord.cases) || foundRecord.cases.length === 0){
        $("errorMsg").textContent = "Não foi possível identificar o projeto para atendimento. Tente novamente.";
        return setActiveView("vError");
      }

      const cases = foundRecord.cases
        .filter(c => c && c.credor)
        .map(c => ({ credor: c.credor }));

      const seen = new Set();
      const unique = [];
      for (const c of cases){
        const k = norm(c.credor);
        if (!seen.has(k)){
          seen.add(k);
          unique.push(c);
        }
      }

      if (unique.length === 1){
        openChatForCredor(unique[0].credor);
        return;
      }

      const btnWrap = $("humanProjectBtns");
      btnWrap.innerHTML = "";

      unique.forEach(c => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn outline";
        btn.style.minWidth = "0";
        btn.textContent = c.credor;
        btn.addEventListener("click", () => {
          closeOverlay("humanOverlay");
          openChatForCredor(c.credor);
        });
        btnWrap.appendChild(btn);
      });

      openOverlay("humanOverlay");
    });

    // Autoatendimento (placeholder – depois você pode trocar para redirecionar)
    $("btnAuto").addEventListener("click", () => {
      $("errorMsg").textContent = "Autoatendimento ainda não está conectado ao CRM. (Aguardando mapeamento do back.)";
      setActiveView("vError");
    });

    // Logo
    (function initLogo(){
      const img = $("logoImg");
      img.src = LOGO_URL;
      img.onerror = () => { img.style.display = "none"; };
    })();

    setDocType("CPF");
  </script>
</body>
</html>
